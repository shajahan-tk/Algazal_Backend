{"version":3,"file":"sendMailPdfController.js","sourceRoot":"","sources":["../../src/controllers/sendMailPdfController.ts"],"names":[],"mappings":"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","sourcesContent":["// Add this to your quotationController.ts file\r\n\r\nimport { IClient } from \"../models/clientModel\";\r\nimport { IProject, Project } from \"../models/projectModel\";\r\nimport { Quotation } from \"../models/quotationModel\";\r\nimport { IUser } from \"../models/userModel\";\r\nimport { ApiError, ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { mailer } from \"../utils/mailer\";\r\nimport { Request, Response } from \"express\";\r\nimport puppeteer from \"puppeteer\";\r\n\r\nexport const sendQuotationEmail = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    const quotation = await Quotation.findById(id)\r\n      .populate<{ project: IProject & { client: IClient } }>({\r\n        path: \"project\",\r\n        select: \"projectName client siteAddress location building apartmentNumber\",\r\n        populate: {\r\n          path: \"client\",\r\n          select: \"clientName clientAddress mobileNumber telephoneNumber email\",\r\n        },\r\n      })\r\n      .populate<{ preparedBy: IUser }>(\r\n        \"preparedBy\",\r\n        \"firstName lastName phoneNumbers\"\r\n      );\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    if (!quotation.project || typeof quotation.project !== \"object\" || !(\"client\" in quotation.project)) {\r\n      throw new ApiError(400, \"Client information not found\");\r\n    }\r\n\r\n    const client = quotation.project.client as IClient;\r\n    const preparedBy = quotation.preparedBy as IUser;\r\n    const project = quotation.project;\r\n\r\n    // Check if client has email\r\n    if (!client.email) {\r\n      throw new ApiError(400, \"Client email not found\");\r\n    }\r\n\r\n    // Generate PDF first\r\n    const pdfBuffer = await generateQuotationPdfBuffer(quotation, client, preparedBy, project);\r\n\r\n    // Create email HTML content using the template\r\n    const emailHtmlContent = createQuotationEmailTemplate(\r\n      quotation.quotationNumber,\r\n      client.clientName,\r\n      `${preparedBy.firstName} ${preparedBy.lastName}`\r\n    );\r\n\r\n    try {\r\n      // Send email with PDF attachment\r\n      await mailer.sendEmail({\r\n        to: client.email,\r\n        subject: `Quotation ${quotation.quotationNumber} - ${project.projectName}`,\r\n        html: emailHtmlContent,\r\n        attachments: [\r\n          {\r\n            filename: `Quotation-${quotation.quotationNumber}.pdf`,\r\n            content: pdfBuffer as any,\r\n            contentType: 'application/pdf'\r\n          }\r\n        ]\r\n      });\r\n\r\n      // Update project status to quotation_sent if not already\r\n     \r\n      res.status(200).json(\r\n        new ApiResponse(200, null, \"Quotation email sent successfully\")\r\n      );\r\n    } catch (error) {\r\n      console.error(\"Error sending quotation email:\", error);\r\n      throw new ApiError(500, \"Failed to send quotation email\");\r\n    }\r\n  }\r\n);\r\n\r\n// Helper function to generate PDF buffer (extracted from existing PDF generation code)\r\nconst generateQuotationPdfBuffer = async (\r\n  quotation: any,\r\n  client: IClient,\r\n  preparedBy: IUser,\r\n  project: IProject\r\n) => {\r\n  const site = `${project.location} ${project.building} ${project.apartmentNumber}`;\r\n  \r\n  // Calculate totals\r\n  const subtotal = quotation.items.reduce((sum: number, item: any) => sum + item.totalPrice, 0);\r\n  const vatAmount = subtotal * (quotation.vatPercentage / 100);\r\n  const netAmount = subtotal + vatAmount;\r\n\r\n  const formatDate = (date: Date) => {\r\n    return date ? new Date(date).toLocaleDateString(\"en-GB\", {\r\n      day: \"2-digit\",\r\n      month: \"short\",\r\n      year: \"numeric\",\r\n    }) : \"\";\r\n  };\r\n\r\n  const getDaysRemaining = (validUntil: Date) => {\r\n    if (!validUntil) return \"N/A\";\r\n    const today = new Date();\r\n    const validDate = new Date(validUntil);\r\n    const timeDiff = validDate.getTime() - today.getTime();\r\n    const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));\r\n    return daysRemaining > 0 ? `${daysRemaining} days` : \"Expired\";\r\n  };\r\n\r\n  // Use the same HTML content from your existing PDF generation\r\n  let htmlContent = `<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\r\n  <style type=\"text/css\">\r\n   @page {\r\n  size: A4;\r\n  margin: 1cm;\r\n}\r\nbody {\r\n  font-family: 'Arial', sans-serif;\r\n  font-size: 10pt;\r\n  line-height: 1.4;\r\n  color: #333;\r\n  margin: 0;\r\n  padding: 0;\r\n}\r\n\r\n.container {\r\n  display: block;\r\n}\r\n\r\n.content {\r\n  margin-bottom: 20px;\r\n}\r\n\r\n.header {\r\n  display: flex;\r\n  align-items: flex-start;\r\n  margin-bottom: 15px;\r\n  gap: 15px;\r\n}\r\n\r\n.logo {\r\n  height: 50px;\r\n  width: auto;\r\n}\r\n\r\n.header-content {\r\n  flex-grow: 1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  justify-content: center;\r\n  align-items: flex-end;\r\n}\r\n\r\n.document-title {\r\n  font-size: 14pt;\r\n  font-weight: bold;\r\n  margin: 0;\r\n  color: #000;\r\n  padding-top: 8px;\r\n}\r\n\r\n.client-info-container {\r\n  display: flex;\r\n  margin-bottom: 10px;\r\n  gap: 20px;\r\n}\r\n\r\n.client-info {\r\n  flex: 1;\r\n  padding: 10px;\r\n  border: 1px solid #eee;\r\n  border-radius: 4px;\r\n}\r\n\r\n.quotation-info {\r\n  width: 250px;\r\n}\r\n\r\n.quotation-details {\r\n  width: 100%;\r\n  border-collapse: collapse;\r\n}\r\n\r\n.quotation-details tr:not(:last-child) {\r\n  border-bottom: 1px solid #eee;\r\n}\r\n\r\n.quotation-details td {\r\n  padding: 8px 10px;\r\n  vertical-align: top;\r\n}\r\n\r\n.quotation-details td:first-child {\r\n  font-weight: bold;\r\n  width: 40%;\r\n  color: #555;\r\n}\r\n\r\n.section {\r\n  margin-bottom: 15px;\r\n  page-break-inside: avoid;\r\n}\r\n\r\n.section-title {\r\n  font-size: 11pt;\r\n  font-weight: bold;\r\n  padding: 5px 0;\r\n  margin: 10px 0 5px 0;\r\n  border-bottom: 1px solid #ddd;\r\n}\r\n\r\n.terms-prepared-section {\r\n  margin-top: 15px;\r\n  page-break-inside: avoid;\r\n}\r\n\r\n.terms-prepared-header {\r\n  display: flex;\r\n  justify-content: space-between;\r\n  align-items: center;\r\n  padding-bottom: 5px;\r\n  border-bottom: 1px solid #ddd;\r\n  margin-bottom: 10px;\r\n}\r\n\r\n.terms-title, .prepared-title {\r\n  font-size: 11pt;\r\n  font-weight: bold;\r\n  margin: 0;\r\n  color: #333;\r\n}\r\n\r\n.terms-prepared-content {\r\n  display: flex;\r\n  gap: 20px;\r\n  align-items: flex-start;\r\n}\r\n\r\n.terms-content {\r\n  flex: 1;\r\n}\r\n\r\n.prepared-content {\r\n  width: 250px;\r\n  flex-shrink: 0;\r\n  display: flex;\r\n  flex-direction: column;\r\n  align-items: flex-end;\r\n}\r\n\r\ntable {\r\n  width: 100%;\r\n  border-collapse: collapse;\r\n  margin-bottom: 15px;\r\n  page-break-inside: avoid;\r\n}\r\n\r\nth {\r\n  background-color: #94d7f4;\r\n  color: #000;\r\n  font-weight: bold;\r\n  padding: 6px 8px;\r\n  text-align: left;\r\n  border: 1px solid #ddd;\r\n}\r\n\r\ntd {\r\n  padding: 6px 8px;\r\n  border: 1px solid #ddd;\r\n  vertical-align: top;\r\n}\r\n\r\n.amount-summary {\r\n  margin-top: 10px;\r\n  width: 100%;\r\n  text-align: right;\r\n}\r\n\r\n.amount-summary-row {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  margin-bottom: 5px;\r\n}\r\n\r\n.amount-label {\r\n  width: 150px;\r\n  font-weight: bold;\r\n  text-align: right;\r\n  padding-right: 10px;\r\n}\r\n\r\n.amount-value {\r\n  width: 100px;\r\n  text-align: right;\r\n}\r\n\r\n.net-amount-row {\r\n  display: flex;\r\n  justify-content: flex-end;\r\n  background-color: #94d7f4;\r\n  color: #000;\r\n  font-weight: bold;\r\n  font-size: 11pt;\r\n  margin-top: 5px;\r\n  padding: 5px 0;\r\n  border-top: 1px solid #333;\r\n}\r\n\r\n.terms-box {\r\n  border: 1px solid #000;\r\n  padding: 10px;\r\n  width: 100%;\r\n  box-sizing: border-box;\r\n}\r\n\r\n.prepared-by-name {\r\n  font-weight: bold;\r\n  margin-top: 5px;\r\n}\r\n\r\n.prepared-by-title {\r\n  font-size: 9pt;\r\n  color: #777;\r\n  margin-top: 5px;\r\n}\r\n\r\n.tagline {\r\n  text-align: center;\r\n  font-weight: bold;\r\n  font-size: 12pt;\r\n  margin: 20px 0 10px 0;\r\n  color: #333;\r\n  border-top: 2px solid #ddd;\r\n  padding-top: 15px;\r\n  page-break-before: avoid;\r\n}\r\n\r\n.footer {\r\n  font-size: 9pt;\r\n  color: #777;\r\n  text-align: center;\r\n  margin-top: 10px;\r\n  page-break-inside: avoid;\r\n  page-break-before: avoid;\r\n}\r\n\r\n.text-center {\r\n  text-align: center;\r\n}\r\n\r\n.text-right {\r\n  text-align: right;\r\n}\r\n\r\np {\r\n  margin: 5px 0;\r\n}\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <div class=\"content\">\r\n      <div class=\"header\">\r\n        <img class=\"logo\" src=\"https://krishnadas-test-1.s3.ap-south-1.amazonaws.com/sample-spmc/logo+(1).png\" alt=\"Company Logo\">\r\n        <div class=\"header-content\">\r\n          <div class=\"document-title\">QUOTE</div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"client-info-container\">\r\n        <div class=\"client-info\">\r\n          <p><strong>CLIENT:</strong> ${client.clientName || \"N/A\"}</p>\r\n          <p><strong>ADRESS:</strong> ${client.clientAddress || \"N/A\"}</p>\r\n          <p><strong>CONTACT:</strong> ${client.mobileNumber || client.telephoneNumber || \"N/A\"}</p>\r\n          <p><strong>EMAIL:</strong> ${client.email || \"N/A\"}</p>\r\n          <p><strong>SITE:</strong> ${site}</p>\r\n          <p><strong>SUBJECT:</strong> ${project.projectName || \"N/A\"}</p>\r\n        </div>\r\n\r\n        <div class=\"quotation-info\">\r\n          <table class=\"quotation-details\">\r\n            <tr>\r\n              <td>Quotation #:</td>\r\n              <td>${quotation.quotationNumber}</td>\r\n            </tr>\r\n            <tr>\r\n              <td>Date:</td>\r\n              <td>${formatDate(quotation.date)}</td>\r\n            </tr>\r\n            <tr>\r\n              <td>Valid Until:</td>\r\n              <td>${getDaysRemaining(quotation.validUntil)}</td>\r\n            </tr>\r\n          </table>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">ITEMS</div>\r\n        <table>\r\n          <thead>\r\n            <tr>\r\n              <th width=\"5%\">No.</th>\r\n              <th width=\"35%\">Description</th>\r\n              <th width=\"10%\">UOM</th>\r\n              <th width=\"15%\">Image</th>\r\n              <th width=\"10%\">Qty</th>\r\n              <th width=\"15%\">Unit Price (AED)</th>\r\n              <th width=\"10%\" class=\"text-right\">Total (AED)</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            ${quotation.items.map((item: any, index: number) => `\r\n              <tr>\r\n                <td class=\"text-center\">${index + 1}</td>\r\n                <td>${item.description}</td>\r\n                <td class=\"text-center\">${item.uom || \"NOS\"}</td>\r\n                <td class=\"text-center\" style=\"padding: 5px;\">\r\n                  ${item.image?.url ? `<img src=\"${item.image.url}\" style=\"width: 100%; height: auto; max-height: 80px; object-fit: contain;\"/>` : \"\"}\r\n                </td>\r\n                <td class=\"text-center\">${item.quantity.toFixed(2)}</td>\r\n                <td class=\"text-right\">${item.unitPrice.toFixed(2)}</td>\r\n                <td class=\"text-right\">${item.totalPrice.toFixed(2)}</td>\r\n              </tr>\r\n            `).join(\"\")}\r\n          </tbody>\r\n        </table>\r\n\r\n        <div class=\"amount-summary\">\r\n          <div class=\"amount-summary-row\">\r\n            <div class=\"amount-label\">SUBTOTAL:</div>\r\n            <div class=\"amount-value\">${subtotal.toFixed(2)} AED</div>\r\n          </div>\r\n          <div class=\"amount-summary-row\">\r\n            <div class=\"amount-label\">VAT ${quotation.vatPercentage}%:</div>\r\n            <div class=\"amount-value\">${vatAmount.toFixed(2)} AED</div>\r\n          </div>\r\n          <div class=\"net-amount-row\">\r\n            <div class=\"amount-label\">NET AMOUNT:</div>\r\n            <div class=\"amount-value\">${netAmount.toFixed(2)} AED</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      ${quotation.termsAndConditions.length > 0 ? `\r\n      <div class=\"terms-prepared-section\">\r\n        <div class=\"terms-prepared-header\">\r\n          <div class=\"terms-title\">TERMS & CONDITIONS</div>\r\n          <div class=\"prepared-title\">PREPARED BY</div>\r\n        </div>\r\n        <div class=\"terms-prepared-content\">\r\n          <div class=\"terms-content\">\r\n            <div class=\"terms-box\">\r\n              <ol>\r\n                ${quotation.termsAndConditions.map((term: string) => `<li>${term}</li>`).join(\"\")}\r\n              </ol>\r\n            </div>\r\n          </div>\r\n          <div class=\"prepared-content\">\r\n            <div class=\"prepared-by-name\">${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}</div>\r\n            ${preparedBy?.phoneNumbers?.length ? `\r\n            <div class=\"prepared-by-title\">Phone: ${preparedBy.phoneNumbers.join(\", \")}</div>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n      </div>\r\n      ` : `\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">PREPARED BY</div>\r\n        <div class=\"prepared-by-name\" >${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}</div>\r\n        ${preparedBy?.phoneNumbers?.length ? `\r\n        <div class=\"prepared-by-title\">Phone: ${preparedBy.phoneNumbers.join(\", \")}</div>\r\n        ` : ''}\r\n      </div>\r\n      `}\r\n    </div>\r\n\r\n    <div class=\"tagline\">We work U Relax</div>\r\n    <div class=\"footer\">\r\n      <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n      <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n      <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n      <p>Generated on ${formatDate(new Date())}</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n`;\r\n\r\n  const browser = await puppeteer.launch({\r\n    headless: \"shell\",\r\n    args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"],\r\n  });\r\n\r\n  try {\r\n    const page = await browser.newPage();\r\n    await page.setContent(htmlContent, {\r\n      waitUntil: [\"load\", \"networkidle0\", \"domcontentloaded\"],\r\n      timeout: 30000,\r\n    });\r\n\r\n    const pdfBuffer = await page.pdf({\r\n      format: \"A4\",\r\n      printBackground: true,\r\n      margin: {\r\n        top: \"1cm\",\r\n        right: \"1cm\",\r\n        bottom: \"1cm\",\r\n        left: \"1cm\",\r\n      },\r\n    });\r\n\r\n    return pdfBuffer;\r\n  } finally {\r\n    await browser.close();\r\n  }\r\n};\r\n\r\n// Helper function to create email HTML template\r\nconst createQuotationEmailTemplate = (\r\n  quotationNumber: string,\r\n  clientName: string,\r\n  senderName: string\r\n): string => {\r\n  return `<!DOCTYPE html>\r\n<html lang=\"en\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>Quote Template</title>\r\n    <style>\r\n        body {\r\n            font-family: Arial, sans-serif;\r\n            margin: 0;\r\n            padding: 20px;\r\n            background-color: #f0f0f0;\r\n        }\r\n        \r\n        .quote-container {\r\n            max-width: 800px;\r\n            margin: 0 auto;\r\n            background-color: white;\r\n            border-radius: 8px;\r\n            overflow: hidden;\r\n            box-shadow: 0 2px 10px rgba(0,0,0,0.1);\r\n        }\r\n        \r\n        .quote-header {\r\n            background: linear-gradient(135deg, #4a90e2, #357abd);\r\n            color: white;\r\n            text-align: center;\r\n            padding: 15px;\r\n            font-size: 18px;\r\n            font-weight: bold;\r\n        }\r\n        \r\n        .quote-body {\r\n            padding: 30px;\r\n            line-height: 1.6;\r\n            color: #333;\r\n        }\r\n        \r\n        .greeting {\r\n            margin-bottom: 20px;\r\n        }\r\n        \r\n        .client-name {\r\n            background-color: #ffeb3b;\r\n            padding: 2px 4px;\r\n            font-weight: bold;\r\n        }\r\n        \r\n        .content-line {\r\n            margin-bottom: 15px;\r\n        }\r\n        \r\n        .signature {\r\n            margin-top: 30px;\r\n        }\r\n        \r\n        .sender-name {\r\n            background-color: #ffeb3b;\r\n            padding: 2px 4px;\r\n            font-weight: bold;\r\n        }\r\n        \r\n        .company-name {\r\n            margin-top: 5px;\r\n        }\r\n    </style>\r\n</head>\r\n<body>\r\n    <div class=\"quote-container\">\r\n        <div class=\"quote-header\">\r\n            Quote #${quotationNumber}\r\n        </div>\r\n        \r\n        <div class=\"quote-body\">\r\n            <div class=\"greeting\">\r\n                Dear <span class=\"client-name\">${clientName}</span>\r\n            </div>\r\n            \r\n            <div class=\"content-line\">\r\n                Please Find the Attached Proposal for your reference.\r\n            </div>\r\n            \r\n            <div class=\"content-line\">\r\n                We are waiting for your positive response.\r\n            </div>\r\n            \r\n            <div class=\"signature\">\r\n                <div>Regards,</div>\r\n                <div><span class=\"sender-name\">${senderName}</span></div>\r\n                <div class=\"company-name\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</body>\r\n</html>`;\r\n};"]}