{"version":3,"file":"sendMailPdfController.js","sourceRoot":"","sources":["../../src/controllers/sendMailPdfController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Client, IClient } from \"../models/clientModel\";\r\nimport { IProject, Project } from \"../models/projectModel\";\r\nimport { Quotation } from \"../models/quotationModel\";\r\nimport { IUser } from \"../models/userModel\";\r\nimport { ApiError, ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { mailer } from \"../utils/mailer\";\r\nimport { Request, Response } from \"express\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { WorkCompletion } from \"../models/workCompletionModel\";\r\nimport { LPO } from \"../models/lpoModel\";\r\n\r\n\r\nexport const sendQuotationEmail = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const { cc } = req.body;\r\n\r\n    const quotation = await Quotation.findById(id)\r\n      .populate<{ project: IProject & { client: IClient } }>({\r\n        path: \"project\",\r\n        select: \"projectName client siteAddress location building apartmentNumber attention\",\r\n        populate: {\r\n          path: \"client\",\r\n          select: \"clientName clientAddress mobileNumber telephoneNumber email\",\r\n        },\r\n      })\r\n      .populate<{ preparedBy: IUser }>(\r\n        \"preparedBy\",\r\n        \"firstName lastName phoneNumbers\"\r\n      );\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    if (!quotation.project || typeof quotation.project !== \"object\" || !(\"client\" in quotation.project)) {\r\n      throw new ApiError(400, \"Client information not found\");\r\n    }\r\n\r\n    const client = quotation.project.client as IClient;\r\n    const preparedBy = quotation.preparedBy as IUser;\r\n    const project = quotation.project;\r\n\r\n    if (!client.email) {\r\n      throw new ApiError(400, \"Client email not found\");\r\n    }\r\n\r\n    if (cc && Array.isArray(cc) && cc.length > 0) {\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      const invalidEmails = cc.filter((email: string) => !emailRegex.test(email));\r\n      \r\n      if (invalidEmails.length > 0) {\r\n        throw new ApiError(400, `Invalid CC email addresses: ${invalidEmails.join(', ')}`);\r\n      }\r\n    }\r\n\r\n    // Generate PDF using the new template\r\n    const pdfBuffer = await generateQuotationPdfBuffer(quotation, client, preparedBy, project);\r\n\r\n    const emailHtmlContent = createQuotationEmailTemplate(\r\n      quotation,\r\n      client,\r\n      preparedBy,\r\n      project\r\n    );\r\n\r\n    try {\r\n      await mailer.sendEmail({\r\n        to: client.email,\r\n        cc: cc && cc.length > 0 ? cc : undefined,\r\n        subject: `Quotation ${quotation.quotationNumber} - ${project.projectName}`,\r\n        html: emailHtmlContent,\r\n        attachments: [\r\n          {\r\n            filename: `Quotation-${quotation.quotationNumber}.pdf`,\r\n            content: pdfBuffer as any,\r\n            contentType: 'application/pdf'\r\n          }\r\n        ]\r\n      });\r\n\r\n      const ccMessage = cc && cc.length > 0 ? ` with CC to ${cc.length} recipient(s)` : '';\r\n      res.status(200).json(\r\n        new ApiResponse(200, null, `Quotation email sent successfully${ccMessage}`)\r\n      );\r\n    } catch (error) {\r\n      console.error(\"Error sending quotation email:\", error);\r\n      throw new ApiError(500, \"Failed to send quotation email\");\r\n    }\r\n  }\r\n);\r\n\r\n// Helper function to generate PDF buffer using the new template\r\nconst generateQuotationPdfBuffer = async (\r\n  quotation: any,\r\n  client: IClient,\r\n  preparedBy: IUser,\r\n  project: IProject\r\n) => {\r\n  const site = `${project.location} ${project.building} ${project.apartmentNumber}`;\r\n  \r\n  const subtotal = quotation.items.reduce((sum: number, item: any) => sum + item.totalPrice, 0);\r\n  const vatAmount = subtotal * (quotation.vatPercentage / 100);\r\n  const netAmount = subtotal + vatAmount;\r\n\r\n  const formatDate = (date: Date) => {\r\n    return date ? new Date(date).toLocaleDateString(\"en-GB\", {\r\n      day: \"2-digit\",\r\n      month: \"short\",\r\n      year: \"numeric\",\r\n    }) : \"\";\r\n  };\r\n  \r\n  const getDaysRemaining = (validUntil: Date) => {\r\n    if (!validUntil) return \"N/A\";\r\n    const today = new Date();\r\n    const validDate = new Date(validUntil);\r\n    const timeDiff = validDate.getTime() - today.getTime();\r\n    const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));\r\n    return daysRemaining > 0 ? `${daysRemaining} days` : \"Expired\";\r\n  };\r\n\r\n  const cleanDescription = (description: string) => {\r\n    return description.replace(/\\n\\n+/g, '\\n').trim();\r\n  };\r\n\r\n  // Function to format currency with proper spacing\r\n  const formatCurrency = (amount: number) => {\r\n    return amount.toFixed(2).replace(/\\d(?=(\\d{3})+\\.)/g, '$&,');\r\n  };\r\n\r\n  let htmlContent = `<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\r\n  <style type=\"text/css\">\r\n    @page {\r\n      size: A4;\r\n      margin: 0.3cm;\r\n    }\r\n    \r\n    body {\r\n      font-family: 'Arial', sans-serif;\r\n      font-size: 10pt;\r\n      line-height: 1.3;\r\n      color: #333;\r\n      margin: 0;\r\n      padding: 0;\r\n    }\r\n\r\n    .container {\r\n      display: block;\r\n      width: 100%;\r\n      max-width: 100%;\r\n    }\r\n\r\n    .content {\r\n      margin-bottom: 10px;\r\n    }\r\n\r\n    .header {\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      margin-bottom: 10px;\r\n      gap: 15px;\r\n      page-break-after: avoid;\r\n      padding: 8px 0;\r\n      border-bottom: 2px solid #94d7f4;\r\n      position: relative;\r\n    }\r\n\r\n    .logo {\r\n      height: 40px;\r\n      width: auto;\r\n      max-width: 120px;\r\n      object-fit: contain;\r\n      position: absolute;\r\n      left: 0;\r\n    }\r\n\r\n    .company-names {\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      justify-content: center;\r\n      text-align: center;\r\n      flex-grow: 1;\r\n    }\r\n\r\n    .company-name-arabic {\r\n      font-size: 16pt;\r\n      font-weight: bold;\r\n      color: #1a1a1a;\r\n      line-height: 1.2;\r\n      direction: rtl;\r\n      unicode-bidi: bidi-override;\r\n      letter-spacing: 0;\r\n      margin-bottom: 3px;\r\n    }\r\n\r\n    .company-name-english {\r\n      font-size: 9pt;\r\n      font-weight: bold;\r\n      color: #1a1a1a;\r\n      line-height: 1.2;\r\n      letter-spacing: 0.06em;\r\n      text-transform: uppercase;\r\n    }\r\n\r\n    .client-info-container {\r\n      display: flex;\r\n      margin-bottom: 6px;\r\n      gap: 12px;\r\n      page-break-after: avoid;\r\n    }\r\n\r\n    .client-info {\r\n      flex: 1;\r\n      padding: 6px 8px;\r\n      border: 1px solid #ddd;\r\n      border-radius: 3px;\r\n      font-size: 9pt;\r\n      background-color: #f8f9fa;\r\n    }\r\n\r\n    .client-info p {\r\n      margin: 3px 0;\r\n      line-height: 1.2;\r\n    }\r\n\r\n    .client-info strong {\r\n      font-weight: 600;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .quotation-info {\r\n      width: 200px;\r\n    }\r\n\r\n    .quotation-details {\r\n      width: 100%;\r\n      border-collapse: collapse;\r\n      font-size: 9pt;\r\n    }\r\n\r\n    .quotation-details tr:not(:last-child) {\r\n      border-bottom: 1px solid #eee;\r\n    }\r\n\r\n    .quotation-details td {\r\n      padding: 4px 6px;\r\n      vertical-align: top;\r\n    }\r\n\r\n    .quotation-details td:first-child {\r\n      font-weight: bold;\r\n      width: 40%;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .subject-section {\r\n      margin: 6px 0;\r\n      padding: 6px 12px;\r\n      background-color: #f8f9fa;\r\n      border-radius: 3px;\r\n      page-break-after: avoid;\r\n      page-break-inside: avoid;\r\n      border-left: 4px solid #94d7f4;\r\n      border-right: 4px solid #94d7f4;\r\n      background: linear-gradient(to right, #f0f8ff 0%, #f8f9fa 50%, #f0f8ff 100%);\r\n    }\r\n\r\n    .subject-title {\r\n      font-weight: bold;\r\n      font-size: 9.5pt;\r\n      margin-bottom: 3px;\r\n      color: #2c5aa0;\r\n      text-transform: uppercase;\r\n      letter-spacing: 0.5px;\r\n    }\r\n\r\n    .subject-content {\r\n      font-size: 9pt;\r\n      color: #333;\r\n      font-weight: 500;\r\n      padding-left: 4px;\r\n    }\r\n\r\n    .section {\r\n      margin-bottom: 8px;\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    .section-title {\r\n      font-size: 10pt;\r\n      font-weight: bold;\r\n      padding: 3px 0;\r\n      margin: 6px 0 4px 0;\r\n      border-bottom: 1px solid #94d7f4;\r\n      page-break-after: avoid;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .table-container {\r\n      page-break-inside: avoid;\r\n      overflow: visible;\r\n    }\r\n\r\n    table {\r\n      width: 100%;\r\n      border-collapse: collapse;\r\n      margin-bottom: 8px;\r\n      page-break-inside: avoid;\r\n      font-size: 9pt;\r\n      table-layout: fixed;\r\n    }\r\n\r\n    thead {\r\n      display: table-header-group;\r\n    }\r\n\r\n    tbody {\r\n      display: table-row-group;\r\n    }\r\n\r\n    tr {\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    th, td {\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    th {\r\n      background-color: #94d7f4;\r\n      color: #000;\r\n      font-weight: bold;\r\n      padding: 4px 5px;\r\n      text-align: center;\r\n      border: 1px solid #ddd;\r\n      font-size: 9pt;\r\n      vertical-align: middle;\r\n    }\r\n\r\n    td {\r\n      padding: 4px 5px;\r\n      border: 1px solid #ddd;\r\n      vertical-align: top;\r\n      font-size: 9pt;\r\n    }\r\n\r\n    .col-desc {\r\n      white-space: pre-wrap;\r\n      line-height: 1.2;\r\n    }\r\n\r\n    .col-no { width: 5%; }\r\n    .col-desc { width: 45%; }\r\n    .col-uom { width: 10%; }\r\n    .col-qty { width: 10%; }\r\n    .col-unit { width: 15%; }\r\n    .col-total { width: 15%; }\r\n\r\n    .amount-summary {\r\n      margin-top: 6px;\r\n      width: 100%;\r\n      text-align: right;\r\n      page-break-inside: avoid;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    .amount-summary-row {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      margin-bottom: 3px;\r\n      align-items: center;\r\n    }\r\n\r\n    .amount-label {\r\n      font-weight: bold;\r\n      text-align: left;\r\n      font-size: 9pt;\r\n      min-width: 120px;\r\n    }\r\n\r\n    .amount-value {\r\n      text-align: right;\r\n      font-size: 9pt;\r\n      font-weight: normal;\r\n      font-family: 'Arial', sans-serif;\r\n      min-width: 150px;\r\n      white-space: nowrap;\r\n    }\r\n\r\n    .net-amount-row {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      background-color: #94d7f4;\r\n      color: #000;\r\n      font-weight: bold;\r\n      font-size: 9.5pt;\r\n      margin-top: 3px;\r\n      padding: 4px 8px;\r\n      border-top: 1px solid #333;\r\n      border-radius: 3px;\r\n    }\r\n\r\n    .net-amount-row .amount-value {\r\n      font-weight: bold;\r\n      font-family: 'Arial', sans-serif;\r\n    }\r\n\r\n    /* ==================== IMAGE SECTION (FIXED - NO BREAK PROBLEMS) ==================== */\r\n\r\n    .images-section {\r\n      margin-top: 8px;\r\n      /* REMOVED: page-break-inside: avoid - Let it break naturally */\r\n    }\r\n\r\n    .images-grid {\r\n      display: block;\r\n      margin-top: 4px;\r\n      /* REMOVED: page-break-inside rules - Let it flow naturally */\r\n    }\r\n\r\n    .images-row {\r\n      display: flex;\r\n      gap: 8px;\r\n      margin-bottom: 8px;\r\n      /* REMOVED ALL page-break rules - Let rows break naturally between pages */\r\n      min-height: 140px; /* Ensure minimum height for better breaking */\r\n    }\r\n\r\n    .image-item {\r\n      flex: 1;\r\n      min-width: calc(33.333% - 6px);\r\n      max-width: calc(33.333% - 6px);\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      /* REMOVED: page-break-inside: avoid - Let items break naturally */\r\n      border: 1px solid #ddd;\r\n      border-radius: 4px;\r\n      padding: 6px;\r\n      background: #fafafa;\r\n      min-height: 140px;\r\n      box-sizing: border-box;\r\n      /* Allow breaking inside image items if needed */\r\n      page-break-inside: auto;\r\n    }\r\n\r\n    .image-container {\r\n      width: 100%;\r\n      height: 100px;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      overflow: hidden;\r\n      margin-bottom: 4px;\r\n      background: #fff;\r\n      border-radius: 3px;\r\n      /* Prevent images from breaking */\r\n      page-break-inside: avoid;\r\n      break-inside: avoid;\r\n    }\r\n\r\n    .image-container img {\r\n      max-height: 100%;\r\n      max-width: 100%;\r\n      object-fit: contain;\r\n      /* Ensure images don't break */\r\n      page-break-inside: avoid;\r\n      break-inside: avoid;\r\n    }\r\n\r\n    .image-title {\r\n      font-size: 8pt;\r\n      font-weight: 600;\r\n      text-align: center;\r\n      color: #2c3e50;\r\n      line-height: 1.1;\r\n      margin: 0;\r\n      word-break: break-word;\r\n      max-height: 28px;\r\n      overflow: hidden;\r\n      display: -webkit-box;\r\n      -webkit-line-clamp: 2;\r\n      -webkit-box-orient: vertical;\r\n      /* Allow title to break with the image */\r\n      page-break-inside: auto;\r\n    }\r\n\r\n    .terms-prepared-section {\r\n      margin-top: 8px;\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    .terms-prepared-header {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding-bottom: 3px;\r\n      border-bottom: 1px solid #94d7f4;\r\n      margin-bottom: 6px;\r\n      page-break-after: avoid;\r\n    }\r\n\r\n    .terms-title, .prepared-title {\r\n      font-size: 9.5pt;\r\n      font-weight: bold;\r\n      margin: 0;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .terms-prepared-content {\r\n      display: flex;\r\n      gap: 12px;\r\n      align-items: flex-start;\r\n    }\r\n\r\n    .terms-content {\r\n      flex: 1;\r\n    }\r\n\r\n    .prepared-content {\r\n      width: 180px;\r\n      flex-shrink: 0;\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: flex-end;\r\n      font-size: 9pt;\r\n    }\r\n\r\n    .terms-box {\r\n      border: 1px solid #000;\r\n      padding: 6px 8px;\r\n      width: 100%;\r\n      box-sizing: border-box;\r\n      font-size: 9pt;\r\n      line-height: 1.3;\r\n    }\r\n\r\n    .terms-box ol {\r\n      margin: 0;\r\n      padding-left: 12px;\r\n    }\r\n\r\n    .terms-box li {\r\n      margin-bottom: 3px;\r\n    }\r\n\r\n    .prepared-by-name {\r\n      font-weight: bold;\r\n      margin-top: 3px;\r\n      font-size: 9.5pt;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .prepared-by-title {\r\n      font-size: 8.5pt;\r\n      color: #555;\r\n      margin-top: 2px;\r\n    }\r\n\r\n    .tagline {\r\n      text-align: center;\r\n      font-weight: bold;\r\n      font-size: 10pt;\r\n      margin: 10px 0 6px 0;\r\n      color: #2c3e50;\r\n      border-top: 1px solid #ddd;\r\n      padding-top: 6px;\r\n      page-break-before: avoid;\r\n    }\r\n\r\n    .footer {\r\n      font-size: 8pt;\r\n      color: #555;\r\n      text-align: center;\r\n      margin-top: 6px;\r\n      page-break-inside: avoid;\r\n      line-height: 1.2;\r\n    }\r\n\r\n    .footer p {\r\n      margin: 3px 0;\r\n    }\r\n\r\n    .footer strong {\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .text-center {\r\n      text-align: center;\r\n    }\r\n\r\n    .text-right {\r\n      text-align: right;\r\n    }\r\n\r\n    p {\r\n      margin: 3px 0;\r\n      line-height: 1.2;\r\n    }\r\n\r\n    strong {\r\n      font-weight: 600;\r\n    }\r\n\r\n    @media print {\r\n      thead { \r\n        display: table-header-group; \r\n      }\r\n      tfoot { \r\n        display: table-footer-group; \r\n      }\r\n      \r\n      table {\r\n        page-break-inside: avoid;\r\n      }\r\n      \r\n      tr {\r\n        break-inside: avoid;\r\n      }\r\n\r\n      tbody tr {\r\n        page-break-inside: avoid;\r\n      }\r\n\r\n      .subject-section {\r\n        page-break-after: avoid;\r\n        page-break-inside: avoid;\r\n      }\r\n\r\n      body {\r\n        font-size: 9pt;\r\n        margin: 0;\r\n        padding: 0;\r\n      }\r\n\r\n      .container {\r\n        margin: 0;\r\n        padding: 0;\r\n      }\r\n\r\n      .image-item {\r\n        page-break-inside: auto;\r\n      }\r\n\r\n      .images-row {\r\n        page-break-inside: auto;\r\n        break-inside: auto;\r\n      }\r\n    }\r\n\r\n    .no-break {\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    .compact {\r\n      margin-bottom: 6px;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <div class=\"content\">\r\n      <div class=\"header-section no-break\">\r\n        <div class=\"header\">\r\n          <img class=\"logo\" src=\"https://agats.s3.ap-south-1.amazonaws.com/logo/alghlogo.jpg\" alt=\"Company Logo\">\r\n          <div class=\"company-names\">\r\n            <div class=\"company-name-arabic\">ÿßŸÑÿ∫ÿ≤ÿßŸÑ ÿßŸÑÿ£ÿ®Ÿäÿ∂ ŸÑŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÅŸÜŸäÿ©</div>\r\n            <div class=\"company-name-english\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"client-info-container\">\r\n          <div class=\"client-info\">\r\n            <p><strong>CLIENT:</strong> ${client.clientName || \"N/A\"}</p>\r\n            <p><strong>ADDRESS:</strong> ${client.clientAddress || \"N/A\"}</p>\r\n            <p><strong>CONTACT:</strong> ${client.mobileNumber || client.telephoneNumber || \"N/A\"}</p>\r\n            <p><strong>EMAIL:</strong> ${client.email || \"N/A\"}</p>\r\n            <p><strong>SITE:</strong> ${site}</p>\r\n            <p><strong>ATTENTION:</strong> ${project.attention || \"N/A\"}</p>\r\n          </div>\r\n\r\n          <div class=\"quotation-info\">\r\n            <table class=\"quotation-details\">\r\n              <tr>\r\n                <td>Quotation #:</td>\r\n                <td>${quotation.quotationNumber}</td>\r\n              </tr>\r\n              <tr>\r\n                <td>Date:</td>\r\n                <td>${formatDate(quotation.date)}</td>\r\n              </tr>\r\n              <tr>\r\n                <td>Valid Until:</td>\r\n                <td>${formatDate(quotation.validUntil)} (${getDaysRemaining(quotation.validUntil)})</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"subject-section\">\r\n          <div class=\"subject-title\">SUBJECT</div>\r\n          <div class=\"subject-content\">${project.projectName || \"N/A\"}</div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"section no-break\">\r\n        <div class=\"section-title\">ITEMS</div>\r\n        <div class=\"table-container\">\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th class=\"col-no\">No.</th>\r\n                <th class=\"col-desc\">Description</th>\r\n                <th class=\"col-uom\">UOM</th>\r\n                <th class=\"col-qty\">Qty</th>\r\n                <th class=\"col-unit\">Unit Price (AED)</th>\r\n                <th class=\"col-total\">Total (AED)</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              ${quotation.items.map((item: any, index: number) => `\r\n                <tr>\r\n                  <td class=\"text-center col-no\">${index + 1}</td>\r\n                  <td class=\"col-desc\">${cleanDescription(item.description)}</td>\r\n                  <td class=\"text-center col-uom\">${item.uom || \"NOS\"}</td>\r\n                  <td class=\"text-center col-qty\">${item.quantity.toFixed(2)}</td>\r\n                  <td class=\"text-right col-unit\">${formatCurrency(item.unitPrice)}</td>\r\n                  <td class=\"text-right col-total\">${formatCurrency(item.totalPrice)}</td>\r\n                </tr>\r\n              `).join(\"\")}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n\r\n        <div class=\"amount-summary\">\r\n          <div class=\"amount-summary-row\">\r\n            <div class=\"amount-label\">SUBTOTAL:</div>\r\n            <div class=\"amount-value\">${formatCurrency(subtotal)} AED</div>\r\n          </div>\r\n          <div class=\"amount-summary-row\">\r\n            <div class=\"amount-label\">VAT ${quotation.vatPercentage}%:</div>\r\n            <div class=\"amount-value\">${formatCurrency(vatAmount)} AED</div>\r\n          </div>\r\n          <div class=\"net-amount-row\">\r\n            <div class=\"amount-label\">NET AMOUNT:</div>\r\n            <div class=\"amount-value\">${formatCurrency(netAmount)} AED</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      <!-- IMAGES SECTION -->\r\n      ${\r\n        quotation.images && quotation.images.length > 0 ? `\r\n        <div class=\"images-section\">\r\n          <div class=\"section-title\">QUOTATION IMAGES</div>\r\n          <div class=\"images-grid\">\r\n            ${(() => {\r\n              let html = '';\r\n              for (let i = 0; i < quotation.images.length; i += 3) {\r\n                const rowImages = quotation.images.slice(i, i + 3);\r\n                html += '<div class=\"images-row\">';\r\n                \r\n                for (let j = 0; j < 3; j++) {\r\n                  if (j < rowImages.length) {\r\n                    const image = rowImages[j];\r\n                    html += `\r\n                      <div class=\"image-item\">\r\n                        <div class=\"image-container\">\r\n                          <img src=\"${image.imageUrl}\" alt=\"${image.title}\" />\r\n                        </div>\r\n                        <div class=\"image-title\">${image.title}</div>\r\n                      </div>\r\n                    `;\r\n                  } else {\r\n                    html += `\r\n                      <div class=\"image-item\" style=\"visibility: hidden;\">\r\n                        <div class=\"image-container\"></div>\r\n                        <div class=\"image-title\"></div>\r\n                      </div>\r\n                    `;\r\n                  }\r\n                }\r\n                html += '</div>';\r\n              }\r\n              return html;\r\n            })()}\r\n          </div>\r\n        </div>\r\n        ` : ''\r\n      }\r\n\r\n      ${quotation.termsAndConditions && quotation.termsAndConditions.length > 0 ? `\r\n      <div class=\"terms-prepared-section no-break\">\r\n        <div class=\"terms-prepared-header\">\r\n          <div class=\"terms-title\">TERMS & CONDITIONS</div>\r\n          <div class=\"prepared-title\">PREPARED BY</div>\r\n        </div>\r\n        <div class=\"terms-prepared-content\">\r\n          <div class=\"terms-content\">\r\n            <div class=\"terms-box\">\r\n              <ol>\r\n                ${quotation.termsAndConditions.map((term: string) => `<li>${term}</li>`).join(\"\")}\r\n              </ol>\r\n            </div>\r\n          </div>\r\n          <div class=\"prepared-content\">\r\n            <div class=\"prepared-by-name\">${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}</div>\r\n            ${preparedBy?.phoneNumbers?.length ? `\r\n            <div class=\"prepared-by-title\">Phone: ${preparedBy.phoneNumbers.join(\", \")}</div>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n      </div>\r\n      ` : `\r\n      <div class=\"section no-break\">\r\n        <div class=\"section-title\">PREPARED BY</div>\r\n        <div class=\"prepared-content\">\r\n          <div class=\"prepared-by-name\">${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}</div>\r\n          ${preparedBy?.phoneNumbers?.length ? `\r\n          <div class=\"prepared-by-title\">Phone: ${preparedBy.phoneNumbers.join(\", \")}</div>\r\n          ` : ''}\r\n        </div>\r\n      </div>\r\n      `}\r\n    </div>\r\n\r\n    <div class=\"tagline\">We work U Relax</div>\r\n    <div class=\"footer\">\r\n      <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n      <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n      <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n      <p>Generated on ${formatDate(new Date())}</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n`;\r\n\r\n  const browser = await puppeteer.launch({\r\n    headless: \"shell\",\r\n    args: [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--font-render-hinting=none\"],\r\n  });\r\n\r\n  try {\r\n    const page = await browser.newPage();\r\n\r\n    await page.setViewport({ width: 1200, height: 1600 });\r\n\r\n    await page.setContent(htmlContent, {\r\n      waitUntil: [\"load\", \"networkidle0\", \"domcontentloaded\"],\r\n      timeout: 30000,\r\n    });\r\n\r\n    const pdfBuffer = await page.pdf({\r\n      format: \"A4\",\r\n      printBackground: true,\r\n      margin: {\r\n        top: \"0.3cm\",\r\n        right: \"0.3cm\",\r\n        bottom: \"0.3cm\",\r\n        left: \"0.3cm\",\r\n      },\r\n      displayHeaderFooter: false,\r\n      preferCSSPageSize: true,\r\n    });\r\n\r\n    return pdfBuffer;\r\n  } catch (error) {\r\n    console.error(\"PDF generation error:\", error);\r\n    throw new ApiError(500, \"Failed to generate PDF\");\r\n  } finally {\r\n    await browser.close();\r\n  }\r\n};\r\n\r\n// Email template function\r\nconst createQuotationEmailTemplate = (\r\n  quotation: any,\r\n  client: IClient,\r\n  preparedBy: IUser,\r\n  project: IProject\r\n): string => {\r\n  const site = `${project.location} ${project.building} ${project.apartmentNumber}`;\r\n  \r\n  const subtotal = quotation.items.reduce((sum: number, item: any) => sum + item.totalPrice, 0);\r\n  const vatAmount = subtotal * (quotation.vatPercentage / 100);\r\n  const netAmount = subtotal + vatAmount;\r\n\r\n  const formatDate = (date: Date) => {\r\n    return date ? new Date(date).toLocaleDateString(\"en-GB\", {\r\n      day: \"2-digit\",\r\n      month: \"short\",\r\n      year: \"numeric\",\r\n    }) : \"\";\r\n  };\r\n\r\n  return `<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Quotation ${quotation.quotationNumber}</title>\r\n  <style>\r\n    body {\r\n      font-family: 'Arial', sans-serif;\r\n      font-size: 14px;\r\n      line-height: 1.6;\r\n      color: #333;\r\n      margin: 0;\r\n      padding: 20px;\r\n      background-color: #f9f9f9;\r\n    }\r\n    \r\n    .email-container {\r\n      max-width: 800px;\r\n      margin: 0 auto;\r\n      background: white;\r\n      border-radius: 8px;\r\n      box-shadow: 0 2px 10px rgba(0,0,0,0.1);\r\n      overflow: hidden;\r\n    }\r\n    \r\n    .email-header {\r\n      background: linear-gradient(135deg, #4a90e2, #357abd);\r\n      color: white;\r\n      padding: 20px;\r\n      text-align: center;\r\n    }\r\n    \r\n    .email-body {\r\n      padding: 30px;\r\n    }\r\n    \r\n    .greeting {\r\n      margin-bottom: 20px;\r\n      font-size: 16px;\r\n    }\r\n    \r\n    .client-name {\r\n    \r\n      padding: 2px 6px;\r\n      font-weight: bold;\r\n      color: #333;\r\n    }\r\n    \r\n    .content-section {\r\n      margin-bottom: 25px;\r\n    }\r\n    \r\n    .content-line {\r\n      margin-bottom: 12px;\r\n      font-size: 14px;\r\n    }\r\n    \r\n    .attachment-notice {\r\n      background: #e3f2fd;\r\n      border-left: 4px solid #2196f3;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    \r\n    .signature {\r\n      margin-top: 30px;\r\n      padding-top: 20px;\r\n      border-top: 2px solid #e0e0e0;\r\n    }\r\n    \r\n    .sender-name {\r\n      font-weight: bold;\r\n      font-size: 16px;\r\n      color: #2c3e50;\r\n    }\r\n    \r\n    .company-name {\r\n      font-weight: bold;\r\n      color: #4a90e2;\r\n      margin-top: 5px;\r\n    }\r\n    \r\n    .quotation-details {\r\n      background: #f8f9fa;\r\n      padding: 15px;\r\n      border-radius: 6px;\r\n      margin: 20px 0;\r\n    }\r\n    \r\n    .detail-row {\r\n      display: flex;\r\n      margin-bottom: 8px;\r\n    }\r\n    \r\n    .detail-label {\r\n      font-weight: bold;\r\n      min-width: 120px;\r\n      color: #2c3e50;\r\n    }\r\n    \r\n    .footer {\r\n      background: #2c3e50;\r\n      color: white;\r\n      padding: 20px;\r\n      text-align: center;\r\n      font-size: 12px;\r\n    }\r\n    \r\n    .footer a {\r\n      color: #4a90e2;\r\n      text-decoration: none;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"email-container\">\r\n    <div class=\"email-header\">\r\n      <h1>Quotation #${quotation.quotationNumber}</h1>\r\n      <p>${project.projectName}</p>\r\n    </div>\r\n    \r\n    <div class=\"email-body\">\r\n      <div class=\"greeting\">\r\n        Dear <span class=\"client-name\">${client.clientName}</span>,\r\n      </div>\r\n      \r\n      <div class=\"content-section\">\r\n        <div class=\"content-line\">\r\n          We are pleased to submit our quotation for your project. Please find the detailed quotation attached with this email.\r\n        </div>\r\n        \r\n        <div class=\"quotation-details\">\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Project:</span>\r\n            <span>${project.projectName}</span>\r\n          </div>\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Quotation Date:</span>\r\n            <span>${formatDate(quotation.date)}</span>\r\n          </div>\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Valid Until:</span>\r\n            <span>${formatDate(quotation.validUntil)}</span>\r\n          </div>\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Net Amount:</span>\r\n            <span><strong>AED ${netAmount.toFixed(2)}</strong></span>\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"content-line\">\r\n          The attached PDF contains complete details including:\r\n        </div>\r\n        <ul>\r\n          <li>Itemized pricing with descriptions</li>\r\n          <li>Terms and conditions</li>\r\n          <li>Project scope and specifications</li>\r\n          ${quotation.images && quotation.images.length > 0 ? '<li>Reference images</li>' : ''}\r\n        </ul>\r\n      </div>\r\n      \r\n      <div class=\"attachment-notice\">\r\n        <strong>üìé Attachment:</strong> Quotation-${quotation.quotationNumber}.pdf\r\n      </div>\r\n      \r\n      <div class=\"content-line\">\r\n        We are confident that our proposal meets your requirements and look forward to the opportunity to work with you.\r\n      </div>\r\n      \r\n      <div class=\"content-line\">\r\n        Please don't hesitate to contact us if you have any questions or require further clarification.\r\n      </div>\r\n      \r\n      <div class=\"signature\">\r\n        <div>Best regards,</div>\r\n        <div class=\"sender-name\">${preparedBy.firstName} ${preparedBy.lastName}</div>\r\n        <div class=\"company-name\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</div>\r\n        ${preparedBy.phoneNumbers?.length ? `\r\n        <div style=\"margin-top: 8px;\">\r\n          <strong>Phone:</strong> ${preparedBy.phoneNumbers.join(\", \")}\r\n        </div>\r\n        ` : ''}\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"footer\">\r\n      <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n      <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n      <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n};\r\n\r\n\r\n\r\nexport const sendWorkCompletionEmail = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { cc } = req.body; // Extract CC from request body\r\n\r\n    // Get project with populated data\r\n    const project = await Project.findById(projectId)\r\n      .populate<{ client: IClient }>(\"client\", \"clientName clientAddress mobileNumber telephoneNumber email\")\r\n      .populate<{ assignedTo: IUser }>(\"assignedTo\", \"firstName lastName signatureImage\")\r\n      .populate<{ createdBy: IUser }>(\"createdBy\", \"firstName lastName signatureImage\");\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const client = project.client as IClient;\r\n    \r\n    // Check if client has email\r\n    if (!client.email) {\r\n      throw new ApiError(400, \"Client email not found\");\r\n    }\r\n\r\n    // Validate CC emails if provided\r\n    if (cc && Array.isArray(cc) && cc.length > 0) {\r\n      const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n      const invalidEmails = cc.filter((email: string) => !emailRegex.test(email));\r\n      \r\n      if (invalidEmails.length > 0) {\r\n        throw new ApiError(400, `Invalid CC email addresses: ${invalidEmails.join(', ')}`);\r\n      }\r\n    }\r\n\r\n    // Get work completion data\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName signatureImage\");\r\n\r\n    const lpo = await LPO.findOne({ project: projectId })\r\n      .sort({ createdAt: -1 })\r\n      .limit(1);\r\n\r\n    // Generate PDF first using the new template\r\n    const pdfBuffer = await generateWorkCompletionPdfBuffer(\r\n      project,\r\n      client,\r\n      workCompletion,\r\n      lpo\r\n    );\r\n\r\n    // Create email HTML content\r\n    const emailHtmlContent = createWorkCompletionEmailTemplate(\r\n      project,\r\n      client,\r\n      workCompletion\r\n    );\r\n\r\n    try {\r\n      // Send email with PDF attachment and CC\r\n      await mailer.sendEmail({\r\n        to: client.email,\r\n        cc: cc && cc.length > 0 ? cc : undefined,\r\n        subject: `Work Completion Certificate - ${project.projectName}`,\r\n        html: emailHtmlContent,\r\n        attachments: [\r\n          {\r\n            filename: `Work-Completion-${project.projectNumber}.pdf`,\r\n            content: pdfBuffer as any,\r\n            contentType: 'application/pdf'\r\n          }\r\n        ]\r\n      });\r\n\r\n      const ccMessage = cc && cc.length > 0 ? ` with CC to ${cc.length} recipient(s)` : '';\r\n      res.status(200).json(\r\n        new ApiResponse(200, null, `Work completion email sent successfully${ccMessage}`)\r\n      );\r\n    } catch (error) {\r\n      console.error(\"Error sending work completion email:\", error);\r\n      throw new ApiError(500, \"Failed to send work completion email\");\r\n    }\r\n  }\r\n);\r\n\r\n// Helper function to generate PDF buffer using the new template\r\nconst generateWorkCompletionPdfBuffer = async (\r\n  project: any,\r\n  client: IClient,\r\n  workCompletion: any,\r\n  lpo: any\r\n) => {\r\n  const engineer: any = project.assignedTo;\r\n  const preparedBy: any = workCompletion?.createdBy;\r\n\r\n  const formatDate = (date: Date | string | undefined) => {\r\n    if (!date) return \"\";\r\n    const dateObj = typeof date === \"string\" ? new Date(date) : date;\r\n    return dateObj\r\n      .toLocaleDateString(\"en-GB\", {\r\n        day: \"2-digit\",\r\n        month: \"short\",\r\n        year: \"numeric\",\r\n      })\r\n      .replace(/ /g, \"-\");\r\n  };\r\n\r\n  const htmlContent = `\r\n    <!DOCTYPE html>\r\n    <html lang=\"en\">\r\n    <head>\r\n        <meta charset=\"UTF-8\">\r\n        <title>Completion Certificate</title>\r\n        <style>\r\n            @page {\r\n              size: A4;\r\n              margin: 0.5cm;\r\n            }\r\n            * {\r\n                box-sizing: border-box;\r\n            }\r\n            body {\r\n                font-family: 'Arial', sans-serif;\r\n                font-size: 11pt;\r\n                line-height: 1.4;\r\n                color: #333;\r\n                margin: 0;\r\n                padding: 0;\r\n            }\r\n            .container {\r\n                display: block;\r\n                width: 100%;\r\n                max-width: 100%;\r\n            }\r\n            .content {\r\n                margin-bottom: 15px;\r\n            }\r\n            .header {\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                margin-bottom: 15px;\r\n                gap: 20px;\r\n                page-break-after: avoid;\r\n                padding: 10px 0;\r\n                border-bottom: 3px solid #94d7f4;\r\n                position: relative;\r\n            }\r\n            .logo {\r\n                height: 50px;\r\n                width: auto;\r\n                max-width: 150px;\r\n                object-fit: contain;\r\n                position: absolute;\r\n                left: 0;\r\n                top: -12px;\r\n            }\r\n            .company-names {\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n                justify-content: center;\r\n                text-align: center;\r\n                flex-grow: 1;\r\n            }\r\n            .company-name-arabic {\r\n                font-size: 20pt;\r\n                font-weight: bold;\r\n                color: #1a1a1a;\r\n                line-height: 1.3;\r\n                direction: rtl;\r\n                unicode-bidi: bidi-override;\r\n                letter-spacing: 0;\r\n                margin-bottom: 5px;\r\n            }\r\n            .company-name-english {\r\n                font-size: 10pt;\r\n                font-weight: bold;\r\n                color: #1a1a1a;\r\n                line-height: 1.3;\r\n                letter-spacing: 0.08em;\r\n                text-transform: uppercase;\r\n            }\r\n            .certificate-title {\r\n                text-align: center;\r\n                font-size: 20pt;\r\n                font-weight: bold;\r\n                color: #2c3e50;\r\n                margin: 20px 0 15px 0;\r\n                text-transform: uppercase;\r\n                letter-spacing: 1.5px;\r\n                padding: 12px;\r\n                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\r\n                border-radius: 6px;\r\n                border-left: 4px solid #94d7f4;\r\n                border-right: 4px solid #94d7f4;\r\n            }\r\n            .section {\r\n                margin-bottom: 12px;\r\n                page-break-inside: avoid;\r\n            }\r\n            .section-title {\r\n                font-size: 11pt;\r\n                font-weight: bold;\r\n                padding: 4px 0;\r\n                margin: 12px 0 8px 0;\r\n                border-bottom: 2px solid #94d7f4;\r\n                page-break-after: avoid;\r\n                color: #2c3e50;\r\n            }\r\n            .info-table {\r\n                width: 100%;\r\n                border-collapse: collapse;\r\n                margin: 10px 0;\r\n                font-size: 10pt;\r\n            }\r\n            .info-table td {\r\n                padding: 6px 8px;\r\n                vertical-align: top;\r\n                line-height: 1.4;\r\n            }\r\n            .info-table .label {\r\n                font-weight: bold;\r\n                color: #2c3e50;\r\n                width: 30%;\r\n            }\r\n            .highlight {\r\n                padding: 2px 6px;\r\n                background-color: #f0f8ff;\r\n                border-radius: 3px;\r\n                font-weight: 600;\r\n            }\r\n            .certification-text {\r\n                margin: 15px 0;\r\n                padding: 12px 15px;\r\n                background-color: #f8f9fa;\r\n                border-left: 4px solid #94d7f4;\r\n                border-right: 4px solid #94d7f4;\r\n                border-radius: 4px;\r\n                font-size: 10.5pt;\r\n                line-height: 1.6;\r\n                color: #333;\r\n            }\r\n            table.signature-table {\r\n                width: 100%;\r\n                border-collapse: collapse;\r\n                margin: 10px 0;\r\n                font-size: 10pt;\r\n            }\r\n            .signature-table td {\r\n                padding: 10px 12px;\r\n                border: 1px solid #ddd;\r\n                vertical-align: middle;\r\n            }\r\n            .signature-table .header-row {\r\n                background-color: #94d7f4;\r\n                color: #000;\r\n                font-weight: bold;\r\n                text-align: center;\r\n                padding: 8px 12px;\r\n            }\r\n            .signature-table .label-row {\r\n                background-color: #f8f9fa;\r\n                font-weight: bold;\r\n                color: #2c3e50;\r\n                text-align: center;\r\n                padding: 8px 12px;\r\n            }\r\n            .signature-table .value-row {\r\n                text-align: center;\r\n                padding: 12px;\r\n            }\r\n            .signature-table td:nth-child(1) {\r\n                width: 30%;\r\n            }\r\n            .signature-table td:nth-child(2) {\r\n                width: 40%;\r\n            }\r\n            .signature-table td:nth-child(3) {\r\n                width: 30%;\r\n            }\r\n            .signature-img {\r\n                height: 50px;\r\n                max-width: 180px;\r\n                object-fit: contain;\r\n            }\r\n            .empty-signature {\r\n                height: 50px;\r\n                border: 1px dashed #ccc;\r\n                background-color: #f9f9f9;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                color: #999;\r\n                font-size: 9pt;\r\n            }\r\n            .signature-name {\r\n                font-weight: 600;\r\n                color: #2c3e50;\r\n            }\r\n            .green-text {\r\n                color: #228B22;\r\n                font-weight: bold;\r\n            }\r\n            \r\n            /* ==================== IMAGE SECTION (FIXED - NO BREAK PROBLEMS) ==================== */\r\n            \r\n            .images-section {\r\n                margin-top: 15px;\r\n                /* REMOVED: page-break-inside: avoid - Let it break naturally */\r\n            }\r\n            \r\n            .images-grid {\r\n                display: block;\r\n                margin-top: 8px;\r\n                /* REMOVED: page-break-inside rules - Let it flow naturally */\r\n            }\r\n            \r\n            .images-row {\r\n                display: flex;\r\n                gap: 12px;\r\n                margin-bottom: 12px;\r\n                /* REMOVED ALL page-break rules - Let rows break naturally between pages */\r\n                min-height: 140px; /* Ensure minimum height for better breaking */\r\n            }\r\n            \r\n            .image-item {\r\n                flex: 1;\r\n                min-width: calc(33.333% - 8px);\r\n                max-width: calc(33.333% - 8px);\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n                /* REMOVED: page-break-inside: avoid - Let items break naturally */\r\n                border: 1px solid #ddd;\r\n                border-radius: 6px;\r\n                padding: 8px;\r\n                background: #fafafa;\r\n                min-height: 140px;\r\n                box-sizing: border-box;\r\n                /* Allow breaking inside image items if needed */\r\n                page-break-inside: auto;\r\n            }\r\n            \r\n            .image-container {\r\n                width: 100%;\r\n                height: 140px;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                overflow: hidden;\r\n                margin-bottom: 6px;\r\n                background: #fff;\r\n                border-radius: 4px;\r\n                /* Prevent images from breaking */\r\n                page-break-inside: avoid;\r\n                break-inside: avoid;\r\n            }\r\n            \r\n            .image-container img {\r\n                max-height: 100%;\r\n                max-width: 100%;\r\n                object-fit: contain;\r\n                /* Ensure images don't break */\r\n                page-break-inside: avoid;\r\n                break-inside: avoid;\r\n            }\r\n            \r\n            .image-title {\r\n                font-size: 8.5pt;\r\n                font-weight: 600;\r\n                text-align: center;\r\n                color: #2c3e50;\r\n                line-height: 1.2;\r\n                margin: 0;\r\n                word-break: break-word;\r\n                max-height: 28px;\r\n                overflow: hidden;\r\n                display: -webkit-box;\r\n                -webkit-line-clamp: 2;\r\n                -webkit-box-orient: vertical;\r\n                /* Allow title to break with the image */\r\n                page-break-inside: auto;\r\n            }\r\n            \r\n            .tagline {\r\n                text-align: center;\r\n                font-weight: bold;\r\n                font-size: 11pt;\r\n               \r\n                color: #2c3e50;\r\n                border-top: 2px solid #ddd;\r\n                padding-top: 10px;\r\n                page-break-before: avoid;\r\n            }\r\n            .footer {\r\n                font-size: 8.5pt;\r\n                color: #555;\r\n                text-align: center;\r\n                margin-top: 8px;\r\n                page-break-inside: avoid;\r\n                line-height: 1.3;\r\n            }\r\n            .footer p {\r\n                margin: 4px 0;\r\n            }\r\n            .footer strong {\r\n                color: #2c3e50;\r\n            }\r\n            @media print {\r\n                body {\r\n                    font-size: 10pt;\r\n                }\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div class=\"container\">\r\n            <div class=\"content\">\r\n                <div class=\"header\">\r\n                    <img class=\"logo\" src=\"https://agats.s3.ap-south-1.amazonaws.com/logo/alghlogo.jpg\" alt=\"Company Logo\">\r\n                    <div class=\"company-names\">\r\n                        <div class=\"company-name-arabic\">ÿßŸÑÿ∫ÿ≤ÿßŸÑ ÿßŸÑÿ£ÿ®Ÿäÿ∂ ŸÑŸÑÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÅŸÜŸäÿ©</div>\r\n                        <div class=\"company-name-english\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"certificate-title\">Completion Certificate</div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"info-table\">\r\n                        <tr>\r\n                            <td class=\"label\">Reference</td>\r\n                            <td>: <span class=\"highlight\">${`QTN${project.projectNumber.slice(3,40)}`}</span></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">FM CONTRACTOR</td>\r\n                            <td>:&nbsp;${client.clientName}</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">SUB CONTRACTOR</td>\r\n                            <td>:&nbsp; AL GHAZAL ALABYAD TECHNICAL SERVICES</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">PROJECT DESCRIPTION</td>\r\n                            <td>: <span class=\"highlight\">${project.projectName}</span></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">LOCATION (Bldg.)</td>\r\n                            <td>: <span class=\"highlight\">${project.location}${project.building ? `, ${project.building}` : \"\"}</span></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <div class=\"certification-text\">\r\n                    This is to certify that the work described above in the project description has been cleared out and completed to the required standards and specifications.\r\n                </div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"info-table\">\r\n                        <tr>\r\n                            <td class=\"label\">Completion Date</td>\r\n                            <td>: <span class=\"highlight\">${formatDate(project.completionDate)}</span></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">LPO Number</td>\r\n                            <td>: ${lpo?.lpoNumber || \"N/A\"}</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">LPO Date</td>\r\n                            <td>: ${formatDate(lpo?.lpoDate)}</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"signature-table\">\r\n                        <tr>\r\n                            <td colspan=\"3\" class=\"header-row\">Hand over by: AL GHAZAL AL ABYAD TECHNICAL SERVICES</td>\r\n                        </tr>\r\n                        <tr class=\"label-row\">\r\n                            <td>Name</td>\r\n                            <td>Signature</td>\r\n                            <td>Date</td>\r\n                        </tr>\r\n                        <tr class=\"value-row\">\r\n                            <td>${engineer?.firstName} ${engineer?.lastName || \"\"}</td>\r\n                            <td>\r\n                                ${engineer?.signatureImage ? `<img src=\"${engineer.signatureImage}\" class=\"signature-img\" />` : '<div class=\"empty-signature\">Signature</div>'}\r\n                            </td>\r\n                            <td><span class=\"green-text\">${formatDate(project.handoverDate)}</span></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"signature-table\">\r\n                        <tr>\r\n                            <td colspan=\"3\" class=\"header-row\">Accepted by: Client side</td>\r\n                        </tr>\r\n                        <tr class=\"label-row\">\r\n                            <td>Name</td>\r\n                            <td>Signature</td>\r\n                            <td>Date</td>\r\n                        </tr>\r\n                        <tr class=\"value-row\">\r\n                            <td>${client.clientName}</td>\r\n                            <td>\r\n                                <div class=\"empty-signature\">Client Signature</div>\r\n                            </td>\r\n                            <td>${formatDate(project.acceptanceDate)}</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"signature-table\">\r\n                        <tr>\r\n                            <td colspan=\"3\" class=\"header-row\">Prepared by: AL GHAZAL AL ABYAD TECHNICAL SERVICES</td>\r\n                        </tr>\r\n                        <tr class=\"label-row\">\r\n                            <td>Name</td>\r\n                            <td>Signature</td>\r\n                            <td>Date</td>\r\n                        </tr>\r\n                        <tr class=\"value-row\">\r\n                            <td>${preparedBy?.firstName || \"\"} ${preparedBy?.lastName || \"\"}</td>\r\n                            <td>\r\n                                ${preparedBy?.signatureImage ? `<img src=\"${preparedBy.signatureImage}\" class=\"signature-img\" />` : '<div class=\"empty-signature\">Signature</div>'}\r\n                            </td>\r\n                            <td><span class=\"green-text\">${formatDate(project.handoverDate)}</span></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <!-- IMAGES SECTION -->\r\n                ${\r\n                  workCompletion?.images && workCompletion.images.length > 0 ? `\r\n                  <div class=\"images-section\">\r\n                    <div class=\"section-title\">Site Pictures</div>\r\n                    <div class=\"images-grid\">\r\n                      ${(() => {\r\n                        let html = '';\r\n                        for (let i = 0; i < workCompletion.images.length; i += 3) {\r\n                          const rowImages = workCompletion.images.slice(i, i + 3);\r\n                          html += '<div class=\"images-row\">';\r\n                          \r\n                          for (let j = 0; j < 3; j++) {\r\n                            if (j < rowImages.length) {\r\n                              const image = rowImages[j];\r\n                              html += `\r\n                                <div class=\"image-item\">\r\n                                  <div class=\"image-container\">\r\n                                    <img src=\"${image.imageUrl}\" alt=\"${image.title || \"Site picture\"}\" />\r\n                                  </div>\r\n                                  <div class=\"image-title\">${image.title || \"Site Image\"}</div>\r\n                                </div>\r\n                              `;\r\n                            } else {\r\n                              html += `\r\n                                <div class=\"image-item\" style=\"visibility: hidden;\">\r\n                                  <div class=\"image-container\"></div>\r\n                                  <div class=\"image-title\"></div>\r\n                                </div>\r\n                              `;\r\n                            }\r\n                          }\r\n                          html += '</div>';\r\n                        }\r\n                        return html;\r\n                      })()}\r\n                    </div>\r\n                  </div>\r\n                  ` : `\r\n                  <div class=\"section\">\r\n                    <div class=\"section-title\">Site Pictures</div>\r\n                    <p style=\"text-align: center; font-size: 10pt; color: #666; padding: 20px;\">No site pictures available</p>\r\n                  </div>\r\n                  `\r\n                }\r\n            </div>\r\n\r\n            <div class=\"tagline\">We work U Relax</div>\r\n            <div class=\"footer\">\r\n                <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n                <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n                <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n                <p>Generated on ${formatDate(new Date())}</p>\r\n            </div>\r\n        </div>\r\n    </body>\r\n    </html>\r\n  `;\r\n\r\n  const browser = await puppeteer.launch({\r\n    headless: \"shell\",\r\n    args: [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--font-render-hinting=none\"],\r\n  });\r\n\r\n  try {\r\n    const page = await browser.newPage();\r\n    await page.setViewport({ width: 1200, height: 1600 });\r\n    await page.setContent(htmlContent, {\r\n      waitUntil: [\"load\", \"networkidle0\", \"domcontentloaded\"],\r\n      timeout: 30000,\r\n    });\r\n\r\n    const pdfBuffer = await page.pdf({\r\n      format: \"A4\",\r\n      printBackground: true,\r\n      margin: {\r\n        top: \"0.5cm\",\r\n        right: \"0.5cm\",\r\n        bottom: \"0.5cm\",\r\n        left: \"0.5cm\",\r\n      },\r\n      displayHeaderFooter: false,\r\n      preferCSSPageSize: true,\r\n    });\r\n\r\n    return pdfBuffer;\r\n  } catch (error) {\r\n    console.error(\"PDF generation error:\", error);\r\n    throw new ApiError(500, \"Failed to generate PDF\");\r\n  } finally {\r\n    await browser.close();\r\n  }\r\n};\r\n\r\n// Email template function\r\nconst createWorkCompletionEmailTemplate = (\r\n  project: any,\r\n  client: IClient,\r\n  workCompletion: any\r\n): string => {\r\n  const formatDate = (date: Date | string | undefined) => {\r\n    if (!date) return \"N/A\";\r\n    const dateObj = typeof date === \"string\" ? new Date(date) : date;\r\n    return dateObj.toLocaleDateString(\"en-GB\", {\r\n      day: \"2-digit\",\r\n      month: \"short\",\r\n      year: \"numeric\",\r\n    });\r\n  };\r\n\r\n  const preparedBy: any = workCompletion?.createdBy;\r\n\r\n  return `<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta charset=\"UTF-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n  <title>Work Completion Certificate</title>\r\n  <style>\r\n    body {\r\n      font-family: 'Arial', sans-serif;\r\n      font-size: 14px;\r\n      line-height: 1.6;\r\n      color: #333;\r\n      margin: 0;\r\n      padding: 20px;\r\n      background-color: #f9f9f9;\r\n    }\r\n    \r\n    .email-container {\r\n      max-width: 800px;\r\n      margin: 0 auto;\r\n      background: white;\r\n      border-radius: 8px;\r\n      box-shadow: 0 2px 10px rgba(0,0,0,0.1);\r\n      overflow: hidden;\r\n    }\r\n    \r\n    .email-header {\r\n      background: linear-gradient(135deg, #800080, #9b30ff);\r\n      color: white;\r\n      padding: 20px;\r\n      text-align: center;\r\n    }\r\n    \r\n    .email-body {\r\n      padding: 30px;\r\n    }\r\n    \r\n    .greeting {\r\n      margin-bottom: 20px;\r\n      font-size: 16px;\r\n    }\r\n    \r\n    .client-name {\r\n     \r\n      padding: 2px 6px;\r\n      font-weight: bold;\r\n      color: #333;\r\n    }\r\n    \r\n    .content-section {\r\n      margin-bottom: 25px;\r\n    }\r\n    \r\n    .content-line {\r\n      margin-bottom: 12px;\r\n      font-size: 14px;\r\n    }\r\n    \r\n    .attachment-notice {\r\n      background: #e3f2fd;\r\n      border-left: 4px solid #2196f3;\r\n      padding: 15px;\r\n      margin: 20px 0;\r\n      border-radius: 4px;\r\n    }\r\n    \r\n    .signature {\r\n      margin-top: 30px;\r\n      padding-top: 20px;\r\n      border-top: 2px solid #e0e0e0;\r\n    }\r\n    \r\n    .sender-name {\r\n      font-weight: bold;\r\n      font-size: 16px;\r\n      color: #2c3e50;\r\n    }\r\n    \r\n    .company-name {\r\n      font-weight: bold;\r\n      color: #800080;\r\n      margin-top: 5px;\r\n    }\r\n    \r\n    .completion-details {\r\n      background: #f8f9fa;\r\n      padding: 15px;\r\n      border-radius: 6px;\r\n      margin: 20px 0;\r\n    }\r\n    \r\n    .detail-row {\r\n      display: flex;\r\n      margin-bottom: 8px;\r\n    }\r\n    \r\n    .detail-label {\r\n      font-weight: bold;\r\n      min-width: 150px;\r\n      color: #2c3e50;\r\n    }\r\n    \r\n    .footer {\r\n      background: #2c3e50;\r\n      color: white;\r\n      padding: 20px;\r\n      text-align: center;\r\n      font-size: 12px;\r\n    }\r\n    \r\n    .footer a {\r\n      color: #9b30ff;\r\n      text-decoration: none;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"email-container\">\r\n    <div class=\"email-header\">\r\n      <h1>Work Completion Certificate</h1>\r\n      <p>${project.projectName}</p>\r\n    </div>\r\n    \r\n    <div class=\"email-body\">\r\n      <div class=\"greeting\">\r\n        Dear <span class=\"client-name\">${client.clientName}</span>,\r\n      </div>\r\n      \r\n      <div class=\"content-section\">\r\n        <div class=\"content-line\">\r\n          We are pleased to inform you that the work on the project <strong>\"${project.projectName}\"</strong> has been successfully completed.\r\n        </div>\r\n        \r\n        <div class=\"completion-details\">\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Project:</span>\r\n            <span>${project.projectName}</span>\r\n          </div>\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Location:</span>\r\n            <span>${project.location}${project.building ? `, ${project.building}` : \"\"}</span>\r\n          </div>\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Completion Date:</span>\r\n            <span>${formatDate(project.completionDate)}</span>\r\n          </div>\r\n          <div class=\"detail-row\">\r\n            <span class=\"detail-label\">Handover Date:</span>\r\n            <span>${formatDate(project.handoverDate)}</span>\r\n          </div>\r\n        </div>\r\n        \r\n        <div class=\"content-line\">\r\n          The attached Work Completion Certificate contains complete details including:\r\n        </div>\r\n        <ul>\r\n          <li>Project reference and description</li>\r\n          <li>Handover and acceptance information</li>\r\n          <li>LPO details</li>\r\n          ${workCompletion?.images && workCompletion.images.length > 0 ? '<li>Site completion pictures</li>' : ''}\r\n          <li>Official signatures and stamps</li>\r\n        </ul>\r\n      </div>\r\n      \r\n      <div class=\"attachment-notice\">\r\n        <strong>üìé Attachment:</strong> Work-Completion-${project.projectNumber}.pdf\r\n      </div>\r\n      \r\n      <div class=\"content-line\">\r\n        All work has been completed as per the agreed specifications and requirements. We hope you are satisfied with the quality of work delivered.\r\n      </div>\r\n      \r\n      <div class=\"content-line\">\r\n        Should you have any questions or require further information, please feel free to contact us.\r\n      </div>\r\n      \r\n      <div class=\"signature\">\r\n        <div>Best regards,</div>\r\n        <div class=\"sender-name\">${preparedBy?.firstName || \"\"} ${preparedBy?.lastName || \"\"}</div>\r\n        <div class=\"company-name\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</div>\r\n      </div>\r\n    </div>\r\n    \r\n    <div class=\"footer\">\r\n      <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n      <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n      <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>`;\r\n};"]}