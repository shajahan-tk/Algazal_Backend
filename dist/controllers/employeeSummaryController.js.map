{"version":3,"file":"employeeSummaryController.js","sourceRoot":"","sources":["../../src/controllers/employeeSummaryController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport { User } from \"../models/userModel\";\r\nimport { Attendance } from \"../models/attendanceModel\";\r\nimport { VisaExpense } from \"../models/visaExpenseModel\";\r\nimport { startOfMonth, endOfMonth, subMonths, format } from \"date-fns\";\r\nimport { EmployeeExpense } from \"../models/employeeExpenseModel\";\r\nimport { calculatePreviousMonthOvertimeAmount } from \"./payrollController\";\r\n\r\nexport const getEmployeeSummary = asyncHandler(async (req: Request, res: Response) => {\r\n  const { id } = req.params;\r\n\r\n  if (!id) throw new ApiError(400, \"User ID is required\");\r\n\r\n  const user = await User.findById(id).select(\"-password\");\r\n  if (!user) throw new ApiError(404, \"User not found\");\r\n\r\n  // Get employee expense details first (needed for overtime calculation)\r\n  const employeeExpense = await EmployeeExpense.findOne({ employee: user._id });\r\n  const basicSalary = Number(employeeExpense?.basicSalary) || 0;\r\n  const allowance = Number(employeeExpense?.allowance) || 0;\r\n\r\n  // âœ… Use the updated helper function that calculates overtime AMOUNT for previous month\r\n  const overtimeData = await calculatePreviousMonthOvertimeAmount(user._id, basicSalary);\r\n\r\n  const visaExpense = await VisaExpense.findOne({ employee: user._id })\r\n    .sort({ createdAt: -1 })\r\n    .select(\"labourCardPersonalNumber workPermitNumber passportNumber emirateIdNumber iBan total\")\r\n    .lean();\r\n\r\n  // Get current period for display\r\n  const now = new Date();\r\n  const prevMonth = subMonths(now, 1);\r\n  const period = format(prevMonth, \"MM-yyyy\");\r\n\r\n  const response = {\r\n    employee: {\r\n      _id: user._id,\r\n      firstName: user.firstName,\r\n      lastName: user.lastName,\r\n      email: user.email,\r\n      role: user.role,\r\n      basicSalary,\r\n      allowance,\r\n      phoneNumbers: user.phoneNumbers,\r\n      accountNumber: user.accountNumber,\r\n      emiratesId: user.emiratesId,\r\n      passportNumber: user.passportNumber,\r\n      iBANNumber: user.iBANNumber,\r\n      address: user.address,\r\n    },\r\n    overtime: {\r\n      previousMonthAmount: overtimeData.overtimeAmount, // Amount in AED\r\n      previousMonthHours: overtimeData.overtimeHours,   // Hours for reference\r\n      hourlyRate: overtimeData.hourlyRate,              // Hourly rate for reference\r\n      daysInMonth: overtimeData.daysInMonth,            // Days in previous month\r\n      period,\r\n    },\r\n    visaDetails: visaExpense\r\n      ? {\r\n          labourCardPersonalNumber: visaExpense.labourCardPersonalNumber,\r\n          workPermitNumber: visaExpense.workPermitNumber,\r\n          passportNumber: visaExpense.passportNumber,\r\n          emirateIdNumber: visaExpense.emirateIdNumber,\r\n          iBan: visaExpense.iBan,\r\n          totalVisaExpenses: visaExpense.total,\r\n        }\r\n      : null,\r\n  };\r\n\r\n  res.status(200).json(new ApiResponse(200, response, \"Employee summary retrieved successfully\"));\r\n});"]}