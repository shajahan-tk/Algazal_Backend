{"version":3,"file":"projectProfitController.js","sourceRoot":"","sources":["../../src/controllers/projectProfitController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse, ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport { ProjectProfit } from \"../models/projectProfitModel\";\r\nimport { Project } from \"../models/projectModel\";\r\nimport { LPO } from \"../models/lpoModel\";\r\nimport { IUser } from \"../models/userModel\";\r\nimport ExcelJS from \"exceljs\";\r\nimport {\r\n  handleMultipleFileUploads,\r\n  deleteFileFromS3,\r\n  getS3KeyFromUrl,\r\n} from \"../utils/uploadConf\";\r\n\r\nexport const getProjects = asyncHandler(async (req: Request, res: Response) => {\r\n  const page = parseInt(req.query.page as string) || 1;\r\n  const limit = parseInt(req.query.limit as string) || 10;\r\n  const skip = (page - 1) * limit;\r\n\r\n  // Build filter\r\n  const filter: any = {};\r\n\r\n  if (req.query.status) filter.status = req.query.status;\r\n  if (req.query.client) filter.client = req.query.client;\r\n\r\n  if (req.query.search) {\r\n    const searchTerm = req.query.search as string;\r\n    filter.$or = [\r\n      { projectName: { $regex: searchTerm, $options: \"i\" } },\r\n      { projectDescription: { $regex: searchTerm, $options: \"i\" } },\r\n      { location: { $regex: searchTerm, $options: \"i\" } },\r\n      { building: { $regex: searchTerm, $options: \"i\" } },\r\n      { apartmentNumber: { $regex: searchTerm, $options: \"i\" } },\r\n      { projectNumber: { $regex: searchTerm, $options: \"i\" } },\r\n    ];\r\n  }\r\n\r\n  // Count total\r\n  const total = await Project.countDocuments(filter);\r\n\r\n  // Use aggregation to fetch projects + LPO number + Quotation amount\r\n  const projects = await Project.aggregate([\r\n    { $match: filter },\r\n\r\n    // Sort by latest created\r\n    { $sort: { createdAt: -1 } },\r\n\r\n    // Pagination\r\n    { $skip: skip },\r\n    { $limit: limit },\r\n\r\n    // Lookup client info\r\n    {\r\n      $lookup: {\r\n        from: \"clients\",\r\n        localField: \"client\",\r\n        foreignField: \"_id\",\r\n        as: \"client\",\r\n      },\r\n    },\r\n    { $unwind: \"$client\" },\r\n\r\n    // Lookup LPO info (for each project)\r\n    {\r\n      $lookup: {\r\n        from: \"lpos\",\r\n        localField: \"_id\",\r\n        foreignField: \"project\",\r\n        as: \"lpoData\",\r\n      },\r\n    },\r\n\r\n    // Lookup Quotation info (for each project)\r\n    {\r\n      $lookup: {\r\n        from: \"quotations\",\r\n        localField: \"_id\",\r\n        foreignField: \"project\",\r\n        as: \"quotationData\",\r\n      },\r\n    },\r\n\r\n    // Add LPO and Quotation fields\r\n    {\r\n      $addFields: {\r\n        lpoNumber: { $arrayElemAt: [\"$lpoData.lpoNumber\", 0] },\r\n        quotationAmount: { $arrayElemAt: [\"$quotationData.netAmount\", 0] },\r\n        quotationNumber: { $arrayElemAt: [\"$quotationData.quotationNumber\", 0] },\r\n      },\r\n    },\r\n\r\n    // Optionally remove extra fields\r\n    {\r\n      $project: {\r\n        lpoData: 0, // hide full LPO data\r\n        quotationData: 0, // hide full quotation data\r\n      },\r\n    },\r\n  ]);\r\n\r\n  res.status(200).json(\r\n    new ApiResponse(\r\n      200,\r\n      {\r\n        projects,\r\n        pagination: {\r\n          total,\r\n          page,\r\n          limit,\r\n          totalPages: Math.ceil(total / limit),\r\n          hasNextPage: page * limit < total,\r\n          hasPreviousPage: page > 1,\r\n        },\r\n      },\r\n      \"Projects retrieved successfully\"\r\n    )\r\n  );\r\n});\r\n\r\nexport const createProjectProfit = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    let projectId: string;\r\n    let reportPeriodStart: string;\r\n    let reportPeriodEnd: string;\r\n    let budget: string | number;\r\n    let expenses: string | number;\r\n    let description: string;\r\n    let lpoId: string;\r\n\r\n    try {\r\n      console.log(\"=== CREATE PROJECT PROFIT ===\");\r\n      console.log(\"Request body:\", req.body);\r\n      console.log(\"Request files:\", req.files);\r\n      console.log(\"User:\", req.user);\r\n      \r\n      // Destructure and assign to outer variables\r\n      ({ \r\n        projectId, \r\n        reportPeriodStart, \r\n        reportPeriodEnd, \r\n        budget, \r\n        expenses, \r\n        description,\r\n        lpoId \r\n      } = req.body);\r\n\r\n      // Detailed validation with specific error messages\r\n      if (!projectId) {\r\n        console.error(\"Validation failed: Project ID is missing\");\r\n        throw new ApiError(400, \"Project ID is required\");\r\n      }\r\n      \r\n      if (!reportPeriodStart) {\r\n        console.error(\"Validation failed: Report period start date is missing\");\r\n        throw new ApiError(400, \"Report period start date is required\");\r\n      }\r\n      \r\n      if (!reportPeriodEnd) {\r\n        console.error(\"Validation failed: Report period end date is missing\");\r\n        throw new ApiError(400, \"Report period end date is required\");\r\n      }\r\n      \r\n      if (budget === undefined || budget === null || budget === '') {\r\n        console.error(\"Validation failed: Budget is missing or invalid:\", budget);\r\n        throw new ApiError(400, \"Budget is required\");\r\n      }\r\n      \r\n      // Validate that budget is a valid number\r\n      const budgetNum = Number(budget);\r\n      if (isNaN(budgetNum)) {\r\n        console.error(\"Validation failed: Budget is not a valid number:\", budget);\r\n        throw new ApiError(400, \"Budget must be a valid number\");\r\n      }\r\n      \r\n      console.log(\"Validation passed, fetching project...\");\r\n    } catch (error) {\r\n      console.error(\"Error in createProjectProfit:\", error);\r\n      throw error;\r\n    }\r\n\r\n    // Fetch project with populated client\r\n    const project = await Project.findById(projectId).populate(\"client\");\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    // Don't store LPO number in project profit - just reference the LPO ID\r\n    // We'll fetch the LPO data when needed\r\n\r\n    // Handle file uploads\r\n    let attachments: Array<{ fileName: string; fileType: string; filePath: string }> = [];\r\n    const files = Array.isArray(req.files) ? req.files : req.files ? Object.values(req.files).flat() : [];\r\n\r\n    if (files.length > 0) {\r\n      const uploadResults = await handleMultipleFileUploads(files);\r\n      if (!uploadResults.success) {\r\n        throw new ApiError(500, \"Failed to upload attachments\");\r\n      }\r\n      attachments = uploadResults.uploadData?.map((file) => ({\r\n        fileName: file.key.split(\"/\").pop() || \"attachment\",\r\n        fileType: file.mimetype,\r\n        filePath: file.url,\r\n      })) || [];\r\n    }\r\n\r\n    // Calculate report month (first day of the month)\r\n    const reportMonth = new Date(reportPeriodStart);\r\n    reportMonth.setDate(1);\r\n    reportMonth.setHours(0, 0, 0, 0);\r\n\r\n    // Create project profit WITHOUT storing LPO number\r\n    const projectProfit = await ProjectProfit.create({\r\n      project: projectId,\r\n      projectName: project.projectName,\r\n      projectNumber: project.projectNumber,\r\n      clientName: (project.client as any).clientName,\r\n      location: project.location,\r\n      building: project.building,\r\n      apartmentNumber: project.apartmentNumber,\r\n      // Only store lpoId reference, not lpoNumber\r\n      lpoId: lpoId || undefined,\r\n      reportMonth,\r\n      reportPeriodStart: new Date(reportPeriodStart),\r\n      reportPeriodEnd: new Date(reportPeriodEnd),\r\n      budget: Number(budget),\r\n      expenses: Number(expenses) || 0,\r\n      description,\r\n      attachments,\r\n      createdBy: req.user?.userId,\r\n    });\r\n\r\n    res.status(201).json(\r\n      new ApiResponse(201, projectProfit, \"Project profit record created successfully\")\r\n    );\r\n  }\r\n);\r\n\r\nexport const getProjectProfits = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { \r\n      search, \r\n      month, \r\n      year, \r\n      startDate, \r\n      endDate, \r\n      minProfit, \r\n      maxProfit,\r\n      projectId,\r\n      page = 1, \r\n      limit = 10 \r\n    } = req.query;\r\n    const skip = (Number(page) - 1) * Number(limit);\r\n\r\n    const filter: any = {};\r\n\r\n    // Project filter\r\n    if (projectId) {\r\n      filter.project = projectId;\r\n    }\r\n\r\n    // Search filter\r\n    if (search) {\r\n      const searchRegex = new RegExp(search as string, \"i\");\r\n      filter.$or = [\r\n        { projectName: searchRegex },\r\n        { projectNumber: searchRegex },\r\n        { description: searchRegex },\r\n        { clientName: searchRegex },\r\n      ];\r\n    }\r\n\r\n    // Date range filter (takes precedence over year/month)\r\n    if (startDate && endDate) {\r\n      filter.reportMonth = {\r\n        $gte: new Date(startDate as string),\r\n        $lte: new Date(endDate as string),\r\n      };\r\n    } else {\r\n      // Year filter\r\n      if (year) {\r\n        const yearNum = parseInt(year as string);\r\n        if (isNaN(yearNum)) {\r\n          throw new ApiError(400, \"Invalid year value\");\r\n        }\r\n        filter.reportMonth = {\r\n          $gte: new Date(yearNum, 0, 1),\r\n          $lte: new Date(yearNum + 1, 0, 1),\r\n        };\r\n      }\r\n\r\n      // Month filter (works with year filter)\r\n      if (month) {\r\n        const monthNum = parseInt(month as string);\r\n        if (isNaN(monthNum) || monthNum < 1 || monthNum > 12) {\r\n          throw new ApiError(400, \"Invalid month value (1-12)\");\r\n        }\r\n\r\n        if (!filter.reportMonth) {\r\n          const currentYear = new Date().getFullYear();\r\n          filter.reportMonth = {\r\n            $gte: new Date(currentYear, monthNum - 1, 1),\r\n            $lt: new Date(currentYear, monthNum, 1),\r\n          };\r\n        } else {\r\n          const startDate = new Date(filter.reportMonth.$gte);\r\n          startDate.setMonth(monthNum - 1);\r\n          startDate.setDate(1);\r\n\r\n          const endDate = new Date(startDate);\r\n          endDate.setMonth(monthNum);\r\n\r\n          filter.reportMonth.$gte = startDate;\r\n          filter.reportMonth.$lte = endDate;\r\n        }\r\n      }\r\n    }\r\n\r\n    // Profit range filter\r\n    if (minProfit || maxProfit) {\r\n      filter.profit = {};\r\n      if (minProfit) {\r\n        filter.profit.$gte = parseFloat(minProfit as string);\r\n      }\r\n      if (maxProfit) {\r\n        filter.profit.$lte = parseFloat(maxProfit as string);\r\n      }\r\n    }\r\n\r\n    const total = await ProjectProfit.countDocuments(filter);\r\n    const totals = await ProjectProfit.aggregate([\r\n      { $match: filter },\r\n      {\r\n        $group: {\r\n          _id: null,\r\n          totalBudget: { $sum: \"$budget\" },\r\n          totalExpenses: { $sum: \"$expenses\" },\r\n          totalProfit: { $sum: \"$profit\" },\r\n        },\r\n      },\r\n    ]);\r\n\r\n    // Get project profits with populated LPO data\r\n    const projects = await ProjectProfit.aggregate([\r\n      { $match: filter },\r\n      { $skip: skip },\r\n      { $limit: Number(limit) },\r\n      { $sort: { reportMonth: -1 } },\r\n      // Lookup LPO data to get lpoNumber\r\n      {\r\n        $lookup: {\r\n          from: \"lpos\",\r\n          localField: \"lpoId\",\r\n          foreignField: \"_id\",\r\n          as: \"lpoData\",\r\n        },\r\n      },\r\n      {\r\n        $addFields: {\r\n          lpoNumber: { $arrayElemAt: [\"$lpoData.lpoNumber\", 0] },\r\n        },\r\n      },\r\n      {\r\n        $project: {\r\n          lpoData: 0, // Remove the full LPO data array\r\n        },\r\n      },\r\n    ]);\r\n\r\n    // Populate createdBy and project separately\r\n    const populatedProjects = await ProjectProfit.populate(projects, [\r\n      { path: \"createdBy\", select: \"firstName lastName\" },\r\n      { path: \"project\", select: \"projectName projectNumber\" },\r\n    ]);\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(\r\n        200,\r\n        {\r\n          projects: populatedProjects,\r\n          totals: totals[0] || { totalBudget: 0, totalExpenses: 0, totalProfit: 0 },\r\n          pagination: {\r\n            total,\r\n            page: Number(page),\r\n            limit: Number(limit),\r\n            totalPages: Math.ceil(total / Number(limit)),\r\n            hasNextPage: Number(page) * Number(limit) < total,\r\n            hasPreviousPage: Number(page) > 1,\r\n          },\r\n        },\r\n        \"Project profits retrieved successfully\"\r\n      )\r\n    );\r\n  }\r\n);\r\n\r\nexport const getProjectProfit = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    const project = await ProjectProfit.findById(id)\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .populate(\"project\", \"projectName projectNumber\")\r\n      .populate(\"lpoId\", \"lpoNumber\"); // Populate LPO to get lpoNumber\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project profit record not found\");\r\n    }\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(\r\n        200,\r\n        project,\r\n        \"Project profit retrieved successfully\"\r\n      )\r\n    );\r\n  }\r\n);\r\n\r\nexport const updateProjectProfit = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const updateData = req.body;\r\n\r\n    const projectProfit = await ProjectProfit.findById(id);\r\n    if (!projectProfit) {\r\n      throw new ApiError(404, \"Project profit record not found\");\r\n    }\r\n\r\n    // Handle file uploads for new attachments\r\n    let newAttachments: Array<{\r\n      fileName: string;\r\n      fileType: string;\r\n      filePath: string;\r\n    }> = [];\r\n\r\n    const files = Array.isArray(req.files)\r\n      ? req.files\r\n      : req.files\r\n      ? Object.values(req.files).flat()\r\n      : [];\r\n\r\n    if (files.length > 0) {\r\n      const uploadResults = await handleMultipleFileUploads(files);\r\n      if (!uploadResults.success) {\r\n        throw new ApiError(500, \"Failed to upload new attachments\");\r\n      }\r\n      newAttachments =\r\n        uploadResults.uploadData?.map((file) => ({\r\n          fileName: file.key.split(\"/\").pop() || \"attachment\",\r\n          fileType: file.mimetype,\r\n          filePath: file.url,\r\n        })) || [];\r\n    }\r\n\r\n    // Handle attachment deletions\r\n    if (updateData.deletedAttachments && updateData.deletedAttachments.length > 0) {\r\n      await Promise.all(\r\n        updateData.deletedAttachments.map(async (attachmentId: string) => {\r\n          const attachment = projectProfit.attachments.id(attachmentId);\r\n          if (attachment) {\r\n            try {\r\n              const key = getS3KeyFromUrl(attachment.filePath);\r\n              await deleteFileFromS3(key);\r\n              projectProfit.attachments.pull(attachmentId);\r\n            } catch (error) {\r\n              console.error(`Failed to delete file from S3: ${attachment.filePath}`, error);\r\n            }\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    // Prepare update payload\r\n    const updatePayload: any = {\r\n      ...updateData,\r\n      $push: { attachments: { $each: newAttachments } },\r\n    };\r\n\r\n    // Convert dates if they exist\r\n    if (updateData.reportPeriodStart) {\r\n      updatePayload.reportPeriodStart = new Date(updateData.reportPeriodStart);\r\n      \r\n      const reportMonth = new Date(updateData.reportPeriodStart);\r\n      reportMonth.setDate(1);\r\n      reportMonth.setHours(0, 0, 0, 0);\r\n      updatePayload.reportMonth = reportMonth;\r\n    }\r\n    if (updateData.reportPeriodEnd) {\r\n      updatePayload.reportPeriodEnd = new Date(updateData.reportPeriodEnd);\r\n    }\r\n\r\n    // Convert numbers\r\n    if (updateData.budget !== undefined) {\r\n      updatePayload.budget = Number(updateData.budget);\r\n    }\r\n    if (updateData.expenses !== undefined) {\r\n      updatePayload.expenses = Number(updateData.expenses);\r\n    }\r\n\r\n    // Remove lpoNumber from update payload - we don't store it anymore\r\n    delete updatePayload.lpoNumber;\r\n\r\n    const updatedProject = await ProjectProfit.findByIdAndUpdate(\r\n      id,\r\n      updatePayload,\r\n      { new: true }\r\n    )\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .populate(\"lpoId\", \"lpoNumber\"); // Populate LPO to get lpoNumber\r\n\r\n    if (!updatedProject) {\r\n      throw new ApiError(500, \"Failed to update project profit record\");\r\n    }\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(200, updatedProject, \"Project profit updated successfully\")\r\n    );\r\n  }\r\n);\r\n\r\nexport const deleteProjectProfit = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    const project = await ProjectProfit.findById(id);\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project profit record not found\");\r\n    }\r\n\r\n    // Delete all associated files from S3\r\n    if (project.attachments && project.attachments.length > 0) {\r\n      await Promise.all(\r\n        project.attachments.map(async (attachment) => {\r\n          try {\r\n            const key = getS3KeyFromUrl(attachment.filePath);\r\n            await deleteFileFromS3(key);\r\n          } catch (error) {\r\n            console.error(\r\n              `Failed to delete file from S3: ${attachment.filePath}`,\r\n              error\r\n            );\r\n          }\r\n        })\r\n      );\r\n    }\r\n\r\n    await ProjectProfit.findByIdAndDelete(id);\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(\r\n        200,\r\n        null,\r\n        \"Project profit record deleted successfully\"\r\n      )\r\n    );\r\n  }\r\n);\r\n\r\nexport const getProfitSummary = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { groupBy } = req.query;\r\n\r\n    let groupStage: any;\r\n    switch (groupBy) {\r\n      case \"month\":\r\n        groupStage = {\r\n          $group: {\r\n            _id: {\r\n              year: { $year: \"$reportMonth\" },\r\n              month: { $month: \"$reportMonth\" },\r\n            },\r\n            totalBudget: { $sum: \"$budget\" },\r\n            totalExpenses: { $sum: \"$expenses\" },\r\n            totalProfit: { $sum: \"$profit\" },\r\n            count: { $sum: 1 },\r\n          },\r\n        };\r\n        break;\r\n      case \"year\":\r\n        groupStage = {\r\n          $group: {\r\n            _id: {\r\n              year: { $year: \"$reportMonth\" },\r\n            },\r\n            totalBudget: { $sum: \"$budget\" },\r\n            totalExpenses: { $sum: \"$expenses\" },\r\n            totalProfit: { $sum: \"$profit\" },\r\n            count: { $sum: 1 },\r\n          },\r\n        };\r\n        break;\r\n      default:\r\n        groupStage = {\r\n          $group: {\r\n            _id: null,\r\n            totalBudget: { $sum: \"$budget\" },\r\n            totalExpenses: { $sum: \"$expenses\" },\r\n            totalProfit: { $sum: \"$profit\" },\r\n            count: { $sum: 1 },\r\n          },\r\n        };\r\n    }\r\n\r\n    const summary = await ProjectProfit.aggregate([\r\n      groupStage,\r\n      { $sort: { _id: 1 } },\r\n    ]);\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(\r\n        200,\r\n        summary,\r\n        \"Profit summary retrieved successfully\"\r\n      )\r\n    );\r\n  }\r\n);\r\n\r\nexport const exportProjectProfitsToExcel = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { search, month, year, minProfit, maxProfit, projectId } = req.query;\r\n    \r\n    const filter: any = {};\r\n\r\n    // Project filter\r\n    if (projectId) {\r\n      filter.project = projectId;\r\n    }\r\n\r\n    // Search filter\r\n    if (search) {\r\n      const searchRegex = new RegExp(search as string, \"i\");\r\n      filter.$or = [\r\n        { projectName: searchRegex },\r\n        { description: searchRegex },\r\n        { clientName: searchRegex },\r\n      ];\r\n    }\r\n\r\n    // Date filter using reportMonth\r\n    if (month && year) {\r\n      const monthNum = parseInt(month as string);\r\n      const yearNum = parseInt(year as string);\r\n      \r\n      if (isNaN(monthNum) || monthNum < 1 || monthNum > 12) {\r\n        throw new ApiError(400, \"Invalid month value (1-12)\");\r\n      }\r\n      if (isNaN(yearNum)) {\r\n        throw new ApiError(400, \"Invalid year value\");\r\n      }\r\n\r\n      const startDate = new Date(yearNum, monthNum - 1, 1);\r\n      const endDate = new Date(yearNum, monthNum, 0);\r\n      \r\n      filter.reportMonth = {\r\n        $gte: startDate,\r\n        $lte: endDate\r\n      };\r\n    } else if (year && !month) {\r\n      const yearNum = parseInt(year as string);\r\n      if (isNaN(yearNum)) {\r\n        throw new ApiError(400, \"Invalid year value\");\r\n      }\r\n\r\n      const startDate = new Date(yearNum, 0, 1);\r\n      const endDate = new Date(yearNum, 11, 31);\r\n      \r\n      filter.reportMonth = {\r\n        $gte: startDate,\r\n        $lte: endDate\r\n      };\r\n    }\r\n\r\n    // Profit range filter\r\n    if (minProfit || maxProfit) {\r\n      filter.profit = {};\r\n      if (minProfit) {\r\n        const min = parseFloat(minProfit as string);\r\n        if (!isNaN(min)) filter.profit.$gte = min;\r\n      }\r\n      if (maxProfit) {\r\n        const max = parseFloat(maxProfit as string);\r\n        if (!isNaN(max)) filter.profit.$lte = max;\r\n      }\r\n    }\r\n\r\n    // Get projects with populated LPO data\r\n    const projects = await ProjectProfit.aggregate([\r\n      { $match: filter },\r\n      { $sort: { reportMonth: -1 } },\r\n      // Lookup LPO data to get lpoNumber\r\n      {\r\n        $lookup: {\r\n          from: \"lpos\",\r\n          localField: \"lpoId\",\r\n          foreignField: \"_id\",\r\n          as: \"lpoData\",\r\n        },\r\n      },\r\n      {\r\n        $addFields: {\r\n          lpoNumber: { $arrayElemAt: [\"$lpoData.lpoNumber\", 0] },\r\n        },\r\n      },\r\n      {\r\n        $project: {\r\n          lpoData: 0, // Remove the full LPO data array\r\n        },\r\n      },\r\n    ]);\r\n\r\n    // Populate createdBy\r\n    const populatedProjects = await ProjectProfit.populate(projects, [\r\n      { path: \"createdBy\", select: \"firstName lastName\" },\r\n    ]);\r\n\r\n    // Create Excel workbook\r\n    const workbook = new ExcelJS.Workbook();\r\n    const worksheet = workbook.addWorksheet(\"Project Profits\");\r\n\r\n    worksheet.columns = [\r\n      { header: \"SNO\", key: \"sno\", width: 5 },\r\n      { header: \"REPORT MONTH\", key: \"reportMonth\", width: 12 },\r\n      { header: \"PROJECT NAME\", key: \"projectName\", width: 25 },\r\n      { header: \"PROJECT NO\", key: \"projectNumber\", width: 15 },\r\n      { header: \"CLIENT\", key: \"clientName\", width: 20 },\r\n      { header: \"LPO NUMBER\", key: \"lpoNumber\", width: 15 },\r\n      { header: \"BUDGET\", key: \"budget\", width: 12 },\r\n      { header: \"EXPENSES\", key: \"expenses\", width: 12 },\r\n      { header: \"PROFIT\", key: \"profit\", width: 12 },\r\n      { header: \"REMARKS\", key: \"description\", width: 30 },\r\n    ];\r\n\r\n    populatedProjects.forEach((project:any, index)  => {\r\n      worksheet.addRow({\r\n        sno: index + 1,\r\n        reportMonth: project.reportMonth,\r\n        projectName: project.projectName,\r\n        projectNumber: project.projectNumber,\r\n        clientName: project.clientName,\r\n        lpoNumber: project.lpoNumber || \"N/A\",\r\n        budget: project.budget,\r\n        expenses: project.expenses,\r\n        profit: project.profit,\r\n        description: project.description || \"\",\r\n      });\r\n    });\r\n\r\n    // Style header row\r\n    worksheet.getRow(1).eachCell((cell) => {\r\n      cell.font = { bold: true };\r\n      cell.fill = {\r\n        type: \"pattern\",\r\n        pattern: \"solid\",\r\n        fgColor: { argb: \"FFD3D3D3\" },\r\n      };\r\n    });\r\n\r\n    // Add totals\r\n    const totals = await ProjectProfit.aggregate([\r\n      { $match: filter },\r\n      {\r\n        $group: {\r\n          _id: null,\r\n          totalBudget: { $sum: \"$budget\" },\r\n          totalExpenses: { $sum: \"$expenses\" },\r\n          totalProfit: { $sum: \"$profit\" },\r\n        },\r\n      },\r\n    ]);\r\n\r\n    if (totals.length > 0) {\r\n      worksheet.addRow([]);\r\n      const totalRow = worksheet.addRow({\r\n        projectName: \"TOTALS\",\r\n        budget: totals[0].totalBudget,\r\n        expenses: totals[0].totalExpenses,\r\n        profit: totals[0].totalProfit,\r\n      });\r\n      \r\n      totalRow.eachCell((cell) => {\r\n        cell.font = { bold: true };\r\n        cell.fill = {\r\n          type: \"pattern\",\r\n          pattern: \"solid\",\r\n          fgColor: { argb: \"FFF2F2F2\" },\r\n        };\r\n      });\r\n    }\r\n\r\n    res.setHeader(\r\n      \"Content-Type\",\r\n      \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\r\n    );\r\n    res.setHeader(\r\n      \"Content-Disposition\",\r\n      `attachment; filename=project_profits_${new Date().toISOString().split(\"T\")[0]}.xlsx`\r\n    );\r\n\r\n    await workbook.xlsx.write(res);\r\n    res.end();\r\n  }\r\n);"]}