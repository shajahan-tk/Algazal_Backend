{"version":3,"file":"workCompletionController.js","sourceRoot":"","sources":["../../src/controllers/workCompletionController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport {\r\n  IWorkCompletionImage,\r\n  WorkCompletion,\r\n} from \"../models/workCompletionModel\";\r\nimport { IProject, Project } from \"../models/projectModel\";\r\nimport {\r\n  uploadWorkCompletionImagesToS3,\r\n  deleteFileFromS3,\r\n} from \"../utils/uploadConf\";\r\nimport { Client, IClient } from \"../models/clientModel\";\r\nimport { LPO } from \"../models/lpoModel\";\r\nimport { generateRelatedDocumentNumber } from \"../utils/documentNumbers\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { IUser, User } from \"../models/userModel\";\r\nimport { Types } from \"mongoose\";\r\n\r\n// Helper function to get completion data\r\nasync function getCompletionDataForProject(projectId: string) {\r\n  type PopulatedProject = Omit<\r\n    IProject,\r\n    \"client\" | \"assignedTo\" | \"createdBy\"\r\n  > & {\r\n    client: IClient;\r\n    assignedTo?: IUser;\r\n    createdBy: IUser;\r\n  };\r\n\r\n  const project = await Project.findById(projectId)\r\n    .populate<{ client: IClient }>(\"client\", \"clientName\")\r\n    .populate<{ assignedTo: IUser }>(\"assignedTo\", \"firstName lastName\")\r\n    .populate<{ createdBy: IUser }>(\"createdBy\", \"firstName lastName\");\r\n\r\n  if (!project) {\r\n    throw new ApiError(404, \"Project not found\");\r\n  }\r\n\r\n  const populatedProject = project as unknown as PopulatedProject;\r\n  const client = populatedProject.client;\r\n  const lpo = await LPO.findOne({ project: projectId })\r\n    .sort({ createdAt: -1 })\r\n    .limit(1);\r\n  const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n    .populate(\"createdBy\", \"firstName lastName\")\r\n    .sort({ createdAt: -1 });\r\n\r\n  return {\r\n    _id: populatedProject._id.toString(),\r\n    referenceNumber: `COMP-${populatedProject._id\r\n      .toString()\r\n      .slice(-6)\r\n      .toUpperCase()}`,\r\n    fmContractor: \"Al Ghazal Al Abyad Technical Services\",\r\n    subContractor: client.clientName,\r\n    projectDescription:\r\n      populatedProject.projectDescription || \"No description provided\",\r\n    location: `${populatedProject.location}, ${populatedProject.building}, ${populatedProject.apartmentNumber}`,\r\n    completionDate:\r\n      populatedProject.completionDate?.toISOString() ||\r\n      populatedProject.updatedAt?.toISOString() ||\r\n      new Date().toISOString(),\r\n    lpoNumber: lpo?.lpoNumber || \"Not available\",\r\n    lpoDate: lpo?.lpoDate?.toISOString() || \"Not available\",\r\n    handover: {\r\n      company: \"AL GHAZAL AL ABYAD TECHNICAL SERVICES\",\r\n      name: populatedProject.assignedTo\r\n        ? `${populatedProject.assignedTo.firstName} ${populatedProject.assignedTo.lastName}`\r\n        : \"Not assigned\",\r\n      signature: \"\",\r\n      date:\r\n        populatedProject.handoverDate?.toISOString() ||\r\n        populatedProject.updatedAt?.toISOString() ||\r\n        new Date().toISOString(),\r\n    },\r\n    acceptance: {\r\n      company: client.clientName,\r\n      name: client.clientName,\r\n      signature: \"\",\r\n      date:\r\n        populatedProject.acceptanceDate?.toISOString() ||\r\n        new Date().toISOString(),\r\n    },\r\n    sitePictures:\r\n      workCompletion?.images.map((img) => ({\r\n        url: img.imageUrl,\r\n        title: img.title,\r\n        _id: img._id\r\n      })) || [],\r\n    project: {\r\n      _id: populatedProject._id.toString(),\r\n      projectName: populatedProject.projectName,\r\n    },\r\n    preparedBy: {\r\n      _id: populatedProject.createdBy._id.toString(),\r\n      firstName: populatedProject.createdBy.firstName,\r\n      lastName: populatedProject.createdBy.lastName,\r\n    },\r\n    createdAt:\r\n      workCompletion?.createdAt?.toISOString() || new Date().toISOString(),\r\n    updatedAt:\r\n      workCompletion?.updatedAt?.toISOString() || new Date().toISOString(),\r\n  };\r\n}\r\n\r\nexport const createWorkCompletion = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.body;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const project = await Project.findById(projectId);\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.create({\r\n      project: projectId,\r\n      completionNumber: await generateRelatedDocumentNumber(projectId, \"WCPAGA\"),\r\n      createdBy: req.user?.userId,\r\n    });\r\n\r\n    res\r\n      .status(201)\r\n      .json(\r\n        new ApiResponse(\r\n          201,\r\n          workCompletion,\r\n          \"Work completion created successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\nexport const replaceWorkCompletionImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId, imageId } = req.params;\r\n    const file = req.file as Express.Multer.File;\r\n\r\n    if (!projectId || !imageId) {\r\n      throw new ApiError(400, \"Project ID and image ID are required\");\r\n    }\r\n\r\n    if (!file) {\r\n      throw new ApiError(400, \"Image file is required\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId });\r\n    if (!workCompletion) {\r\n      throw new ApiError(404, \"Work completion not found\");\r\n    }\r\n\r\n    // Check if user is authorized to update this work completion\r\n    if (workCompletion.createdBy.toString() !== req.user?.userId.toString()) {\r\n      throw new ApiError(403, \"Not authorized to update this work completion\");\r\n    }\r\n\r\n    const imageIndex = workCompletion.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    const oldImage = workCompletion.images[imageIndex];\r\n\r\n    // Upload new image\r\n    const uploadResult = await uploadWorkCompletionImagesToS3([file]);\r\n\r\n    if (!uploadResult.success || !uploadResult.uploadData?.[0]) {\r\n      throw new ApiError(500, \"Failed to upload new image to S3\");\r\n    }\r\n\r\n    const newImageData = uploadResult.uploadData[0];\r\n\r\n    // Delete old image from S3\r\n    if (oldImage.s3Key) {\r\n      await deleteFileFromS3(oldImage.s3Key);\r\n    }\r\n\r\n    // Update image with new file\r\n    workCompletion.images[imageIndex].imageUrl = newImageData.url;\r\n    workCompletion.images[imageIndex].s3Key = newImageData.key;\r\n    workCompletion.images[imageIndex].uploadedAt = new Date();\r\n\r\n    await workCompletion.save();\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(200, updatedData, \"Image replaced successfully\")\r\n    );\r\n  }\r\n);\r\nexport const uploadWorkCompletionImages = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const files = req.files as Express.Multer.File[];\r\n    const { titles = [], descriptions = [] } = req.body;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    if (!files || files.length === 0) {\r\n      throw new ApiError(400, \"No images uploaded\");\r\n    }\r\n\r\n    if (!req.user?.userId) {\r\n      throw new ApiError(401, \"Unauthorized\");\r\n    }\r\n\r\n    const titlesArray: string[] = Array.isArray(titles) ? titles : [titles];\r\n    const descriptionsArray: string[] = Array.isArray(descriptions)\r\n      ? descriptions\r\n      : [descriptions];\r\n\r\n    if (titlesArray.length !== files.length) {\r\n      throw new ApiError(400, \"Number of titles must match number of images\");\r\n    }\r\n\r\n    if (titlesArray.some((title) => !title?.trim())) {\r\n      throw new ApiError(400, \"All images must have a non-empty title\");\r\n    }\r\n\r\n    let workCompletion = await WorkCompletion.findOne({ project: projectId });\r\n\r\n    if (!workCompletion) {\r\n      workCompletion = await WorkCompletion.create({\r\n        project: projectId,\r\n        createdBy: req.user.userId,\r\n        images: [],\r\n      });\r\n    } else if (\r\n      workCompletion.createdBy.toString() !== req.user.userId.toString()\r\n    ) {\r\n      throw new ApiError(403, \"Not authorized to update this work completion\");\r\n    }\r\n\r\n    const uploadResults = await uploadWorkCompletionImagesToS3(files);\r\n\r\n    if (!uploadResults.success || !uploadResults.uploadData) {\r\n      throw new ApiError(500, \"Failed to upload images to S3\");\r\n    }\r\n\r\n    const newImages: any[] = uploadResults.uploadData.map(\r\n      (fileData, index) => ({\r\n        _id: new Types.ObjectId(),\r\n        title: titlesArray[index],\r\n        imageUrl: fileData.url,\r\n        s3Key: fileData.key,\r\n        description: descriptionsArray[index] || \"\",\r\n        uploadedAt: new Date(),\r\n      })\r\n    );\r\n\r\n    workCompletion.images.push(...newImages);\r\n    await workCompletion.save();\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedData, \"Images uploaded successfully\"));\r\n  }\r\n);\r\nexport const updateWorkCompletionImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId, imageId } = req.params;\r\n    const { title } = req.body;\r\n\r\n    if (!projectId || !imageId) {\r\n      throw new ApiError(400, \"Project ID and image ID are required\");\r\n    }\r\n\r\n    if (!title?.trim()) {\r\n      throw new ApiError(400, \"Title is required and cannot be empty\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId });\r\n    if (!workCompletion) {\r\n      throw new ApiError(404, \"Work completion not found\");\r\n    }\r\n\r\n    // Check if user is authorized to update this work completion\r\n    if (workCompletion.createdBy.toString() !== req.user?.userId.toString()) {\r\n      throw new ApiError(403, \"Not authorized to update this work completion\");\r\n    }\r\n\r\n    const imageIndex = workCompletion.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    // Update only the title\r\n    workCompletion.images[imageIndex].title = title.trim();\r\n    await workCompletion.save();\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(200, updatedData, \"Image title updated successfully\")\r\n    );\r\n  }\r\n);\r\nexport const getWorkCompletion = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .sort({ createdAt: -1 });\r\n\r\n    if (!workCompletion) {\r\n      return res\r\n        .status(200)\r\n        .json(\r\n          new ApiResponse(\r\n            200,\r\n            null,\r\n            \"No work completion found for this project\"\r\n          )\r\n        );\r\n    }\r\n\r\n    const completionData = await getCompletionDataForProject(projectId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          completionData,\r\n          \"Work completion retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const deleteWorkCompletionImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { workCompletionId, imageId } = req.params;\r\n\r\n    if (!workCompletionId || !imageId) {\r\n      throw new ApiError(400, \"Work completion ID and image ID are required\");\r\n    }\r\n    let workCompletion = await WorkCompletion.findOne({ project: workCompletionId });\r\n    if (!workCompletion) {\r\n      throw new ApiError(404, \"Work completion not found\");\r\n    }\r\n\r\n    if (workCompletion.createdBy.toString() !== req.user?.userId) {\r\n      throw new ApiError(403, \"Not authorized to modify this work completion\");\r\n    }\r\n\r\n    const imageIndex = workCompletion.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    const imageToDelete = workCompletion.images[imageIndex];\r\n    const deleteResult = await deleteFileFromS3(imageToDelete.s3Key);\r\n\r\n    if (!deleteResult.success) {\r\n      throw new ApiError(500, \"Failed to delete image from S3\");\r\n    }\r\n\r\n    workCompletion.images.splice(imageIndex, 1);\r\n    await workCompletion.save();\r\n\r\n    const updatedData = await getCompletionDataForProject(\r\n      workCompletion.project.toString()\r\n    );\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedData, \"Image deleted successfully\"));\r\n  }\r\n);\r\n\r\nexport const getProjectWorkCompletionImages = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .sort({ createdAt: -1 });\r\n\r\n    if (!workCompletion) {\r\n      return res\r\n        .status(200)\r\n        .json(new ApiResponse(200, [], \"No work completion images found\"));\r\n    }\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          workCompletion.images,\r\n          \"Work completion images retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const getCompletionData = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const completionData = await getCompletionDataForProject(projectId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          completionData,\r\n          \"Completion data retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateCompletionDate = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { date } = req.body;\r\n\r\n    if (!projectId || !date) {\r\n      throw new ApiError(400, \"Project ID and date are required\");\r\n    }\r\n\r\n    const project = await Project.findByIdAndUpdate(\r\n      projectId,\r\n      { completionDate: new Date(date) },\r\n      { new: true }\r\n    );\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          updatedData,\r\n          \"Completion date updated successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateHandoverDate = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { date } = req.body;\r\n\r\n    if (!projectId || !date) {\r\n      throw new ApiError(400, \"Project ID and date are required\");\r\n    }\r\n\r\n    const project = await Project.findByIdAndUpdate(\r\n      projectId,\r\n      { handoverDate: new Date(date) },\r\n      { new: true }\r\n    );\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(200, updatedData, \"Handover date updated successfully\")\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateAcceptanceDate = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { date } = req.body;\r\n\r\n    if (!projectId || !date) {\r\n      throw new ApiError(400, \"Project ID and date are required\");\r\n    }\r\n\r\n    const project = await Project.findByIdAndUpdate(\r\n      projectId,\r\n      { acceptanceDate: new Date(date) },\r\n      { new: true }\r\n    );\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          updatedData,\r\n          \"Acceptance date updated successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\nexport const generateCompletionCertificatePdf = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    // Get all necessary data\r\n    const project = await Project.findById(projectId)\r\n      .populate(\"client\", \"clientName\")\r\n      .populate(\"assignedTo\", \"firstName lastName signatureImage\");\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const client = await Client.findById(project.client);\r\n    if (!client) {\r\n      throw new ApiError(404, \"Client not found\");\r\n    }\r\n\r\n    const lpo = await LPO.findOne({ project: projectId })\r\n      .sort({ createdAt: -1 })\r\n      .limit(1);\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName signatureImage\")\r\n      .sort({ createdAt: -1 });\r\n\r\n    const engineer: any = project.assignedTo;\r\n    const preparedBy: any = workCompletion?.createdBy;\r\n\r\n    // Format dates\r\n    const formatDate = (date: Date | string | undefined) => {\r\n      if (!date) return \"\";\r\n      const dateObj = typeof date === \"string\" ? new Date(date) : date;\r\n      return dateObj\r\n        .toLocaleDateString(\"en-GB\", {\r\n          day: \"2-digit\",\r\n          month: \"short\",\r\n          year: \"numeric\",\r\n        })\r\n        .replace(/ /g, \"-\");\r\n    };\r\n\r\n    // Prepare HTML content\r\n    const htmlContent = `\r\n    <!DOCTYPE html>\r\n    <html lang=\"en\">\r\n    <head>\r\n        <meta charset=\"UTF-8\">\r\n        <title>Completion Certificate</title>\r\n        <style>\r\n            @page {\r\n              size: A4;\r\n              margin: 0.5cm;\r\n            }\r\n            * {\r\n                box-sizing: border-box;\r\n            }\r\n            body {\r\n                font-family: 'Arial', sans-serif;\r\n                font-size: 11pt;\r\n                line-height: 1.4;\r\n                color: #333;\r\n                margin: 0;\r\n                padding: 0;\r\n            }\r\n            .container {\r\n                display: block;\r\n                width: 100%;\r\n                max-width: 100%;\r\n            }\r\n            .content {\r\n                margin-bottom: 15px;\r\n            }\r\n            .header {\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                margin-bottom: 15px;\r\n                gap: 20px;\r\n                page-break-after: avoid;\r\n                padding: 10px 0;\r\n                border-bottom: 3px solid #94d7f4;\r\n                position: relative;\r\n            }\r\n            .logo {\r\n                height: 50px;\r\n                width: auto;\r\n                max-width: 150px;\r\n                object-fit: contain;\r\n                position: absolute;\r\n                left: 0;\r\n             \r\n            }\r\n            .company-names {\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n                justify-content: center;\r\n                text-align: center;\r\n                flex-grow: 1;\r\n            }\r\n            .company-name-arabic {\r\n                font-size: 20pt;\r\n                font-weight: bold;\r\n                color: #1a1a1a;\r\n                line-height: 1.3;\r\n                direction: rtl;\r\n                unicode-bidi: bidi-override;\r\n                letter-spacing: 0;\r\n                margin-bottom: 5px;\r\n            }\r\n            .company-name-english {\r\n                font-size: 10pt;\r\n                font-weight: bold;\r\n                color: #1a1a1a;\r\n                line-height: 1.3;\r\n                letter-spacing: 0.08em;\r\n                text-transform: uppercase;\r\n            }\r\n            .certificate-title {\r\n                text-align: center;\r\n                font-size: 20pt;\r\n                font-weight: bold;\r\n                color: #2c3e50;\r\n                margin: 20px 0 15px 0;\r\n                text-transform: uppercase;\r\n                letter-spacing: 1.5px;\r\n                padding: 12px;\r\n                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\r\n                border-radius: 6px;\r\n                border-left: 4px solid #94d7f4;\r\n                border-right: 4px solid #94d7f4;\r\n            }\r\n            .section {\r\n                margin-bottom: 12px;\r\n                page-break-inside: avoid;\r\n            }\r\n            .section-title {\r\n                font-size: 11pt;\r\n                font-weight: bold;\r\n                padding: 4px 0;\r\n                margin: 12px 0 8px 0;\r\n                border-bottom: 2px solid #94d7f4;\r\n                page-break-after: avoid;\r\n                color: #2c3e50;\r\n            }\r\n            .info-table {\r\n                width: 100%;\r\n                border-collapse: collapse;\r\n                margin: 10px 0;\r\n                font-size: 10pt;\r\n            }\r\n            .info-table td {\r\n                padding: 6px 8px;\r\n                vertical-align: top;\r\n                line-height: 1.4;\r\n            }\r\n            .info-table .label {\r\n                font-weight: bold;\r\n                color: #2c3e50;\r\n                width: 30%;\r\n            }\r\n            .highlight {\r\n                padding: 2px 6px;\r\n                background-color: #f0f8ff;\r\n                border-radius: 3px;\r\n                font-weight: 600;\r\n            }\r\n            .certification-text {\r\n                margin: 15px 0;\r\n                padding: 12px 15px;\r\n                background-color: #f8f9fa;\r\n                border-left: 4px solid #94d7f4;\r\n                border-right: 4px solid #94d7f4;\r\n                border-radius: 4px;\r\n                font-size: 10.5pt;\r\n                line-height: 1.6;\r\n                color: #333;\r\n            }\r\n            table.signature-table {\r\n                width: 100%;\r\n                border-collapse: collapse;\r\n                margin: 10px 0;\r\n                font-size: 10pt;\r\n            }\r\n            .signature-table td {\r\n                padding: 10px 12px;\r\n                border: 1px solid #ddd;\r\n                vertical-align: middle;\r\n            }\r\n            .signature-table .header-row {\r\n                background-color: #94d7f4;\r\n                color: #000;\r\n                font-weight: bold;\r\n                text-align: center;\r\n                padding: 8px 12px;\r\n            }\r\n            .signature-table .label-row {\r\n                background-color: #f8f9fa;\r\n                font-weight: bold;\r\n                color: #2c3e50;\r\n                text-align: center;\r\n                padding: 8px 12px;\r\n            }\r\n            .signature-table .value-row {\r\n                text-align: center;\r\n                padding: 12px;\r\n            }\r\n            .signature-table td:nth-child(1) {\r\n                width: 30%;\r\n            }\r\n            .signature-table td:nth-child(2) {\r\n                width: 40%;\r\n            }\r\n            .signature-table td:nth-child(3) {\r\n                width: 30%;\r\n            }\r\n            .signature-img {\r\n                height: 50px;\r\n                max-width: 180px;\r\n                object-fit: contain;\r\n            }\r\n            .empty-signature {\r\n                height: 50px;\r\n                border: 1px dashed #ccc;\r\n                background-color: #f9f9f9;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                color: #999;\r\n                font-size: 9pt;\r\n            }\r\n            .signature-name {\r\n                font-weight: 600;\r\n                color: #2c3e50;\r\n            }\r\n            .green-text {\r\n                color: #228B22;\r\n                font-weight: bold;\r\n            }\r\n            \r\n            /* ==================== IMAGE SECTION (FIXED - NO BREAK PROBLEMS) ==================== */\r\n            \r\n            .images-section {\r\n                margin-top: 15px;\r\n                /* REMOVED: page-break-inside: avoid - Let it break naturally */\r\n            }\r\n            \r\n            .images-grid {\r\n                display: block;\r\n                margin-top: 8px;\r\n                /* REMOVED: page-break-inside rules - Let it flow naturally */\r\n            }\r\n            \r\n            .images-row {\r\n                display: flex;\r\n                gap: 12px;\r\n                margin-bottom: 12px;\r\n                /* REMOVED ALL page-break rules - Let rows break naturally between pages */\r\n                min-height: 140px; /* Ensure minimum height for better breaking */\r\n            }\r\n            \r\n            .image-item {\r\n                flex: 1;\r\n                min-width: calc(33.333% - 8px);\r\n                max-width: calc(33.333% - 8px);\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n                /* REMOVED: page-break-inside: avoid - Let items break naturally */\r\n                border: 1px solid #ddd;\r\n                border-radius: 6px;\r\n                padding: 8px;\r\n                background: #fafafa;\r\n                min-height: 140px;\r\n                box-sizing: border-box;\r\n                /* Allow breaking inside image items if needed */\r\n                page-break-inside: auto;\r\n            }\r\n            \r\n            .image-container {\r\n                width: 100%;\r\n                height: 140px;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                overflow: hidden;\r\n                margin-bottom: 6px;\r\n                background: #fff;\r\n                border-radius: 4px;\r\n                /* Prevent images from breaking */\r\n                page-break-inside: avoid;\r\n                break-inside: avoid;\r\n            }\r\n            \r\n            .image-container img {\r\n                max-height: 100%;\r\n                max-width: 100%;\r\n                object-fit: contain;\r\n                /* Ensure images don't break */\r\n                page-break-inside: avoid;\r\n                break-inside: avoid;\r\n            }\r\n            \r\n            .image-title {\r\n                font-size: 8.5pt;\r\n                font-weight: 600;\r\n                text-align: center;\r\n                color: #2c3e50;\r\n                line-height: 1.2;\r\n                margin: 0;\r\n                word-break: break-word;\r\n                max-height: 28px;\r\n                overflow: hidden;\r\n                display: -webkit-box;\r\n                -webkit-line-clamp: 2;\r\n                -webkit-box-orient: vertical;\r\n                /* Allow title to break with the image */\r\n                page-break-inside: auto;\r\n            }\r\n            \r\n            .tagline {\r\n                text-align: center;\r\n                font-weight: bold;\r\n                font-size: 11pt;\r\n               \r\n                color: #2c3e50;\r\n                border-top: 2px solid #ddd;\r\n                padding-top: 10px;\r\n                page-break-before: avoid;\r\n            }\r\n            .footer {\r\n                font-size: 8.5pt;\r\n                color: #555;\r\n                text-align: center;\r\n                margin-top: 8px;\r\n                page-break-inside: avoid;\r\n                line-height: 1.3;\r\n            }\r\n            .footer p {\r\n                margin: 4px 0;\r\n            }\r\n            .footer strong {\r\n                color: #2c3e50;\r\n            }\r\n            @media print {\r\n                body {\r\n                    font-size: 10pt;\r\n                }\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div class=\"container\">\r\n            <div class=\"content\">\r\n                <div class=\"header\">\r\n                    <img class=\"logo\" src=\"https://agats.s3.ap-south-1.amazonaws.com/logo/alghlogo.jpg\" alt=\"Company Logo\">\r\n                    <div class=\"company-names\">\r\n                        <div class=\"company-name-arabic\">الغزال الأبيض للخدمات الفنية</div>\r\n                        <div class=\"company-name-english\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div class=\"certificate-title\">Completion Certificate</div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"info-table\">\r\n                        <tr>\r\n                            <td class=\"label\">Reference</td>\r\n                            <td>: <span class=\"\">${`QTN${project.projectNumber.slice(3, 40)}`}</span></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">FM CONTRACTOR</td>\r\n                            <td>:&nbsp;${client.clientName}</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">SUB CONTRACTOR</td>\r\n                            <td>:&nbsp; AL GHAZAL ALABYAD TECHNICAL SERVICES</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">PROJECT DESCRIPTION</td>\r\n                            <td>: <span class=\"\">${project.projectName}</span></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">LOCATION (Bldg.)</td>\r\n                            <td>: <span class=\"\">${project.location}${project.building ? `, ${project.building}` : \"\"}</span></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <div class=\"certification-text\">\r\n                    This is to certify that the work described above in the project description has been cleared out and completed to the required standards and specifications.\r\n                </div>\r\n\r\n                <div class=\"section\">\r\n                    <table class=\"info-table\">\r\n                        <tr>\r\n                            <td class=\"label\">Completion Date</td>\r\n                            <td>: <span class=\"highlight\">${formatDate(project.completionDate)}</span></td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">LPO Number</td>\r\n                            <td>: ${lpo?.lpoNumber || \"N/A\"}</td>\r\n                        </tr>\r\n                        <tr>\r\n                            <td class=\"label\">LPO Date</td>\r\n                            <td>: ${formatDate(lpo?.lpoDate)}</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n               \r\n\r\n               \r\n\r\n                <div class=\"section\">\r\n                    <table class=\"signature-table\">\r\n                        <tr>\r\n                            <td colspan=\"3\" class=\"header-row\">Prepared by: AL GHAZAL AL ABYAD TECHNICAL SERVICES</td>\r\n                        </tr>\r\n                        <tr class=\"label-row\">\r\n                            <td>Name</td>\r\n                            <td>Signature</td>\r\n                            <td>Date</td>\r\n                        </tr>\r\n                        <tr class=\"value-row\">\r\n                            <td>${preparedBy?.firstName || \"\"} ${preparedBy?.lastName || \"\"}</td>\r\n                            <td>\r\n                                ${preparedBy?.signatureImage ? `<img src=\"${preparedBy.signatureImage}\" class=\"signature-img\" />` : '<div class=\"empty-signature\">Signature</div>'}\r\n                            </td>\r\n                            <td><span class=\"green-text\">${formatDate(project.handoverDate)}</span></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                 <div class=\"section\">\r\n                    <table class=\"signature-table\">\r\n                        <tr>\r\n                            <td colspan=\"3\" class=\"header-row\">Hand over by: AL GHAZAL AL ABYAD TECHNICAL SERVICES</td>\r\n                        </tr>\r\n                        <tr class=\"label-row\">\r\n                            <td>Name</td>\r\n                            <td>Signature</td>\r\n                            <td>Date</td>\r\n                        </tr>\r\n                        <tr class=\"value-row\">\r\n                            <td>${engineer?.firstName} ${engineer?.lastName || \"\"}</td>\r\n                            <td>\r\n                                ${engineer?.signatureImage ? `<img src=\"${engineer.signatureImage}\" class=\"signature-img\" />` : '<div class=\"empty-signature\">Signature</div>'}\r\n                            </td>\r\n                            <td><span class=\"green-text\">${formatDate(project.handoverDate)}</span></td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n                 <div class=\"section\">\r\n                    <table class=\"signature-table\">\r\n                        <tr>\r\n                            <td colspan=\"3\" class=\"header-row\">Accepted by: Client side</td>\r\n                        </tr>\r\n                        <tr class=\"label-row\">\r\n                            <td>Name</td>\r\n                            <td>Signature</td>\r\n                            <td>Date</td>\r\n                        </tr>\r\n                        <tr class=\"value-row\">\r\n                            <td>${client.clientName}</td>\r\n                            <td>\r\n                                <div class=\"empty-signature\">Client Signature</div>\r\n                            </td>\r\n                            <td>${formatDate(project.acceptanceDate)}</td>\r\n                        </tr>\r\n                    </table>\r\n                </div>\r\n\r\n                <!-- IMAGES SECTION -->\r\n                ${workCompletion?.images && workCompletion.images.length > 0 ? `\r\n                  <div class=\"images-section\">\r\n                    <div class=\"section-title\">Site Pictures</div>\r\n                    <div class=\"images-grid\">\r\n                      ${(() => {\r\n          let html = '';\r\n          for (let i = 0; i < workCompletion.images.length; i += 3) {\r\n            const rowImages = workCompletion.images.slice(i, i + 3);\r\n            html += '<div class=\"images-row\">';\r\n\r\n            for (let j = 0; j < 3; j++) {\r\n              if (j < rowImages.length) {\r\n                const image = rowImages[j];\r\n                html += `\r\n                                <div class=\"image-item\">\r\n                                  <div class=\"image-container\">\r\n                                    <img src=\"${image.imageUrl}\" alt=\"${image.title || \"Site picture\"}\" />\r\n                                  </div>\r\n                                  <div class=\"image-title\">${image.title || \"Site Image\"}</div>\r\n                                </div>\r\n                              `;\r\n              } else {\r\n                html += `\r\n                                <div class=\"image-item\" style=\"visibility: hidden;\">\r\n                                  <div class=\"image-container\"></div>\r\n                                  <div class=\"image-title\"></div>\r\n                                </div>\r\n                              `;\r\n              }\r\n            }\r\n            html += '</div>';\r\n          }\r\n          return html;\r\n        })()}\r\n                    </div>\r\n                  </div>\r\n                  ` : `\r\n                  <div class=\"section\">\r\n                    <div class=\"section-title\">Site Pictures</div>\r\n                    <p style=\"text-align: center; font-size: 10pt; color: #666; padding: 20px;\">No site pictures available</p>\r\n                  </div>\r\n                  `\r\n      }\r\n            </div>\r\n\r\n            <div class=\"tagline\">We work U Relax</div>\r\n            <div class=\"footer\">\r\n                <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n                <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n                <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n                <p>Generated on ${formatDate(new Date())}</p>\r\n            </div>\r\n        </div>\r\n    </body>\r\n    </html>\r\n    `;\r\n\r\n    // Generate PDF\r\n    const browser = await puppeteer.launch({\r\n      headless: \"shell\",\r\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--font-render-hinting=none\"],\r\n    });\r\n\r\n    try {\r\n      const page = await browser.newPage();\r\n\r\n      await page.setViewport({ width: 1200, height: 1600 });\r\n\r\n      await page.setContent(htmlContent, {\r\n        waitUntil: [\"networkidle0\", \"domcontentloaded\"],\r\n        timeout: 30000,\r\n      });\r\n\r\n      const pdfBuffer = await page.pdf({\r\n        format: \"A4\",\r\n        printBackground: true,\r\n        margin: {\r\n          top: \"0.5cm\",\r\n          right: \"0.5cm\",\r\n          bottom: \"0.5cm\",\r\n          left: \"0.5cm\",\r\n        },\r\n        preferCSSPageSize: true,\r\n        displayHeaderFooter: false,\r\n      });\r\n\r\n      res.setHeader(\"Content-Type\", \"application/pdf\");\r\n      res.setHeader(\r\n        \"Content-Disposition\",\r\n        `attachment; filename=completion-certificate-${project.projectNumber}.pdf`\r\n      );\r\n      res.send(pdfBuffer);\r\n    } finally {\r\n      await browser.close();\r\n    }\r\n  }\r\n);"]}