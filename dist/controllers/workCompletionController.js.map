{"version":3,"file":"workCompletionController.js","sourceRoot":"","sources":["../../src/controllers/workCompletionController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport {\r\n  IWorkCompletionImage,\r\n  WorkCompletion,\r\n} from \"../models/workCompletionModel\";\r\nimport { IProject, Project } from \"../models/projectModel\";\r\nimport {\r\n  uploadWorkCompletionImagesToS3,\r\n  deleteFileFromS3,\r\n} from \"../utils/uploadConf\";\r\nimport { Client, IClient } from \"../models/clientModel\";\r\nimport { LPO } from \"../models/lpoModel\";\r\nimport { generateRelatedDocumentNumber } from \"../utils/documentNumbers\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { IUser, User } from \"../models/userModel\";\r\nimport { Types } from \"mongoose\";\r\n\r\n// Helper function to get completion data\r\nasync function getCompletionDataForProject(projectId: string) {\r\n  type PopulatedProject = Omit<\r\n    IProject,\r\n    \"client\" | \"assignedTo\" | \"createdBy\"\r\n  > & {\r\n    client: IClient;\r\n    assignedTo?: IUser;\r\n    createdBy: IUser;\r\n  };\r\n\r\n  const project = await Project.findById(projectId)\r\n    .populate<{ client: IClient }>(\"client\", \"clientName\")\r\n    .populate<{ assignedTo: IUser }>(\"assignedTo\", \"firstName lastName\")\r\n    .populate<{ createdBy: IUser }>(\"createdBy\", \"firstName lastName\");\r\n\r\n  if (!project) {\r\n    throw new ApiError(404, \"Project not found\");\r\n  }\r\n\r\n  const populatedProject = project as unknown as PopulatedProject;\r\n  const client = populatedProject.client;\r\n  const lpo = await LPO.findOne({ project: projectId })\r\n    .sort({ createdAt: -1 })\r\n    .limit(1);\r\n  const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n    .populate(\"createdBy\", \"firstName lastName\")\r\n    .sort({ createdAt: -1 });\r\n\r\n  return {\r\n    _id: populatedProject._id.toString(),\r\n    referenceNumber: `COMP-${populatedProject._id\r\n      .toString()\r\n      .slice(-6)\r\n      .toUpperCase()}`,\r\n    fmContractor: \"Al Ghazal Al Abyad Technical Services\",\r\n    subContractor: client.clientName,\r\n    projectDescription:\r\n      populatedProject.projectDescription || \"No description provided\",\r\n    location: `${populatedProject.location}, ${populatedProject.building}, ${populatedProject.apartmentNumber}`,\r\n    completionDate:\r\n      populatedProject.completionDate?.toISOString() ||\r\n      populatedProject.updatedAt?.toISOString() ||\r\n      new Date().toISOString(),\r\n    lpoNumber: lpo?.lpoNumber || \"Not available\",\r\n    lpoDate: lpo?.lpoDate?.toISOString() || \"Not available\",\r\n    handover: {\r\n      company: \"AL GHAZAL AL ABYAD TECHNICAL SERVICES\",\r\n      name: populatedProject.assignedTo\r\n        ? `${populatedProject.assignedTo.firstName} ${populatedProject.assignedTo.lastName}`\r\n        : \"Not assigned\",\r\n      signature: \"\",\r\n      date:\r\n        populatedProject.handoverDate?.toISOString() ||\r\n        populatedProject.updatedAt?.toISOString() ||\r\n        new Date().toISOString(),\r\n    },\r\n    acceptance: {\r\n      company: client.clientName,\r\n      name: client.clientName,\r\n      signature: \"\",\r\n      date:\r\n        populatedProject.acceptanceDate?.toISOString() ||\r\n        new Date().toISOString(),\r\n    },\r\n    sitePictures:\r\n      workCompletion?.images.map((img) => ({\r\n        url: img.imageUrl,\r\n        caption: img.title,\r\n      })) || [],\r\n    project: {\r\n      _id: populatedProject._id.toString(),\r\n      projectName: populatedProject.projectName,\r\n    },\r\n    preparedBy: {\r\n      _id: populatedProject.createdBy._id.toString(),\r\n      firstName: populatedProject.createdBy.firstName,\r\n      lastName: populatedProject.createdBy.lastName,\r\n    },\r\n    createdAt:\r\n      workCompletion?.createdAt?.toISOString() || new Date().toISOString(),\r\n    updatedAt:\r\n      workCompletion?.updatedAt?.toISOString() || new Date().toISOString(),\r\n  };\r\n}\r\n\r\nexport const createWorkCompletion = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.body;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const project = await Project.findById(projectId);\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.create({\r\n      project: projectId,\r\n      completionNumber: await generateRelatedDocumentNumber(projectId, \"WCPAGA\"),\r\n      createdBy: req.user?.userId,\r\n    });\r\n\r\n    res\r\n      .status(201)\r\n      .json(\r\n        new ApiResponse(\r\n          201,\r\n          workCompletion,\r\n          \"Work completion created successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const uploadWorkCompletionImages = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const files = req.files as Express.Multer.File[];\r\n    const { titles = [], descriptions = [] } = req.body;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    if (!files || files.length === 0) {\r\n      throw new ApiError(400, \"No images uploaded\");\r\n    }\r\n\r\n    if (!req.user?.userId) {\r\n      throw new ApiError(401, \"Unauthorized\");\r\n    }\r\n\r\n    const titlesArray: string[] = Array.isArray(titles) ? titles : [titles];\r\n    const descriptionsArray: string[] = Array.isArray(descriptions)\r\n      ? descriptions\r\n      : [descriptions];\r\n\r\n    if (titlesArray.length !== files.length) {\r\n      throw new ApiError(400, \"Number of titles must match number of images\");\r\n    }\r\n\r\n    if (titlesArray.some((title) => !title?.trim())) {\r\n      throw new ApiError(400, \"All images must have a non-empty title\");\r\n    }\r\n\r\n    let workCompletion = await WorkCompletion.findOne({ project: projectId });\r\n\r\n    if (!workCompletion) {\r\n      workCompletion = await WorkCompletion.create({\r\n        project: projectId,\r\n        createdBy: req.user.userId,\r\n        images: [],\r\n      });\r\n    } else if (\r\n      workCompletion.createdBy.toString() !== req.user.userId.toString()\r\n    ) {\r\n      throw new ApiError(403, \"Not authorized to update this work completion\");\r\n    }\r\n\r\n    const uploadResults = await uploadWorkCompletionImagesToS3(files);\r\n\r\n    if (!uploadResults.success || !uploadResults.uploadData) {\r\n      throw new ApiError(500, \"Failed to upload images to S3\");\r\n    }\r\n\r\n    const newImages: any[] = uploadResults.uploadData.map(\r\n      (fileData, index) => ({\r\n        _id: new Types.ObjectId(),\r\n        title: titlesArray[index],\r\n        imageUrl: fileData.url,\r\n        s3Key: fileData.key,\r\n        description: descriptionsArray[index] || \"\",\r\n        uploadedAt: new Date(),\r\n      })\r\n    );\r\n\r\n    workCompletion.images.push(...newImages);\r\n    await workCompletion.save();\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedData, \"Images uploaded successfully\"));\r\n  }\r\n);\r\n\r\nexport const getWorkCompletion = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .sort({ createdAt: -1 });\r\n\r\n    if (!workCompletion) {\r\n      return res\r\n        .status(200)\r\n        .json(\r\n          new ApiResponse(\r\n            200,\r\n            null,\r\n            \"No work completion found for this project\"\r\n          )\r\n        );\r\n    }\r\n\r\n    const completionData = await getCompletionDataForProject(projectId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          completionData,\r\n          \"Work completion retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const deleteWorkCompletionImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { workCompletionId, imageId } = req.params;\r\n\r\n    if (!workCompletionId || !imageId) {\r\n      throw new ApiError(400, \"Work completion ID and image ID are required\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findById(workCompletionId);\r\n    if (!workCompletion) {\r\n      throw new ApiError(404, \"Work completion not found\");\r\n    }\r\n\r\n    if (workCompletion.createdBy.toString() !== req.user?.userId) {\r\n      throw new ApiError(403, \"Not authorized to modify this work completion\");\r\n    }\r\n\r\n    const imageIndex = workCompletion.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    const imageToDelete = workCompletion.images[imageIndex];\r\n    const deleteResult = await deleteFileFromS3(imageToDelete.s3Key);\r\n\r\n    if (!deleteResult.success) {\r\n      throw new ApiError(500, \"Failed to delete image from S3\");\r\n    }\r\n\r\n    workCompletion.images.splice(imageIndex, 1);\r\n    await workCompletion.save();\r\n\r\n    const updatedData = await getCompletionDataForProject(\r\n      workCompletion.project.toString()\r\n    );\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedData, \"Image deleted successfully\"));\r\n  }\r\n);\r\n\r\nexport const getProjectWorkCompletionImages = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .sort({ createdAt: -1 });\r\n\r\n    if (!workCompletion) {\r\n      return res\r\n        .status(200)\r\n        .json(new ApiResponse(200, [], \"No work completion images found\"));\r\n    }\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          workCompletion.images,\r\n          \"Work completion images retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const getCompletionData = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    const completionData = await getCompletionDataForProject(projectId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          completionData,\r\n          \"Completion data retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateCompletionDate = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { date } = req.body;\r\n\r\n    if (!projectId || !date) {\r\n      throw new ApiError(400, \"Project ID and date are required\");\r\n    }\r\n\r\n    const project = await Project.findByIdAndUpdate(\r\n      projectId,\r\n      { completionDate: new Date(date) },\r\n      { new: true }\r\n    );\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          updatedData,\r\n          \"Completion date updated successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateHandoverDate = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { date } = req.body;\r\n\r\n    if (!projectId || !date) {\r\n      throw new ApiError(400, \"Project ID and date are required\");\r\n    }\r\n\r\n    const project = await Project.findByIdAndUpdate(\r\n      projectId,\r\n      { handoverDate: new Date(date) },\r\n      { new: true }\r\n    );\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(200, updatedData, \"Handover date updated successfully\")\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateAcceptanceDate = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const { date } = req.body;\r\n\r\n    if (!projectId || !date) {\r\n      throw new ApiError(400, \"Project ID and date are required\");\r\n    }\r\n\r\n    const project = await Project.findByIdAndUpdate(\r\n      projectId,\r\n      { acceptanceDate: new Date(date) },\r\n      { new: true }\r\n    );\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const updatedData = await getCompletionDataForProject(projectId);\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          updatedData,\r\n          \"Acceptance date updated successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\nexport const generateCompletionCertificatePdf = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    if (!projectId) {\r\n      throw new ApiError(400, \"Project ID is required\");\r\n    }\r\n\r\n    // Get all necessary data\r\n    const project = await Project.findById(projectId)\r\n      .populate(\"client\", \"clientName\")\r\n      .populate(\"assignedTo\", \"firstName lastName signatureImage\");\r\n\r\n    if (!project) {\r\n      throw new ApiError(404, \"Project not found\");\r\n    }\r\n\r\n    const client = await Client.findById(project.client);\r\n    if (!client) {\r\n      throw new ApiError(404, \"Client not found\");\r\n    }\r\n\r\n    const lpo = await LPO.findOne({ project: projectId })\r\n      .sort({ createdAt: -1 })\r\n      .limit(1);\r\n\r\n    const workCompletion = await WorkCompletion.findOne({ project: projectId })\r\n      .populate(\"createdBy\", \"firstName lastName signatureImage\")\r\n      .sort({ createdAt: -1 });\r\n\r\n    const engineer: any = project.assignedTo;\r\n    // Add type assertion or safe access for workCompletion.createdBy\r\n    const preparedBy: any = workCompletion?.createdBy;\r\n\r\n    // Format dates - updated to use project dates\r\n    const formatDate = (date: Date | string | undefined) => {\r\n      if (!date) return \"\";\r\n      const dateObj = typeof date === \"string\" ? new Date(date) : date;\r\n      return dateObj\r\n        .toLocaleDateString(\"en-GB\", {\r\n          day: \"2-digit\",\r\n          month: \"short\",\r\n          year: \"numeric\",\r\n        })\r\n        .replace(/ /g, \"-\");\r\n    };\r\n\r\n    // Prepare HTML content with optimized spacing\r\n    const htmlContent = `\r\n    <!DOCTYPE html>\r\n    <html lang=\"en\">\r\n    <head>\r\n        <meta charset=\"UTF-8\">\r\n        <title>Completion Certificate</title>\r\n        <style>\r\n            @page {\r\n              size: A4;\r\n              margin: 0.5in;\r\n            }\r\n            body {\r\n                font-family: Arial, sans-serif;\r\n                margin: 0;\r\n                padding: 0;\r\n                color: #000;\r\n                border: 1px solid #000;\r\n                font-size: 11pt; /* Base font size increased */\r\n                line-height: 1.5; /* Better line height */\r\n            }\r\n            .container {\r\n                width: 96%;\r\n                margin: 0 auto;\r\n                padding: 15px;\r\n                padding-bottom: 60px; /* Reduced space for footer */\r\n            }\r\n            .header {\r\n                display: flex;\r\n                align-items: center;\r\n                margin-bottom: 15px;\r\n                border-bottom: 2px solid #94d7f4;\r\n                padding-bottom: 15px;\r\n            }\r\n            .logo {\r\n                max-height: 70px; /* Slightly larger logo */\r\n                margin-right: 25px;\r\n            }\r\n            .title-container {\r\n                flex-grow: 1;\r\n                text-align: end;\r\n            }\r\n            h1 {\r\n                color: #800080; /* Purple color */\r\n                font-size: 28px; /* Larger title */\r\n                font-weight: bold;\r\n                margin: 0;\r\n                text-transform: uppercase;\r\n                letter-spacing: 1px;\r\n            }\r\n            .highlight {\r\n                padding: 2px 6px;\r\n                background-color: #f0f8ff; /* Light blue background */\r\n                border-radius: 3px;\r\n                font-weight: 600;\r\n            }\r\n            table {\r\n                width: 100%;\r\n                border-collapse: collapse;\r\n                margin: 12px 0;\r\n                font-size: 11pt; /* Better table font size */\r\n            }\r\n            td {\r\n                padding: 8px 10px; /* More padding */\r\n                vertical-align: top;\r\n                line-height: 1.4;\r\n            }\r\n            .bordered {\r\n                border: 1px solid #000;\r\n                margin: 15px 0;\r\n            }\r\n            .bordered td {\r\n                border: 1px solid #000;\r\n            }\r\n            .bold {\r\n                font-weight: bold;\r\n                color: #2c3e50; /* Darker color for better readability */\r\n            }\r\n            .section-title {\r\n                margin: 20px 0 8px 0;\r\n                font-weight: bold;\r\n                font-size: 14pt; /* Larger section titles */\r\n                color: #2c3e50;\r\n                border-bottom: 1px solid #94d7f4;\r\n                padding-bottom: 5px;\r\n            }\r\n            .signature-img {\r\n                height: 50px; /* Larger signature images */\r\n                max-width: 180px;\r\n                object-fit: contain;\r\n            }\r\n            .green-text {\r\n                color: #228B22; /* Forest green */\r\n                font-weight: bold;\r\n                font-size: 11pt;\r\n            }\r\n            .blue-bg {\r\n                background-color: #94d7f4; /* Consistent with other PDFs */\r\n                color: #000;\r\n                font-weight: bold;\r\n                padding: 8px 12px;\r\n                font-size: 12pt; /* Larger header text */\r\n                text-align: center;\r\n            }\r\n            .image-container {\r\n                display: flex;\r\n                flex-wrap: wrap;\r\n                gap: 12px;\r\n                margin: 15px 0 10px 0;\r\n                justify-content: center;\r\n            }\r\n            .image-item {\r\n                display: flex;\r\n                flex-direction: column;\r\n                align-items: center;\r\n                flex-grow: 1;\r\n                max-width: 200px; /* Slightly larger images */\r\n                margin-bottom: 15px;\r\n            }\r\n            .image-item img {\r\n                height: 120px; /* Larger images */\r\n                width: 100%;\r\n                border: 1px solid #ddd;\r\n                object-fit: cover;\r\n                margin-bottom: 8px;\r\n                border-radius: 4px;\r\n            }\r\n            .image-title {\r\n                font-size: 10.5pt; /* Better font size */\r\n                font-weight: 600;\r\n                text-align: center;\r\n                color: #333;\r\n                word-wrap: break-word;\r\n                width: 100%;\r\n                padding: 4px 6px;\r\n                background-color: #f8f9fa;\r\n                border-radius: 3px;\r\n            }\r\n            .footer-container {\r\n                margin-top: 25px;\r\n                width: 96%;\r\n                margin-left: auto;\r\n                margin-right: auto;\r\n                page-break-inside: avoid;\r\n            }\r\n            .tagline {\r\n                text-align: center;\r\n                font-weight: bold;\r\n                font-size: 13pt; /* Consistent with other PDFs */\r\n                margin: 15px 0 10px 0;\r\n                color: #2c3e50;\r\n            }\r\n            .footer {\r\n                text-align: center;\r\n                font-size: 10pt; /* Better footer font size */\r\n                color: #555;\r\n                border-top: 2px solid #ddd;\r\n                padding-top: 12px;\r\n                margin-top: 10px;\r\n                line-height: 1.6;\r\n            }\r\n            .footer p {\r\n                margin: 6px 0;\r\n            }\r\n            .footer strong {\r\n                color: #2c3e50;\r\n                font-size: 10.5pt;\r\n            }\r\n            .certification-text {\r\n                margin: 15px 0;\r\n                padding: 12px 15px;\r\n                background-color: #f8f9fa;\r\n                border-left: 4px solid #94d7f4;\r\n                border-radius: 4px;\r\n                font-size: 11.5pt; /* Better text size */\r\n                line-height: 1.6;\r\n                color: #333;\r\n            }\r\n            .signature-section {\r\n                margin: 5px 0;\r\n            }\r\n            .signature-name {\r\n                font-weight: 600;\r\n                color: #2c3e50;\r\n                margin-top: 5px;\r\n            }\r\n            .empty-signature {\r\n                height: 50px;\r\n                border: 1px dashed #ccc;\r\n                background-color: #f9f9f9;\r\n                display: flex;\r\n                align-items: center;\r\n                justify-content: center;\r\n                color: #999;\r\n                font-size: 10pt;\r\n            }\r\n            /* Improved table row styling */\r\n            .bordered tr:nth-child(even) {\r\n                background-color: #f8f9fa;\r\n            }\r\n            .bordered tr:hover {\r\n                background-color: #e9f7fe;\r\n            }\r\n            /* Certificate border styling */\r\n            body {\r\n                border: 2px solid #800080; /* Purple border to match title */\r\n                background: linear-gradient(white, white) padding-box,\r\n                            linear-gradient(135deg, #94d7f4, #800080) border-box;\r\n                border: 2px solid transparent;\r\n                background-clip: padding-box, border-box;\r\n            }\r\n        </style>\r\n    </head>\r\n    <body>\r\n        <div class=\"container\">\r\n            <div class=\"header\">\r\n                <img src=\"https://agats.s3.ap-south-1.amazonaws.com/logo/alghlogo.jpg\" alt=\"Company Logo\" class=\"logo\">\r\n                <div class=\"title-container\">\r\n                    <h1>Completion Certificate</h1>\r\n                </div>\r\n            </div>\r\n\r\n            <table>\r\n                <tr>\r\n                    <td class=\"bold\" style=\"width: 30%\">Reference</td>\r\n                    <td>: <span class=\"highlight\">${\r\n                      `QTN${project.projectNumber.slice(3,40)}`\r\n                    }</span></td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">FM CONTRACTOR</td>\r\n                    <td>: ${client.clientName}</td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">SUB CONTRACTOR</td>\r\n                    <td>: AL GHAZAL ALABYAD TECHNICAL SERVICES</td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">PROJECT DESCRIPTION</td>\r\n                    <td>: <span class=\"highlight\">${\r\n                      project.projectName\r\n                    }</span></td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">LOCATION (Bldg.)</td>\r\n                    <td>: <span class=\"highlight\">${project.location}${\r\n      project.building ? `, ${project.building}` : \"\"\r\n    }</span></td>\r\n                </tr>\r\n            </table>\r\n\r\n            <div class=\"certification-text\">\r\n                This is to certify that the work described above in the project description has been cleared out and completed to the required standards and specifications.\r\n            </div>\r\n\r\n            <table>\r\n                <tr>\r\n                    <td class=\"bold\" style=\"width: 30%\">Completion Date</td>\r\n                    <td>: <span class=\"highlight\">${formatDate(\r\n                      project.completionDate\r\n                    )}</span></td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">LPO Number</td>\r\n                    <td>: ${lpo?.lpoNumber || \"N/A\"}</td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">LPO Date</td>\r\n                    <td>: ${formatDate(lpo?.lpoDate)}</td>\r\n                </tr>\r\n            </table>\r\n\r\n            <table class=\"bordered\">\r\n                <tr>\r\n                    <td colspan=\"2\" class=\"blue-bg\">Hand over by:</td>\r\n                    <td colspan=\"2\" class=\"blue-bg\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\" style=\"width: 25%\">Name:</td>\r\n                    <td style=\"width: 25%\" class=\"signature-name\">${engineer?.firstName} ${\r\n      engineer?.lastName || \"\"\r\n    }</td>\r\n                    <td class=\"bold\" style=\"width: 25%\">Signature:</td>\r\n                    <td style=\"width: 25%\" class=\"signature-section\">\r\n                        ${\r\n                          engineer?.signatureImage\r\n                            ? `<img src=\"${engineer.signatureImage}\" class=\"signature-img\" />`\r\n                            : '<div class=\"empty-signature\">Signature</div>'\r\n                        }\r\n                    </td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">Date:</td>\r\n                    <td><span class=\"green-text\">${formatDate(\r\n                      project.handoverDate\r\n                    )}</span></td>\r\n                    <td></td>\r\n                    <td></td>\r\n                </tr>\r\n            </table>\r\n\r\n            <table class=\"bordered\">\r\n                <tr>\r\n                    <td colspan=\"2\" class=\"blue-bg\">Accepted by:</td>\r\n                    <td colspan=\"2\" class=\"blue-bg\">Client side</td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\" style=\"width: 25%\">Name:</td>\r\n                    <td style=\"width: 25%\" class=\"signature-name\">${client.clientName}</td>\r\n                    <td class=\"bold\" style=\"width: 25%\">Signature:</td>\r\n                    <td style=\"width: 25%\" class=\"signature-section\">\r\n                        <div class=\"empty-signature\">Client Signature</div>\r\n                    </td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">Date:</td>\r\n                    <td>${formatDate(project.acceptanceDate)}</td>\r\n                    <td></td>\r\n                    <td></td>\r\n                </tr>\r\n            </table>\r\n\r\n            <table class=\"bordered\">\r\n                <tr>\r\n                    <td colspan=\"2\" class=\"blue-bg\">Prepared by:</td>\r\n                    <td colspan=\"2\" class=\"blue-bg\">AL GHAZAL AL ABYAD TECHNICAL SERVICES</td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\" style=\"width: 25%\">Name:</td>\r\n                    <td style=\"width: 25%\" class=\"signature-name\">${preparedBy?.firstName || \"\"} ${\r\n      preparedBy?.lastName || \"\"\r\n    }</td>\r\n                    <td class=\"bold\" style=\"width: 25%\">Signature:</td>\r\n                    <td style=\"width: 25%\" class=\"signature-section\">\r\n                        ${\r\n                          preparedBy?.signatureImage\r\n                            ? `<img src=\"${preparedBy.signatureImage}\" class=\"signature-img\" />`\r\n                            : '<div class=\"empty-signature\">Signature</div>'\r\n                        }\r\n                    </td>\r\n                </tr>\r\n                <tr>\r\n                    <td class=\"bold\">Date:</td>\r\n                    <td><span class=\"green-text\">${formatDate(\r\n                      project.handoverDate\r\n                    )}</span></td>\r\n                    <td></td>\r\n                    <td></td>\r\n                </tr>\r\n            </table>\r\n\r\n            <div class=\"section-title\">Site Pictures:</div>\r\n            <div class=\"image-container\">\r\n                ${\r\n                  workCompletion?.images && workCompletion.images.length > 0\r\n                    ? workCompletion.images\r\n                        .map(\r\n                          (image) =>\r\n                            `<div class=\"image-item\">\r\n                               <img src=\"${image.imageUrl}\" alt=\"${image.title || \"Site picture\"}\" />\r\n                               <div class=\"image-title\">${image.title || \"Site Image\"}</div>\r\n                             </div>`\r\n                        )\r\n                        .join(\"\")\r\n                    : '<p style=\"text-align: center; width: 100%; font-size: 11pt; color: #666; padding: 20px;\">No site pictures available</p>'\r\n                }\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"footer-container\">\r\n            <div class=\"tagline\">We work U Relax</div>\r\n            <div class=\"footer\">\r\n                <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n                <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n                <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\" style=\"color: #0074cc; text-decoration: none;\">www.alghazalgroup.com</a></p>\r\n                <p>Generated on ${formatDate(new Date())}</p>\r\n            </div>\r\n        </div>\r\n    </body>\r\n    </html>\r\n    `;\r\n\r\n    // Generate PDF\r\n    const browser = await puppeteer.launch({\r\n      headless: \"shell\",\r\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--font-render-hinting=none\"],\r\n    });\r\n\r\n    try {\r\n      const page = await browser.newPage();\r\n      \r\n      // Set viewport for consistent rendering\r\n      await page.setViewport({ width: 1200, height: 1600 });\r\n      \r\n      await page.setContent(htmlContent, {\r\n        waitUntil: [\"networkidle0\", \"domcontentloaded\"],\r\n        timeout: 30000,\r\n      });\r\n\r\n      const pdfBuffer = await page.pdf({\r\n        format: \"A4\",\r\n        printBackground: true,\r\n        margin: {\r\n          top: \"0.5in\",\r\n          right: \"0.5in\",\r\n          bottom: \"0.5in\",\r\n          left: \"0.5in\",\r\n        },\r\n        preferCSSPageSize: true,\r\n        displayHeaderFooter: false,\r\n      });\r\n\r\n      res.setHeader(\"Content-Type\", \"application/pdf\");\r\n      res.setHeader(\r\n        \"Content-Disposition\",\r\n        `attachment; filename=completion-certificate-${project.projectNumber}.pdf`\r\n      );\r\n      res.send(pdfBuffer);\r\n    } finally {\r\n      await browser.close();\r\n    }\r\n  }\r\n);\r\n\r\n///ads"]}