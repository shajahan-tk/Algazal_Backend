{"version":3,"file":"quotationController.js","sourceRoot":"","sources":["../../src/controllers/quotationController.ts"],"names":[],"mappings":";;;;;;AACA,wDAAqD;AACrD,kEAAyD;AACzD,kEAAsD;AACtD,6DAAqD;AACrD,yDAA2D;AAC3D,+DAAuD;AACvD,oDAAwG;AACxG,0DAAkC;AAClC,8DAAyE;AAGzE,uCAAiC;AAEpB,QAAA,eAAe,GAAG,IAAA,2BAAY,EACzC,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EACJ,OAAO,EAAE,SAAS,EAClB,UAAU,EACV,WAAW,GAAG,EAAE,EAChB,KAAK,GAAG,EAAE,EACV,kBAAkB,GAAG,EAAE,EACvB,aAAa,GAAG,CAAC,GAClB,GAAG,GAAG,CAAC,IAAI,CAAC;IAEb,6BAA6B;IAC7B,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC;QAC1B,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wBAAwB,CAAC,CAAC;IACpD,CAAC;IAED,+BAA+B;IAC/B,MAAM,MAAM,GAAG,MAAM,0BAAS,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,SAAS,EAAE,CAAC,CAAC;IAC/D,IAAI,MAAM;QAAE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,iCAAiC,CAAC,CAAC;IAEvE,MAAM,UAAU,GAAG,MAAM,4BAAU,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,SAAS,EAAE,CAAC,CAAC;IACpE,MAAM,YAAY,GAAG,UAAU,EAAE,GAAG,CAAC;IAErC,8CAA8C;IAC9C,MAAM,cAAc,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,IAAS,EAAE,EAAE;QAC7C,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC;QACjD,OAAO,IAAI,CAAC;IACd,CAAC,CAAC,CAAC;IAEH,6BAA6B;IAC7B,MAAM,QAAQ,GAAG,cAAc,CAAC,MAAM,CACpC,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE,CAAC,GAAG,GAAG,IAAI,CAAC,UAAU,EACpC,CAAC,CACF,CAAC;IACF,MAAM,SAAS,GAAG,QAAQ,GAAG,CAAC,aAAa,GAAG,GAAG,CAAC,CAAC;IACnD,MAAM,KAAK,GAAG,QAAQ,GAAG,SAAS,CAAC;IAEnC,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,MAAM,CAAC;QACvC,OAAO,EAAE,SAAS;QAClB,UAAU,EAAE,YAAY;QACxB,eAAe,EAAE,MAAM,IAAA,+CAA6B,EAAC,SAAS,EAAE,QAAQ,CAAC;QACzE,IAAI,EAAE,IAAI,IAAI,EAAE;QAChB,UAAU,EAAE,IAAI,IAAI,CAAC,UAAU,CAAC;QAChC,WAAW;QACX,KAAK,EAAE,cAAc;QACrB,MAAM,EAAE,EAAE,EAAE,gCAAgC;QAC5C,kBAAkB;QAClB,aAAa;QACb,QAAQ;QACR,SAAS;QACT,SAAS,EAAE,KAAK;QAChB,UAAU,EAAE,GAAG,CAAC,IAAI,EAAE,MAAM;KAC7B,CAAC,CAAC;IAEH,MAAM,sBAAO,CAAC,iBAAiB,CAAC,SAAS,EAAE,EAAE,MAAM,EAAE,gBAAgB,EAAE,CAAC,CAAC;IAEzE,MAAM,kBAAkB,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,SAAS,CAAC,GAAG,CAAC;SAC/D,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,kBAAkB,EAAE,mBAAmB,CAAC,CAAC,CAAC;AACtF,CAAC,CACF,CAAC;AAGW,QAAA,qBAAqB,GAAG,IAAA,2BAAY,EAC/C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IACnC,MAAM,IAAI,GAAG,GAAG,CAAC,IAA2B,CAAC;IAE7C,IAAI,CAAC,EAAE,IAAI,CAAC,OAAO,EAAE,CAAC;QACpB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wCAAwC,CAAC,CAAC;IACpE,CAAC;IAED,IAAI,CAAC,IAAI,EAAE,CAAC;QACV,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wBAAwB,CAAC,CAAC;IACpD,CAAC;IAED,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAC/C,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;IAED,uDAAuD;IACvD,IAAI,SAAS,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,IAAI,EAAE,MAAM,CAAC,QAAQ,EAAE,EAAE,CAAC;QACpE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,yCAAyC,CAAC,CAAC;IACrE,CAAC;IAED,MAAM,UAAU,GAAG,SAAS,CAAC,MAAM,CAAC,SAAS,CAC3C,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,OAAO,CACxC,CAAC;IAEF,IAAI,UAAU,KAAK,CAAC,CAAC,EAAE,CAAC;QACtB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;IAC7C,CAAC;IAED,MAAM,QAAQ,GAAG,SAAS,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;IAE9C,mBAAmB;IACnB,MAAM,YAAY,GAAG,MAAM,IAAA,2CAA8B,EAAC,CAAC,IAAI,CAAC,CAAC,CAAC;IAElE,IAAI,CAAC,YAAY,CAAC,OAAO,IAAI,CAAC,YAAY,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC,EAAE,CAAC;QAC3D,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,kCAAkC,CAAC,CAAC;IAC9D,CAAC;IAED,MAAM,YAAY,GAAG,YAAY,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC;IAEhD,2BAA2B;IAC3B,IAAI,QAAQ,CAAC,KAAK,EAAE,CAAC;QACnB,MAAM,IAAA,6BAAgB,EAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;IACzC,CAAC;IAED,6BAA6B;IAC7B,SAAS,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,QAAQ,GAAG,YAAY,CAAC,GAAG,CAAC;IACzD,SAAS,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,KAAK,GAAG,YAAY,CAAC,GAAG,CAAC;IACtD,SAAS,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,UAAU,GAAG,IAAI,IAAI,EAAE,CAAC;IAErD,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;IAEvB,MAAM,gBAAgB,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SAClD,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,gBAAgB,EAAE,6BAA6B,CAAC,CAAC,CAAC;AACjF,CAAC,CACF,CAAC;AAEW,QAAA,qBAAqB,GAAG,IAAA,2BAAY,EAC/C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAC1B,MAAM,KAAK,GAAG,GAAG,CAAC,KAA8B,CAAC;IACjD,MAAM,EAAE,MAAM,GAAG,EAAE,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC,sBAAsB;IAExD,IAAI,CAAC,EAAE,EAAE,CAAC;QACR,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,0BAA0B,CAAC,CAAC;IACtD,CAAC;IAED,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;QACjC,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,oBAAoB,CAAC,CAAC;IAChD,CAAC;IAED,IAAI,CAAC,GAAG,CAAC,IAAI,EAAE,MAAM,EAAE,CAAC;QACtB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,cAAc,CAAC,CAAC;IAC1C,CAAC;IAED,MAAM,WAAW,GAAa,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC;IAExE,IAAI,WAAW,CAAC,MAAM,KAAK,KAAK,CAAC,MAAM,EAAE,CAAC;QACxC,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,8CAA8C,CAAC,CAAC;IAC1E,CAAC;IAED,IAAI,WAAW,CAAC,IAAI,CAAC,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC,KAAK,EAAE,IAAI,EAAE,CAAC,EAAE,CAAC;QAChD,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wCAAwC,CAAC,CAAC;IACpE,CAAC;IAED,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAC/C,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;IAED,uDAAuD;IACvD,IAAI,SAAS,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,IAAI,CAAC,MAAM,CAAC,QAAQ,EAAE,EAAE,CAAC;QACnE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,yCAAyC,CAAC,CAAC;IACrE,CAAC;IAED,MAAM,aAAa,GAAG,MAAM,IAAA,2CAA8B,EAAC,KAAK,CAAC,CAAC;IAElE,IAAI,CAAC,aAAa,CAAC,OAAO,IAAI,CAAC,aAAa,CAAC,UAAU,EAAE,CAAC;QACxD,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,+BAA+B,CAAC,CAAC;IAC3D,CAAC;IAED,MAAM,SAAS,GAAU,aAAa,CAAC,UAAU,CAAC,GAAG,CACnD,CAAC,QAAQ,EAAE,KAAK,EAAE,EAAE;QAClB,MAAM,SAAS,GAAQ;YACrB,GAAG,EAAE,IAAI,gBAAK,CAAC,QAAQ,EAAE;YACzB,KAAK,EAAE,WAAW,CAAC,KAAK,CAAC;YACzB,QAAQ,EAAE,QAAQ,CAAC,GAAG;YACtB,KAAK,EAAE,QAAQ,CAAC,GAAG;YACnB,UAAU,EAAE,IAAI,IAAI,EAAE;SACvB,CAAC;QAEF,OAAO,SAAS,CAAC;IACnB,CAAC,CACF,CAAC;IAEF,SAAS,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,SAAS,CAAC,CAAC;IACpC,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;IAEvB,MAAM,gBAAgB,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SAClD,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,gBAAgB,EAAE,8BAA8B,CAAC,CAAC,CAAC;AAClF,CAAC,CACF,CAAC;AAEW,QAAA,oBAAoB,GAAG,IAAA,2BAAY,EAC9C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IACnC,MAAM,EAAE,KAAK,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC,CAAC,qBAAqB;IAEjD,IAAI,CAAC,EAAE,IAAI,CAAC,OAAO,EAAE,CAAC;QACpB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wCAAwC,CAAC,CAAC;IACpE,CAAC;IAED,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAC/C,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;IAED,uDAAuD;IACvD,IAAI,SAAS,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,IAAI,EAAE,MAAM,CAAC,QAAQ,EAAE,EAAE,CAAC;QACpE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,yCAAyC,CAAC,CAAC;IACrE,CAAC;IAED,MAAM,UAAU,GAAG,SAAS,CAAC,MAAM,CAAC,SAAS,CAC3C,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,OAAO,CACxC,CAAC;IAEF,IAAI,UAAU,KAAK,CAAC,CAAC,EAAE,CAAC;QACtB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;IAC7C,CAAC;IAED,mCAAmC;IACnC,IAAI,KAAK,KAAK,SAAS,EAAE,CAAC;QACxB,IAAI,CAAC,KAAK,EAAE,IAAI,EAAE,EAAE,CAAC;YACnB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,uBAAuB,CAAC,CAAC;QACnD,CAAC;QACD,SAAS,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,KAAK,GAAG,KAAK,CAAC,IAAI,EAAE,CAAC;IACpD,CAAC;IAED,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;IAEvB,MAAM,gBAAgB,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SAClD,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,gBAAgB,EAAE,4BAA4B,CAAC,CAAC,CAAC;AAChF,CAAC,CACF,CAAC;AAEW,QAAA,kBAAkB,GAAG,IAAA,2BAAY,EAC5C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAE1B,IAAI,CAAC,EAAE,EAAE,CAAC;QACR,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,0BAA0B,CAAC,CAAC;IACtD,CAAC;IAED,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC;IAEhE,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;IAED,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CACH,IAAI,+BAAW,CACb,GAAG,EACH,SAAS,CAAC,MAAM,EAChB,yCAAyC,CAC1C,CACF,CAAC;AACN,CAAC,CACF,CAAC;AAEW,QAAA,oBAAoB,GAAG,IAAA,2BAAY,EAC9C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAEnC,IAAI,CAAC,EAAE,IAAI,CAAC,OAAO,EAAE,CAAC;QACpB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wCAAwC,CAAC,CAAC;IACpE,CAAC;IAED,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAC/C,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;IAED,IAAI,SAAS,CAAC,UAAU,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,IAAI,EAAE,MAAM,CAAC,QAAQ,EAAE,EAAE,CAAC;QACpE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,yCAAyC,CAAC,CAAC;IACrE,CAAC;IAED,MAAM,UAAU,GAAG,SAAS,CAAC,MAAM,CAAC,SAAS,CAC3C,CAAC,GAAG,EAAE,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,OAAO,CACxC,CAAC;IAEF,IAAI,UAAU,KAAK,CAAC,CAAC,EAAE,CAAC;QACtB,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,iBAAiB,CAAC,CAAC;IAC7C,CAAC;IAED,MAAM,aAAa,GAAG,SAAS,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC;IACnD,MAAM,YAAY,GAAG,MAAM,IAAA,6BAAgB,EAAC,aAAa,CAAC,KAAK,CAAC,CAAC;IAEjE,IAAI,CAAC,YAAY,CAAC,OAAO,EAAE,CAAC;QAC1B,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,gCAAgC,CAAC,CAAC;IAC5D,CAAC;IAED,SAAS,CAAC,MAAM,CAAC,MAAM,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;IACvC,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;IAEvB,MAAM,gBAAgB,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SAClD,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,gBAAgB,EAAE,4BAA4B,CAAC,CAAC,CAAC;AAChF,CAAC,CACF,CAAC;AAEW,QAAA,qBAAqB,GAAG,IAAA,2BAAY,EAC/C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,SAAS,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IACjC,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,SAAS,EAAE,CAAC;SAC9D,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,IAAI,CAAC,SAAS;QAAE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IAC/D,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,SAAS,EAAE,qBAAqB,CAAC,CAAC,CAAC;AAClE,CAAC,CACF,CAAC;AAEW,QAAA,eAAe,GAAG,IAAA,2BAAY,EACzC,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAC1B,MAAM,EACJ,KAAK,GAAG,EAAE,EACV,UAAU,EACV,WAAW,EACX,kBAAkB,EAClB,aAAa,GACd,GAAG,GAAG,CAAC,IAAI,CAAC;IAEb,6BAA6B;IAC7B,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC;QAC1B,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wBAAwB,CAAC,CAAC;IACpD,CAAC;IAED,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAC/C,IAAI,CAAC,SAAS;QAAE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IAE/D,8CAA8C;IAC9C,MAAM,cAAc,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC,IAAS,EAAE,EAAE;QAC7C,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC;QACjD,OAAO,IAAI,CAAC;IACd,CAAC,CAAC,CAAC;IAEH,6BAA6B;IAC7B,MAAM,QAAQ,GAAG,cAAc,CAAC,MAAM,CACpC,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE,CAAC,GAAG,GAAG,IAAI,CAAC,UAAU,EACpC,CAAC,CACF,CAAC;IACF,MAAM,SAAS,GAAG,QAAQ,GAAG,CAAC,CAAC,aAAa,IAAI,SAAS,CAAC,aAAa,CAAC,GAAG,GAAG,CAAC,CAAC;IAChF,MAAM,KAAK,GAAG,QAAQ,GAAG,SAAS,CAAC;IAEnC,0BAA0B;IAC1B,SAAS,CAAC,KAAK,GAAG,cAAc,CAAC;IACjC,IAAI,UAAU;QAAE,SAAS,CAAC,UAAU,GAAG,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC;IAC5D,IAAI,WAAW;QAAE,SAAS,CAAC,WAAW,GAAG,WAAW,CAAC;IACrD,IAAI,kBAAkB;QAAE,SAAS,CAAC,kBAAkB,GAAG,kBAAkB,CAAC;IAC1E,IAAI,aAAa;QAAE,SAAS,CAAC,aAAa,GAAG,aAAa,CAAC;IAC3D,SAAS,CAAC,QAAQ,GAAG,QAAQ,CAAC;IAC9B,SAAS,CAAC,SAAS,GAAG,SAAS,CAAC;IAChC,SAAS,CAAC,SAAS,GAAG,KAAK,CAAC;IAE5B,MAAM,SAAS,CAAC,IAAI,EAAE,CAAC;IAEvB,MAAM,gBAAgB,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SAClD,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SAClC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,gBAAgB,EAAE,mBAAmB,CAAC,CAAC,CAAC;AACpF,CAAC,CACF,CAAC;AAEW,QAAA,gBAAgB,GAAG,IAAA,2BAAY,EAC1C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAC1B,MAAM,EAAE,UAAU,EAAE,OAAO,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;IAEzC,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,iBAAiB,CACjD,EAAE,EACF;QACE,UAAU;QACV,eAAe,EAAE,OAAO;QACxB,UAAU,EAAE,GAAG,CAAC,IAAI,EAAE,MAAM;KAC7B,EACD,EAAE,GAAG,EAAE,IAAI,EAAE,CACd,CAAC,QAAQ,CAAC,SAAS,EAAE,aAAa,CAAC;SACjC,QAAQ,CAAC,YAAY,EAAE,oBAAoB,CAAC,CAAC;IAEhD,IAAI,CAAC,SAAS,EAAE,CAAC;QACf,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IACjD,CAAC;IAED,MAAM,sBAAO,CAAC,iBAAiB,CAAC,SAAS,CAAC,OAAO,EAAE;QACjD,MAAM,EAAE,UAAU,CAAC,CAAC,CAAC,oBAAoB,CAAC,CAAC,CAAC,oBAAoB;KACjE,CAAC,CAAC;IAEH,GAAG;SACA,MAAM,CAAC,GAAG,CAAC;SACX,IAAI,CACH,IAAI,+BAAW,CACb,GAAG,EACH,SAAS,EACT,aAAa,UAAU,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,CAAC,UAAU,EAAE,CACpD,CACF,CAAC;AACN,CAAC,CACF,CAAC;AAEW,QAAA,eAAe,GAAG,IAAA,2BAAY,EACzC,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAC1B,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAE/C,IAAI,CAAC,SAAS;QAAE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IAE/D,uCAAuC;IACvC,IAAI,SAAS,CAAC,MAAM,IAAI,SAAS,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACpD,MAAM,OAAO,CAAC,GAAG,CACf,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,KAAK,EAAE,EAAE,CAC7B,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,IAAA,6BAAgB,EAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,OAAO,CAAC,OAAO,EAAE,CAChE,CACF,CAAC;IACJ,CAAC;IAED,MAAM,0BAAS,CAAC,iBAAiB,CAAC,EAAE,CAAC,CAAC;IAEtC,MAAM,sBAAO,CAAC,iBAAiB,CAAC,SAAS,CAAC,OAAO,EAAE;QACjD,MAAM,EAAE,qBAAqB;KAC9B,CAAC,CAAC;IAEH,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,IAAI,+BAAW,CAAC,GAAG,EAAE,IAAI,EAAE,mBAAmB,CAAC,CAAC,CAAC;AACxE,CAAC,CACF,CAAC;AAEW,QAAA,oBAAoB,GAAG,IAAA,2BAAY,EAC9C,KAAK,EAAE,GAAY,EAAE,GAAa,EAAE,EAAE;IACpC,MAAM,EAAE,EAAE,EAAE,GAAG,GAAG,CAAC,MAAM,CAAC;IAE1B,MAAM,SAAS,GAAG,MAAM,0BAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SAC3C,QAAQ,CAA8C;QACrD,IAAI,EAAE,SAAS;QACf,MAAM,EAAE,4EAA4E;QACpF,QAAQ,EAAE;YACR,IAAI,EAAE,QAAQ;YACd,MAAM,EAAE,6DAA6D;SACtE;KACF,CAAC;SACD,QAAQ,CACP,YAAY,EACZ,iCAAiC,CAClC,CAAC;IAEJ,IAAI,CAAC,SAAS;QAAE,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,qBAAqB,CAAC,CAAC;IAE/D,IAAI,CAAC,SAAS,CAAC,OAAO,IAAI,OAAO,SAAS,CAAC,OAAO,KAAK,QAAQ,IAAI,CAAC,CAAC,QAAQ,IAAI,SAAS,CAAC,OAAO,CAAC,EAAE,CAAC;QACpG,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,8BAA8B,CAAC,CAAC;IAC1D,CAAC;IAED,MAAM,MAAM,GAAG,SAAS,CAAC,OAAO,CAAC,MAAiB,CAAC;IACnD,MAAM,UAAU,GAAG,SAAS,CAAC,UAAmB,CAAC;IACjD,MAAM,OAAO,GAAG,SAAS,CAAC,OAAO,CAAC;IAClC,MAAM,IAAI,GAAG,GAAG,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,QAAQ,IAAI,OAAO,CAAC,eAAe,EAAE,CAAC;IAElF,mBAAmB;IACnB,MAAM,QAAQ,GAAG,SAAS,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,IAAI,EAAE,EAAE,CAAC,GAAG,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC,CAAC,CAAC;IACjF,MAAM,SAAS,GAAG,QAAQ,GAAG,CAAC,SAAS,CAAC,aAAa,GAAG,GAAG,CAAC,CAAC;IAC7D,MAAM,SAAS,GAAG,QAAQ,GAAG,SAAS,CAAC;IAEvC,MAAM,UAAU,GAAG,CAAC,IAAU,EAAE,EAAE;QAChC,OAAO,IAAI,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,CAAC,kBAAkB,CAAC,OAAO,EAAE;YACvD,GAAG,EAAE,SAAS;YACd,KAAK,EAAE,OAAO;YACd,IAAI,EAAE,SAAS;SAChB,CAAC,CAAC,CAAC,CAAC,EAAE,CAAC;IACV,CAAC,CAAC;IAEF,MAAM,gBAAgB,GAAG,CAAC,UAAgB,EAAE,EAAE;QAC5C,IAAI,CAAC,UAAU;YAAE,OAAO,KAAK,CAAC;QAC9B,MAAM,KAAK,GAAG,IAAI,IAAI,EAAE,CAAC;QACzB,MAAM,SAAS,GAAG,IAAI,IAAI,CAAC,UAAU,CAAC,CAAC;QACvC,MAAM,QAAQ,GAAG,SAAS,CAAC,OAAO,EAAE,GAAG,KAAK,CAAC,OAAO,EAAE,CAAC;QACvD,MAAM,aAAa,GAAG,IAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,CAAC,IAAI,GAAG,IAAI,GAAG,EAAE,CAAC,CAAC,CAAC;QAC/D,OAAO,aAAa,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,aAAa,OAAO,CAAC,CAAC,CAAC,SAAS,CAAC;IACjE,CAAC,CAAC;IAEF,8DAA8D;IAC9D,MAAM,gBAAgB,GAAG,CAAC,WAAmB,EAAE,EAAE;QAC/C,OAAO,WAAW,CAAC,OAAO,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC,IAAI,EAAE,CAAC;IACpD,CAAC,CAAC;IAEF,IAAI,WAAW,GAAG;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;0CAofoB,MAAM,CAAC,UAAU,IAAI,KAAK;2CACzB,MAAM,CAAC,aAAa,IAAI,KAAK;2CAC7B,MAAM,CAAC,YAAY,IAAI,MAAM,CAAC,eAAe,IAAI,KAAK;yCACxD,MAAM,CAAC,KAAK,IAAI,KAAK;wCACtB,IAAI;6CACC,OAAO,CAAC,SAAS,IAAI,KAAK;;;;;;;sBAOjD,SAAS,CAAC,eAAe;;;;sBAIzB,UAAU,CAAC,SAAS,CAAC,IAAI,CAAC;;;;sBAI1B,UAAU,CAAC,SAAS,CAAC,UAAU,CAAC,KAAK,gBAAgB,CAAC,SAAS,CAAC,UAAU,CAAC;;;;;;;;yCAQxD,OAAO,CAAC,WAAW,IAAI,KAAK;;;;;;;;;;;;;;;;;;;gBAmBrD,SAAS,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,CAAC;;mDAEF,KAAK,GAAG,CAAC;yCACnB,gBAAgB,CAAC,IAAI,CAAC,WAAW,CAAC;oDACvB,IAAI,CAAC,GAAG,IAAI,KAAK;oDACjB,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC;oDACxB,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC;qDACxB,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC,CAAC;;eAEhE,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;;;;;;;;wCAQe,QAAQ,CAAC,OAAO,CAAC,CAAC,CAAC;;;4CAGf,SAAS,CAAC,aAAa;wCAC3B,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC;;;;wCAIpB,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC;;;;;QAKpD,SAAS,CAAC,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;;;;;EAKpC,SAAS,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC;;;kBAGd,KAAK,CAAC,QAAQ,UAAU,KAAK,CAAC,KAAK;;+BAEtB,KAAK,CAAC,KAAK;;CAEzC,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;;;OAGJ,CAAC,CAAC,CAAC,EAAE;;QAEJ,SAAS,CAAC,kBAAkB,CAAC,MAAM,GAAG,CAAC,CAAC,CAAC,CAAC;;;;;;;;;;kBAUhC,SAAS,CAAC,kBAAkB,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,OAAO,IAAI,OAAO,CAAC,CAAC,IAAI,CAAC,EAAE,CAAC;;;;;4CAK3C,UAAU,EAAE,SAAS,IAAI,KAAK,IAAI,UAAU,EAAE,QAAQ,IAAI,EAAE;cAC1F,UAAU,EAAE,YAAY,EAAE,MAAM,CAAC,CAAC,CAAC;oDACG,UAAU,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC;aACzE,CAAC,CAAC,CAAC,EAAE;;;;OAIX,CAAC,CAAC,CAAC;;;;0CAIgC,UAAU,EAAE,SAAS,IAAI,KAAK,IAAI,UAAU,EAAE,QAAQ,IAAI,EAAE;YAC1F,UAAU,EAAE,YAAY,EAAE,MAAM,CAAC,CAAC,CAAC;kDACG,UAAU,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC;WACzE,CAAC,CAAC,CAAC,EAAE;;;OAGT;;;;;;;;wBAQiB,UAAU,CAAC,IAAI,IAAI,EAAE,CAAC;;;;;CAK7C,CAAC;IAEE,MAAM,OAAO,GAAG,MAAM,mBAAS,CAAC,MAAM,CAAC;QACrC,QAAQ,EAAE,OAAO;QACjB,IAAI,EAAE,CAAC,cAAc,EAAE,0BAA0B,EAAE,4BAA4B,CAAC;KACjF,CAAC,CAAC;IAEH,IAAI,CAAC;QACH,MAAM,IAAI,GAAG,MAAM,OAAO,CAAC,OAAO,EAAE,CAAC;QAErC,MAAM,IAAI,CAAC,WAAW,CAAC,EAAE,KAAK,EAAE,IAAI,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC;QAEtD,MAAM,IAAI,CAAC,UAAU,CAAC,WAAW,EAAE;YACjC,SAAS,EAAE,CAAC,MAAM,EAAE,cAAc,EAAE,kBAAkB,CAAC;YACvD,OAAO,EAAE,KAAK;SACf,CAAC,CAAC;QAEH,MAAM,SAAS,GAAG,MAAM,IAAI,CAAC,GAAG,CAAC;YAC/B,MAAM,EAAE,IAAI;YACZ,eAAe,EAAE,IAAI;YACrB,MAAM,EAAE;gBACN,GAAG,EAAE,OAAO;gBACZ,KAAK,EAAE,OAAO;gBACd,MAAM,EAAE,OAAO;gBACf,IAAI,EAAE,OAAO;aACd;YACD,mBAAmB,EAAE,KAAK;YAC1B,iBAAiB,EAAE,IAAI;SACxB,CAAC,CAAC;QAEH,GAAG,CAAC,SAAS,CAAC,cAAc,EAAE,iBAAiB,CAAC,CAAC;QACjD,GAAG,CAAC,SAAS,CACX,qBAAqB,EACrB,kCAAkC,SAAS,CAAC,eAAe,MAAM,CAClE,CAAC;QACF,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;IACtB,CAAC;IAAC,OAAO,KAAK,EAAE,CAAC;QACf,OAAO,CAAC,KAAK,CAAC,uBAAuB,EAAE,KAAK,CAAC,CAAC;QAC9C,MAAM,IAAI,4BAAQ,CAAC,GAAG,EAAE,wBAAwB,CAAC,CAAC;IACpD,CAAC;YAAS,CAAC;QACT,MAAM,OAAO,CAAC,KAAK,EAAE,CAAC;IACxB,CAAC;AACH,CAAC,CACF,CAAC","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport { Quotation } from \"../models/quotationModel\";\r\nimport { IProject, Project } from \"../models/projectModel\";\r\nimport { Estimation } from \"../models/estimationModel\";\r\nimport { uploadItemImage, deleteFileFromS3, uploadWorkCompletionImagesToS3 } from \"../utils/uploadConf\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { generateRelatedDocumentNumber } from \"../utils/documentNumbers\";\r\nimport { IUser } from \"../models/userModel\";\r\nimport { IClient } from \"../models/clientModel\";\r\nimport { Types } from \"mongoose\";\r\n\r\nexport const createQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const {\r\n      project: projectId,\r\n      validUntil,\r\n      scopeOfWork = [],\r\n      items = [],\r\n      termsAndConditions = [],\r\n      vatPercentage = 5,\r\n    } = req.body;\r\n\r\n    // Validate items is an array\r\n    if (!Array.isArray(items)) {\r\n      throw new ApiError(400, \"Items must be an array\");\r\n    }\r\n\r\n    // Check for existing quotation\r\n    const exists = await Quotation.findOne({ project: projectId });\r\n    if (exists) throw new ApiError(400, \"Project already has a quotation\");\r\n\r\n    const estimation = await Estimation.findOne({ project: projectId });\r\n    const estimationId = estimation?._id;\r\n\r\n    // Calculate item totals (no image processing)\r\n    const processedItems = items.map((item: any) => {\r\n      item.totalPrice = item.quantity * item.unitPrice;\r\n      return item;\r\n    });\r\n\r\n    // Calculate financial totals\r\n    const subtotal = processedItems.reduce(\r\n      (sum, item) => sum + item.totalPrice,\r\n      0\r\n    );\r\n    const vatAmount = subtotal * (vatPercentage / 100);\r\n    const total = subtotal + vatAmount;\r\n\r\n    const quotation = await Quotation.create({\r\n      project: projectId,\r\n      estimation: estimationId,\r\n      quotationNumber: await generateRelatedDocumentNumber(projectId, \"QTNAGA\"),\r\n      date: new Date(),\r\n      validUntil: new Date(validUntil),\r\n      scopeOfWork,\r\n      items: processedItems,\r\n      images: [], // Start with empty images array\r\n      termsAndConditions,\r\n      vatPercentage,\r\n      subtotal,\r\n      vatAmount,\r\n      netAmount: total,\r\n      preparedBy: req.user?.userId,\r\n    });\r\n\r\n    await Project.findByIdAndUpdate(projectId, { status: \"quotation_sent\" });\r\n\r\n    const populatedQuotation = await Quotation.findById(quotation._id)\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    res.status(201).json(new ApiResponse(201, populatedQuotation, \"Quotation created\"));\r\n  }\r\n);\r\n\r\n\r\nexport const replaceQuotationImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id, imageId } = req.params;\r\n    const file = req.file as Express.Multer.File;\r\n\r\n    if (!id || !imageId) {\r\n      throw new ApiError(400, \"Quotation ID and image ID are required\");\r\n    }\r\n\r\n    if (!file) {\r\n      throw new ApiError(400, \"No image file provided\");\r\n    }\r\n\r\n    const quotation = await Quotation.findById(id);\r\n    if (!quotation) {\r\n      throw new ApiError(404, \"Quotation not found\");\r\n    }\r\n\r\n    // Check if user is authorized to update this quotation\r\n    if (quotation.preparedBy.toString() !== req.user?.userId.toString()) {\r\n      throw new ApiError(403, \"Not authorized to update this quotation\");\r\n    }\r\n\r\n    const imageIndex = quotation.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    const oldImage = quotation.images[imageIndex];\r\n\r\n    // Upload new image\r\n    const uploadResult = await uploadWorkCompletionImagesToS3([file]);\r\n\r\n    if (!uploadResult.success || !uploadResult.uploadData?.[0]) {\r\n      throw new ApiError(500, \"Failed to upload new image to S3\");\r\n    }\r\n\r\n    const newImageData = uploadResult.uploadData[0];\r\n\r\n    // Delete old image from S3\r\n    if (oldImage.s3Key) {\r\n      await deleteFileFromS3(oldImage.s3Key);\r\n    }\r\n\r\n    // Update image with new file\r\n    quotation.images[imageIndex].imageUrl = newImageData.url;\r\n    quotation.images[imageIndex].s3Key = newImageData.key;\r\n    quotation.images[imageIndex].uploadedAt = new Date();\r\n\r\n    await quotation.save();\r\n\r\n    const updatedQuotation = await Quotation.findById(id)\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedQuotation, \"Image replaced successfully\"));\r\n  }\r\n);\r\n\r\nexport const uploadQuotationImages = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const files = req.files as Express.Multer.File[];\r\n    const { titles = [] } = req.body; // Remove descriptions\r\n\r\n    if (!id) {\r\n      throw new ApiError(400, \"Quotation ID is required\");\r\n    }\r\n\r\n    if (!files || files.length === 0) {\r\n      throw new ApiError(400, \"No images uploaded\");\r\n    }\r\n\r\n    if (!req.user?.userId) {\r\n      throw new ApiError(401, \"Unauthorized\");\r\n    }\r\n\r\n    const titlesArray: string[] = Array.isArray(titles) ? titles : [titles];\r\n\r\n    if (titlesArray.length !== files.length) {\r\n      throw new ApiError(400, \"Number of titles must match number of images\");\r\n    }\r\n\r\n    if (titlesArray.some((title) => !title?.trim())) {\r\n      throw new ApiError(400, \"All images must have a non-empty title\");\r\n    }\r\n\r\n    const quotation = await Quotation.findById(id);\r\n    if (!quotation) {\r\n      throw new ApiError(404, \"Quotation not found\");\r\n    }\r\n\r\n    // Check if user is authorized to update this quotation\r\n    if (quotation.preparedBy.toString() !== req.user.userId.toString()) {\r\n      throw new ApiError(403, \"Not authorized to update this quotation\");\r\n    }\r\n\r\n    const uploadResults = await uploadWorkCompletionImagesToS3(files);\r\n\r\n    if (!uploadResults.success || !uploadResults.uploadData) {\r\n      throw new ApiError(500, \"Failed to upload images to S3\");\r\n    }\r\n\r\n    const newImages: any[] = uploadResults.uploadData.map(\r\n      (fileData, index) => {\r\n        const imageData: any = {\r\n          _id: new Types.ObjectId(),\r\n          title: titlesArray[index],\r\n          imageUrl: fileData.url,\r\n          s3Key: fileData.key,\r\n          uploadedAt: new Date(),\r\n        };\r\n\r\n        return imageData;\r\n      }\r\n    );\r\n\r\n    quotation.images.push(...newImages);\r\n    await quotation.save();\r\n\r\n    const updatedQuotation = await Quotation.findById(id)\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedQuotation, \"Images uploaded successfully\"));\r\n  }\r\n);\r\n\r\nexport const updateQuotationImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id, imageId } = req.params;\r\n    const { title } = req.body; // Remove description\r\n\r\n    if (!id || !imageId) {\r\n      throw new ApiError(400, \"Quotation ID and image ID are required\");\r\n    }\r\n\r\n    const quotation = await Quotation.findById(id);\r\n    if (!quotation) {\r\n      throw new ApiError(404, \"Quotation not found\");\r\n    }\r\n\r\n    // Check if user is authorized to update this quotation\r\n    if (quotation.preparedBy.toString() !== req.user?.userId.toString()) {\r\n      throw new ApiError(403, \"Not authorized to update this quotation\");\r\n    }\r\n\r\n    const imageIndex = quotation.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    // Update image fields - only title\r\n    if (title !== undefined) {\r\n      if (!title?.trim()) {\r\n        throw new ApiError(400, \"Title cannot be empty\");\r\n      }\r\n      quotation.images[imageIndex].title = title.trim();\r\n    }\r\n\r\n    await quotation.save();\r\n\r\n    const updatedQuotation = await Quotation.findById(id)\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedQuotation, \"Image updated successfully\"));\r\n  }\r\n);\r\n\r\nexport const getQuotationImages = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    if (!id) {\r\n      throw new ApiError(400, \"Quotation ID is required\");\r\n    }\r\n\r\n    const quotation = await Quotation.findById(id).select(\"images\");\r\n\r\n    if (!quotation) {\r\n      throw new ApiError(404, \"Quotation not found\");\r\n    }\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          quotation.images,\r\n          \"Quotation images retrieved successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const deleteQuotationImage = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id, imageId } = req.params;\r\n\r\n    if (!id || !imageId) {\r\n      throw new ApiError(400, \"Quotation ID and image ID are required\");\r\n    }\r\n\r\n    const quotation = await Quotation.findById(id);\r\n    if (!quotation) {\r\n      throw new ApiError(404, \"Quotation not found\");\r\n    }\r\n\r\n    if (quotation.preparedBy.toString() !== req.user?.userId.toString()) {\r\n      throw new ApiError(403, \"Not authorized to modify this quotation\");\r\n    }\r\n\r\n    const imageIndex = quotation.images.findIndex(\r\n      (img) => img._id.toString() === imageId\r\n    );\r\n\r\n    if (imageIndex === -1) {\r\n      throw new ApiError(404, \"Image not found\");\r\n    }\r\n\r\n    const imageToDelete = quotation.images[imageIndex];\r\n    const deleteResult = await deleteFileFromS3(imageToDelete.s3Key);\r\n\r\n    if (!deleteResult.success) {\r\n      throw new ApiError(500, \"Failed to delete image from S3\");\r\n    }\r\n\r\n    quotation.images.splice(imageIndex, 1);\r\n    await quotation.save();\r\n\r\n    const updatedQuotation = await Quotation.findById(id)\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, updatedQuotation, \"Image deleted successfully\"));\r\n  }\r\n);\r\n\r\nexport const getQuotationByProject = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const quotation = await Quotation.findOne({ project: projectId })\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, quotation, \"Quotation retrieved\"));\r\n  }\r\n);\r\n\r\nexport const updateQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const {\r\n      items = [],\r\n      validUntil,\r\n      scopeOfWork,\r\n      termsAndConditions,\r\n      vatPercentage,\r\n    } = req.body;\r\n\r\n    // Validate items is an array\r\n    if (!Array.isArray(items)) {\r\n      throw new ApiError(400, \"Items must be an array\");\r\n    }\r\n\r\n    const quotation = await Quotation.findById(id);\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    // Calculate item totals (no image processing)\r\n    const processedItems = items.map((item: any) => {\r\n      item.totalPrice = item.quantity * item.unitPrice;\r\n      return item;\r\n    });\r\n\r\n    // Calculate financial totals\r\n    const subtotal = processedItems.reduce(\r\n      (sum, item) => sum + item.totalPrice,\r\n      0\r\n    );\r\n    const vatAmount = subtotal * ((vatPercentage || quotation.vatPercentage) / 100);\r\n    const total = subtotal + vatAmount;\r\n\r\n    // Update quotation fields\r\n    quotation.items = processedItems;\r\n    if (validUntil) quotation.validUntil = new Date(validUntil);\r\n    if (scopeOfWork) quotation.scopeOfWork = scopeOfWork;\r\n    if (termsAndConditions) quotation.termsAndConditions = termsAndConditions;\r\n    if (vatPercentage) quotation.vatPercentage = vatPercentage;\r\n    quotation.subtotal = subtotal;\r\n    quotation.vatAmount = vatAmount;\r\n    quotation.netAmount = total;\r\n\r\n    await quotation.save();\r\n\r\n    const updatedQuotation = await Quotation.findById(id)\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    res.status(200).json(new ApiResponse(200, updatedQuotation, \"Quotation updated\"));\r\n  }\r\n);\r\n\r\nexport const approveQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const { isApproved, comment } = req.body;\r\n\r\n    const quotation = await Quotation.findByIdAndUpdate(\r\n      id,\r\n      {\r\n        isApproved,\r\n        approvalComment: comment,\r\n        approvedBy: req.user?.userId,\r\n      },\r\n      { new: true }\r\n    ).populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    if (!quotation) {\r\n      throw new ApiError(404, \"Quotation not found\");\r\n    }\r\n\r\n    await Project.findByIdAndUpdate(quotation.project, {\r\n      status: isApproved ? \"quotation_approved\" : \"quotation_rejected\",\r\n    });\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          quotation,\r\n          `Quotation ${isApproved ? \"approved\" : \"rejected\"}`\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const deleteQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const quotation = await Quotation.findById(id);\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    // Delete all associated images from S3\r\n    if (quotation.images && quotation.images.length > 0) {\r\n      await Promise.all(\r\n        quotation.images.map((image) =>\r\n          image.s3Key ? deleteFileFromS3(image.s3Key) : Promise.resolve()\r\n        )\r\n      );\r\n    }\r\n\r\n    await Quotation.findByIdAndDelete(id);\r\n\r\n    await Project.findByIdAndUpdate(quotation.project, {\r\n      status: \"estimation_prepared\",\r\n    });\r\n\r\n    res.status(200).json(new ApiResponse(200, null, \"Quotation deleted\"));\r\n  }\r\n);\r\n\r\nexport const generateQuotationPdf = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    const quotation = await Quotation.findById(id)\r\n      .populate<{ project: IProject & { client: IClient } }>({\r\n        path: \"project\",\r\n        select: \"projectName client siteAddress location building apartmentNumber attention\",\r\n        populate: {\r\n          path: \"client\",\r\n          select: \"clientName clientAddress mobileNumber telephoneNumber email\",\r\n        },\r\n      })\r\n      .populate<{ preparedBy: IUser }>(\r\n        \"preparedBy\",\r\n        \"firstName lastName phoneNumbers\"\r\n      );\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    if (!quotation.project || typeof quotation.project !== \"object\" || !(\"client\" in quotation.project)) {\r\n      throw new ApiError(400, \"Client information not found\");\r\n    }\r\n\r\n    const client = quotation.project.client as IClient;\r\n    const preparedBy = quotation.preparedBy as IUser;\r\n    const project = quotation.project;\r\n    const site = `${project.location} ${project.building} ${project.apartmentNumber}`;\r\n\r\n    // Calculate totals\r\n    const subtotal = quotation.items.reduce((sum, item) => sum + item.totalPrice, 0);\r\n    const vatAmount = subtotal * (quotation.vatPercentage / 100);\r\n    const netAmount = subtotal + vatAmount;\r\n\r\n    const formatDate = (date: Date) => {\r\n      return date ? new Date(date).toLocaleDateString(\"en-GB\", {\r\n        day: \"2-digit\",\r\n        month: \"short\",\r\n        year: \"numeric\",\r\n      }) : \"\";\r\n    };\r\n\r\n    const getDaysRemaining = (validUntil: Date) => {\r\n      if (!validUntil) return \"N/A\";\r\n      const today = new Date();\r\n      const validDate = new Date(validUntil);\r\n      const timeDiff = validDate.getTime() - today.getTime();\r\n      const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));\r\n      return daysRemaining > 0 ? `${daysRemaining} days` : \"Expired\";\r\n    };\r\n\r\n    // Function to clean up description - remove extra blank lines\r\n    const cleanDescription = (description: string) => {\r\n      return description.replace(/\\n\\n+/g, '\\n').trim();\r\n    };\r\n\r\n    let htmlContent = `<!DOCTYPE html>\r\n<html>\r\n<head>\r\n  <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\r\n  <style type=\"text/css\">\r\n    @page {\r\n      size: A4;\r\n      margin: 0.5cm;\r\n    }\r\n    \r\n    body {\r\n      font-family: 'Arial', sans-serif;\r\n      font-size: 11pt;\r\n      line-height: 1.4;\r\n      color: #333;\r\n      margin: 0;\r\n      padding: 0;\r\n    }\r\n\r\n    .container {\r\n      display: block;\r\n      width: 100%;\r\n      max-width: 100%;\r\n    }\r\n\r\n    .content {\r\n      margin-bottom: 15px;\r\n    }\r\n\r\n    .header {\r\n      display: flex;\r\n      align-items: flex-start;\r\n      margin-bottom: 10px;\r\n      gap: 15px;\r\n      page-break-after: avoid;\r\n    }\r\n\r\n    .logo {\r\n      height: 55px;\r\n      width: auto;\r\n      max-width: 180px;\r\n    }\r\n\r\n    .header-content {\r\n      flex-grow: 1;\r\n      display: flex;\r\n      flex-direction: column;\r\n      justify-content: center;\r\n      align-items: flex-end;\r\n    }\r\n\r\n    .document-title {\r\n      font-size: 16pt;\r\n      font-weight: bold;\r\n      margin: 0;\r\n      color: #000;\r\n    }\r\n\r\n    .client-info-container {\r\n      display: flex;\r\n      margin-bottom: 8px;\r\n      gap: 15px;\r\n      page-break-after: avoid;\r\n    }\r\n\r\n    .client-info {\r\n      flex: 1;\r\n      padding: 8px 10px;\r\n      border: 1px solid #ddd;\r\n      border-radius: 4px;\r\n      font-size: 9.5pt;\r\n      background-color: #f8f9fa;\r\n    }\r\n\r\n    .client-info p {\r\n      margin: 4px 0;\r\n      line-height: 1.3;\r\n    }\r\n\r\n    .client-info strong {\r\n      font-weight: 600;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .quotation-info {\r\n      width: 220px;\r\n    }\r\n\r\n    .quotation-details {\r\n      width: 100%;\r\n      border-collapse: collapse;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    .quotation-details tr:not(:last-child) {\r\n      border-bottom: 1px solid #eee;\r\n    }\r\n\r\n    .quotation-details td {\r\n      padding: 6px 8px;\r\n      vertical-align: top;\r\n    }\r\n\r\n    .quotation-details td:first-child {\r\n      font-weight: bold;\r\n      width: 40%;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .subject-section {\r\n      margin: 8px 0;\r\n      padding: 8px 10px;\r\n      background-color: #f8f9fa;\r\n      border-radius: 4px;\r\n      page-break-after: avoid;\r\n    }\r\n\r\n    .subject-title {\r\n      font-weight: bold;\r\n      font-size: 10.5pt;\r\n      margin-bottom: 4px;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .subject-content {\r\n      font-size: 10pt;\r\n      color: #333;\r\n      font-weight: 500;\r\n    }\r\n\r\n    .section {\r\n      margin-bottom: 12px;\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    .section-title {\r\n      font-size: 11pt;\r\n      font-weight: bold;\r\n      padding: 4px 0;\r\n      margin: 8px 0 6px 0;\r\n      border-bottom: 2px solid #94d7f4;\r\n      page-break-after: avoid;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .table-container {\r\n      page-break-inside: auto;\r\n      overflow: visible;\r\n    }\r\n\r\n    table {\r\n      width: 100%;\r\n      border-collapse: collapse;\r\n      margin-bottom: 10px;\r\n      page-break-inside: auto;\r\n      font-size: 9.5pt;\r\n      table-layout: fixed;\r\n    }\r\n\r\n    thead {\r\n      display: table-header-group;\r\n    }\r\n\r\n    tbody {\r\n      display: table-row-group;\r\n    }\r\n\r\n    tr {\r\n      page-break-inside: avoid;\r\n      page-break-after: auto;\r\n    }\r\n\r\n    th, td {\r\n      page-break-inside: avoid;\r\n      page-break-before: auto;\r\n    }\r\n\r\n    th {\r\n      background-color: #94d7f4;\r\n      color: #000;\r\n      font-weight: bold;\r\n      padding: 5px 6px;\r\n      text-align: left;\r\n      border: 1px solid #ddd;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    td {\r\n      padding: 5px 6px;\r\n      border: 1px solid #ddd;\r\n      vertical-align: top;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    .col-desc {\r\n      white-space: pre-wrap;\r\n    }\r\n\r\n    .col-no { width: 5%; }\r\n    .col-desc { width: 45%; }\r\n    .col-uom { width: 10%; }\r\n    .col-qty { width: 10%; }\r\n    .col-unit { width: 15%; }\r\n    .col-total { width: 15%; }\r\n\r\n    .amount-summary {\r\n      margin-top: 8px;\r\n      width: 100%;\r\n      text-align: right;\r\n      page-break-before: avoid;\r\n      font-size: 10pt;\r\n    }\r\n\r\n    .amount-summary-row {\r\n      display: flex;\r\n      justify-content: flex-end;\r\n      margin-bottom: 4px;\r\n    }\r\n\r\n    .amount-label {\r\n      width: 120px;\r\n      font-weight: bold;\r\n      text-align: right;\r\n      padding-right: 10px;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    .amount-value {\r\n      width: 90px;\r\n      text-align: right;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    .net-amount-row {\r\n      display: flex;\r\n      justify-content: flex-end;\r\n      background-color: #94d7f4;\r\n      color: #000;\r\n      font-weight: bold;\r\n      font-size: 10pt;\r\n      margin-top: 4px;\r\n      padding: 4px 0;\r\n      border-top: 2px solid #333;\r\n    }\r\n\r\n    /* Compact Images Section */\r\n    .images-section {\r\n      margin-top: 10px;\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    .images-grid {\r\n      display: grid;\r\n      grid-template-columns: repeat(4, 1fr);\r\n      gap: 6px;\r\n      margin-top: 4px;\r\n    }\r\n\r\n    .image-item {\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: center;\r\n      page-break-inside: avoid;\r\n      border: 1px solid #e0e0e0;\r\n      border-radius: 4px;\r\n      padding: 4px;\r\n      background: #fafafa;\r\n      min-height: 0;\r\n    }\r\n\r\n    .image-container {\r\n      width: 100%;\r\n      height: 60px;\r\n      display: flex;\r\n      align-items: center;\r\n      justify-content: center;\r\n      overflow: hidden;\r\n      margin-bottom: 3px;\r\n    }\r\n\r\n    .image-container img {\r\n      max-height: 100%;\r\n      max-width: 100%;\r\n      object-fit: contain;\r\n    }\r\n\r\n    .image-title {\r\n      font-size: 7pt;\r\n      font-weight: 600;\r\n      text-align: center;\r\n      color: #2c3e50;\r\n      line-height: 1.1;\r\n      margin: 0;\r\n      word-break: break-word;\r\n      max-height: 28px;\r\n      overflow: hidden;\r\n      display: -webkit-box;\r\n      -webkit-line-clamp: 2;\r\n      -webkit-box-orient: vertical;\r\n    }\r\n\r\n    .image-description {\r\n      font-size: 6pt;\r\n      text-align: center;\r\n      color: #666;\r\n      line-height: 1.1;\r\n      margin: 1px 0 0 0;\r\n      max-height: 18px;\r\n      overflow: hidden;\r\n      display: -webkit-box;\r\n      -webkit-line-clamp: 2;\r\n      -webkit-box-orient: vertical;\r\n    }\r\n\r\n    .terms-prepared-section {\r\n      margin-top: 12px;\r\n      page-break-inside: avoid;\r\n    }\r\n\r\n    .terms-prepared-header {\r\n      display: flex;\r\n      justify-content: space-between;\r\n      align-items: center;\r\n      padding-bottom: 4px;\r\n      border-bottom: 2px solid #94d7f4;\r\n      margin-bottom: 8px;\r\n      page-break-after: avoid;\r\n    }\r\n\r\n    .terms-title, .prepared-title {\r\n      font-size: 10pt;\r\n      font-weight: bold;\r\n      margin: 0;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .terms-prepared-content {\r\n      display: flex;\r\n      gap: 15px;\r\n      align-items: flex-start;\r\n    }\r\n\r\n    .terms-content {\r\n      flex: 1;\r\n    }\r\n\r\n    .prepared-content {\r\n      width: 200px;\r\n      flex-shrink: 0;\r\n      display: flex;\r\n      flex-direction: column;\r\n      align-items: flex-end;\r\n      font-size: 9.5pt;\r\n    }\r\n\r\n    .terms-box {\r\n      border: 1px solid #000;\r\n      padding: 8px 10px;\r\n      width: 100%;\r\n      box-sizing: border-box;\r\n      font-size: 9.5pt;\r\n      line-height: 1.4;\r\n    }\r\n\r\n    .terms-box ol {\r\n      margin: 0;\r\n      padding-left: 15px;\r\n    }\r\n\r\n    .terms-box li {\r\n      margin-bottom: 4px;\r\n    }\r\n\r\n    .prepared-by-name {\r\n      font-weight: bold;\r\n      margin-top: 4px;\r\n      font-size: 10pt;\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .prepared-by-title {\r\n      font-size: 9pt;\r\n      color: #555;\r\n      margin-top: 2px;\r\n    }\r\n\r\n    .tagline {\r\n      text-align: center;\r\n      font-weight: bold;\r\n      font-size: 11pt;\r\n      margin: 15px 0 8px 0;\r\n      color: #2c3e50;\r\n      border-top: 2px solid #ddd;\r\n      padding-top: 8px;\r\n      page-break-before: avoid;\r\n    }\r\n\r\n    .footer {\r\n      font-size: 8.5pt;\r\n      color: #555;\r\n      text-align: center;\r\n      margin-top: 8px;\r\n      page-break-inside: avoid;\r\n      line-height: 1.3;\r\n    }\r\n\r\n    .footer p {\r\n      margin: 4px 0;\r\n    }\r\n\r\n    .footer strong {\r\n      color: #2c3e50;\r\n    }\r\n\r\n    .text-center {\r\n      text-align: center;\r\n    }\r\n\r\n    .text-right {\r\n      text-align: right;\r\n    }\r\n\r\n    p {\r\n      margin: 4px 0;\r\n      line-height: 1.3;\r\n    }\r\n\r\n    strong {\r\n      font-weight: 600;\r\n    }\r\n\r\n    @media print {\r\n      thead { \r\n        display: table-header-group; \r\n      }\r\n      tfoot { \r\n        display: table-footer-group; \r\n      }\r\n      \r\n      table {\r\n        page-break-inside: auto;\r\n      }\r\n      \r\n      tr {\r\n        break-inside: avoid;\r\n        break-after: auto;\r\n      }\r\n\r\n      .subject-section {\r\n        page-break-after: avoid;\r\n        page-break-inside: avoid;\r\n      }\r\n\r\n      .items-section {\r\n        page-break-before: auto;\r\n      }\r\n\r\n      body {\r\n        font-size: 10pt;\r\n        margin: 0;\r\n        padding: 0;\r\n      }\r\n\r\n      .container {\r\n        margin: 0;\r\n        padding: 0;\r\n      }\r\n\r\n      .image-item {\r\n        page-break-inside: avoid;\r\n      }\r\n\r\n      .images-grid {\r\n        break-inside: avoid;\r\n      }\r\n    }\r\n\r\n    .page-break {\r\n      page-break-before: always;\r\n    }\r\n\r\n    .header-section {\r\n      page-break-after: avoid;\r\n      page-break-inside: avoid;\r\n    }\r\n  </style>\r\n</head>\r\n<body>\r\n  <div class=\"container\">\r\n    <div class=\"content\">\r\n      <div class=\"header-section\">\r\n        <div class=\"header\">\r\n          <img class=\"logo\" src=\"https://krishnadas-test-1.s3.ap-south-1.amazonaws.com/sample-spmc/logo+(1).png\" alt=\"Company Logo\">\r\n          <div class=\"header-content\">\r\n            <div class=\"document-title\">QUOTE</div>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"client-info-container\">\r\n          <div class=\"client-info\">\r\n            <p><strong>CLIENT:</strong> ${client.clientName || \"N/A\"}</p>\r\n            <p><strong>ADDRESS:</strong> ${client.clientAddress || \"N/A\"}</p>\r\n            <p><strong>CONTACT:</strong> ${client.mobileNumber || client.telephoneNumber || \"N/A\"}</p>\r\n            <p><strong>EMAIL:</strong> ${client.email || \"N/A\"}</p>\r\n            <p><strong>SITE:</strong> ${site}</p>\r\n            <p><strong>ATTENTION:</strong> ${project.attention || \"N/A\"}</p>\r\n          </div>\r\n\r\n          <div class=\"quotation-info\">\r\n            <table class=\"quotation-details\">\r\n              <tr>\r\n                <td>Quotation #:</td>\r\n                <td>${quotation.quotationNumber}</td>\r\n              </tr>\r\n              <tr>\r\n                <td>Date:</td>\r\n                <td>${formatDate(quotation.date)}</td>\r\n              </tr>\r\n              <tr>\r\n                <td>Valid Until:</td>\r\n                <td>${formatDate(quotation.validUntil)} (${getDaysRemaining(quotation.validUntil)})</td>\r\n              </tr>\r\n            </table>\r\n          </div>\r\n        </div>\r\n\r\n        <div class=\"subject-section\">\r\n          <div class=\"subject-title\">SUBJECT</div>\r\n          <div class=\"subject-content\">${project.projectName || \"N/A\"}</div>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"section items-section\">\r\n        <div class=\"section-title\">ITEMS</div>\r\n        <div class=\"table-container\">\r\n          <table>\r\n            <thead>\r\n              <tr>\r\n                <th class=\"col-no\">No.</th>\r\n                <th class=\"col-desc\">Description</th>\r\n                <th class=\"col-uom\">UOM</th>\r\n                <th class=\"col-qty\">Qty</th>\r\n                <th class=\"col-unit\">Unit Price (AED)</th>\r\n                <th class=\"col-total text-right\">Total (AED)</th>\r\n              </tr>\r\n            </thead>\r\n            <tbody>\r\n              ${quotation.items.map((item, index) => `\r\n                <tr>\r\n                  <td class=\"text-center col-no\">${index + 1}</td>\r\n                  <td class=\"col-desc\">${cleanDescription(item.description)}</td>\r\n                  <td class=\"text-center col-uom\">${item.uom || \"NOS\"}</td>\r\n                  <td class=\"text-center col-qty\">${item.quantity.toFixed(2)}</td>\r\n                  <td class=\"text-right col-unit\">${item.unitPrice.toFixed(2)}</td>\r\n                  <td class=\"text-right col-total\">${item.totalPrice.toFixed(2)}</td>\r\n                </tr>\r\n              `).join(\"\")}\r\n            </tbody>\r\n          </table>\r\n        </div>\r\n\r\n        <div class=\"amount-summary\">\r\n          <div class=\"amount-summary-row\">\r\n            <div class=\"amount-label\">SUBTOTAL:</div>\r\n            <div class=\"amount-value\">${subtotal.toFixed(2)} AED</div>\r\n          </div>\r\n          <div class=\"amount-summary-row\">\r\n            <div class=\"amount-label\">VAT ${quotation.vatPercentage}%:</div>\r\n            <div class=\"amount-value\">${vatAmount.toFixed(2)} AED</div>\r\n          </div>\r\n          <div class=\"net-amount-row\">\r\n            <div class=\"amount-label\">NET AMOUNT:</div>\r\n            <div class=\"amount-value\">${netAmount.toFixed(2)} AED</div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      ${quotation.images.length > 0 ? `\r\n      <div class=\"section images-section\">\r\n        <div class=\"section-title\">QUOTATION IMAGES</div>\r\n        <div class=\"images-grid\">\r\n          // In generateQuotationPdf function, remove description from images section\r\n${quotation.images.map(image => `\r\n  <div class=\"image-item\">\r\n    <div class=\"image-container\">\r\n      <img src=\"${image.imageUrl}\" alt=\"${image.title}\" />\r\n    </div>\r\n    <div class=\"image-title\">${image.title}</div>\r\n  </div>\r\n`).join('')}\r\n        </div>\r\n      </div>\r\n      ` : ''}\r\n\r\n      ${quotation.termsAndConditions.length > 0 ? `\r\n      <div class=\"terms-prepared-section\">\r\n        <div class=\"terms-prepared-header\">\r\n          <div class=\"terms-title\">TERMS & CONDITIONS</div>\r\n          <div class=\"prepared-title\">PREPARED BY</div>\r\n        </div>\r\n        <div class=\"terms-prepared-content\">\r\n          <div class=\"terms-content\">\r\n            <div class=\"terms-box\">\r\n              <ol>\r\n                ${quotation.termsAndConditions.map(term => `<li>${term}</li>`).join(\"\")}\r\n              </ol>\r\n            </div>\r\n          </div>\r\n          <div class=\"prepared-content\">\r\n            <div class=\"prepared-by-name\">${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}</div>\r\n            ${preparedBy?.phoneNumbers?.length ? `\r\n            <div class=\"prepared-by-title\">Phone: ${preparedBy.phoneNumbers.join(\", \")}</div>\r\n            ` : ''}\r\n          </div>\r\n        </div>\r\n      </div>\r\n      ` : `\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">PREPARED BY</div>\r\n        <div class=\"prepared-content\">\r\n          <div class=\"prepared-by-name\">${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}</div>\r\n          ${preparedBy?.phoneNumbers?.length ? `\r\n          <div class=\"prepared-by-title\">Phone: ${preparedBy.phoneNumbers.join(\", \")}</div>\r\n          ` : ''}\r\n        </div>\r\n      </div>\r\n      `}\r\n    </div>\r\n\r\n    <div class=\"tagline\">We work U Relax</div>\r\n    <div class=\"footer\">\r\n      <p><strong>AL GHAZAL AL ABYAD TECHNICAL SERVICES</strong></p>\r\n      <p>Office No:04, R09-France Cluster, International City-Dubai | P.O.Box:262760, Dubai-U.A.E</p>\r\n      <p>Tel: 044102555 | <a href=\"http://www.alghazalgroup.com/\">www.alghazalgroup.com</a></p>\r\n      <p>Generated on ${formatDate(new Date())}</p>\r\n    </div>\r\n  </div>\r\n</body>\r\n</html>\r\n`;\r\n\r\n    const browser = await puppeteer.launch({\r\n      headless: \"shell\",\r\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\", \"--font-render-hinting=none\"],\r\n    });\r\n\r\n    try {\r\n      const page = await browser.newPage();\r\n\r\n      await page.setViewport({ width: 1200, height: 1600 });\r\n\r\n      await page.setContent(htmlContent, {\r\n        waitUntil: [\"load\", \"networkidle0\", \"domcontentloaded\"],\r\n        timeout: 30000,\r\n      });\r\n\r\n      const pdfBuffer = await page.pdf({\r\n        format: \"A4\",\r\n        printBackground: true,\r\n        margin: {\r\n          top: \"0.5cm\",\r\n          right: \"0.5cm\",\r\n          bottom: \"0.5cm\",\r\n          left: \"0.5cm\",\r\n        },\r\n        displayHeaderFooter: false,\r\n        preferCSSPageSize: true,\r\n      });\r\n\r\n      res.setHeader(\"Content-Type\", \"application/pdf\");\r\n      res.setHeader(\r\n        \"Content-Disposition\",\r\n        `attachment; filename=quotation-${quotation.quotationNumber}.pdf`\r\n      );\r\n      res.send(pdfBuffer);\r\n    } catch (error) {\r\n      console.error(\"PDF generation error:\", error);\r\n      throw new ApiError(500, \"Failed to generate PDF\");\r\n    } finally {\r\n      await browser.close();\r\n    }\r\n  }\r\n);"]}